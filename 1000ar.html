<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>UTå°è»Š AR é»æª¢ç³»çµ±</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; }
    
    /* è®“æ”å½±æ©Ÿç•«é¢æ»¿ç‰ˆ */
    #reader { width: 100vw; height: 100vh; }
    #reader video { object-fit: cover !important; }

    /* AR æµ®å‹•å¡ç‰‡æ¨£å¼ */
    #ar-overlay {
      position: absolute;
      top: 0; left: 0;
      pointer-events: none; /* è®“é»æ“Šç©¿é€ï¼Œä¸å½±éŸ¿æƒæ */
      width: 100%; height: 100%;
    }

    .ar-card {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      border-left: 6px solid #007bff;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      width: 200px;
      transition: all 0.1s ease-out; /* è®“ç§»å‹•å¹³æ»‘ä¸€é» */
      z-index: 1000;
      display: none; /* é è¨­éš±è— */
    }

    .ar-card::after { /* å°è©±æ¡†ç®­é ­ */
      content: ""; position: absolute; left: -10px; top: 20px;
      border-top: 10px solid transparent; border-bottom: 10px solid transparent;
      border-right: 10px solid rgba(255, 255, 255, 0.95);
    }

    .ar-status { font-weight: bold; font-size: 16px; margin-bottom: 4px; }
    .status-ok { color: #16a34a; }
    .status-ng { color: #dc2626; }
    .ar-info { font-size: 12px; color: #666; }

    /* UI æ§åˆ¶å±¤ */
    #ui-layer {
      position: fixed; top: 20px; width: 100%; text-align: center;
      z-index: 1001; pointer-events: none;
    }
    .hint { background: rgba(0,0,0,0.5); color: white; padding: 5px 15px; border-radius: 20px; }
    #loadingOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); color: white; display: flex; align-items: center; justify-content: center; z-index: 2000; }
  </style>
</head>
<body>

<div id="loadingOverlay">ğŸ“¡ è¼‰å…¥è³‡æ–™åº«ä¸­...</div>

<div id="ui-layer">
    <span class="hint">è«‹å°‡é¡é ­å°æº–å°è»Š QR Code</span>
</div>

<div id="reader"></div>

<div id="ar-overlay">
    <div id="infoCard" class="ar-card">
        <div id="ar-carId" style="font-size: 14px; color: #888;">#è¼‰å…¥ä¸­</div>
        <div id="ar-status" class="ar-status">ç‹€æ…‹åˆ¤æ–·ä¸­...</div>
        <div id="ar-date" class="ar-info">æœ€å¾Œé»æª¢ï¼š-</div>
    </div>
</div>

<script>
  const CONFIG = {
    CHECK_MONTHS: [1, 7],
    GAS_URL: "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec"
  };

  let allRecords = [];
  const infoCard = document.getElementById('infoCard');
  
  // åˆå§‹åŒ–æƒæå™¨ (ä¸ä½¿ç”¨åœæ­¢æ¨¡å¼ï¼Œæ”¹ç”¨é€£çºŒåµæ¸¬)
  const html5QrCode = new Html5Qrcode("reader");

  // åˆ¤æ–·ç‹€æ…‹ (èˆ‡æ‚¨åŸæœ¬é‚è¼¯ä¸€è‡´)
  function checkStatus(carId) {
    const record = allRecords.filter(r => r.carId === carId).sort((a,b)=>new Date(b.time)-new Date(a.time))[0];
    if (!record) return { isOk: false, date: "ç„¡ç´€éŒ„", msg: "æŸ¥ç„¡è³‡æ–™" };

    const date = new Date(record.time);
    const now = new Date();
    const sortedMonths = CONFIG.CHECK_MONTHS.sort((a,b) => a-b);
    let targetMonth = sortedMonths.reverse().find(m => (now.getMonth() + 1) >= m) || sortedMonths[0];
    
    const isOk = (date.getFullYear() === now.getFullYear() && (date.getMonth() + 1) === targetMonth);
    return { isOk, date: record.time, msg: isOk ? "âœ… æœ¬æœŸåˆæ ¼" : "âŒ æœªé»æª¢" };
  }

  const qrCodeSuccessCallback = (decodedText, decodedResult) => {
    // 1. å–å¾— QR Code åœ¨ç•«é¢ä¸Šçš„ä½ç½®
    // html5-qrcode æä¾›å››è§’åº§æ¨™ï¼Œæˆ‘å€‘å–å…¶ç¯„åœä¸­å¿ƒ
    const box = decodedResult.alignmentPoints;
    if (box && box.length > 0) {
        const x = box[0].x;
        const y = box[0].y;

        // 2. æ›´æ–° AR å¡ç‰‡å…§å®¹
        const statusData = checkStatus(decodedText);
        document.getElementById('ar-carId').innerText = "ğŸšš " + decodedText;
        document.getElementById('ar-status').innerText = statusData.msg;
        document.getElementById('ar-status').className = `ar-status ${statusData.isOk ? 'status-ok' : 'status-ng'}`;
        document.getElementById('ar-date').innerText = "æœ€å¾Œé»æª¢ï¼š" + statusData.date;

        // 3. ç§»å‹•å¡ç‰‡ä½ç½® (ç¨å¾®å¾€å³åé¿é–‹ QR Code æœ¬èº«)
        infoCard.style.display = 'block';
        infoCard.style.transform = `translate(${x + 20}px, ${y - 50}px)`;
        
        // 4. è‡ªå‹•éš±è—æ©Ÿåˆ¶ (3ç§’æ²’æƒåˆ°å°±æ¶ˆå¤±)
        clearTimeout(window.hideTimer);
        window.hideTimer = setTimeout(() => { infoCard.style.display = 'none'; }, 2000);
    }
  };

  async function startAR() {
    try {
      const res = await fetch(`${CONFIG.GAS_URL}?mode=list`);
      const data = await res.json();
      allRecords = data.records;
      document.getElementById('loadingOverlay').style.display = 'none';

      await html5QrCode.start(
        { facingMode: "environment" }, 
        { fps: 10, qrbox: (w, h) => { return { width: w * 0.8, height: h * 0.8 } } },
        qrCodeSuccessCallback
      );
    } catch (err) {
      alert("å•Ÿå‹•å¤±æ•—: " + err);
    }
  }

  startAR();
</script>
</body>
</html>
