<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>UT台車 AR 點檢系統</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      background-color: #000; /* AR 模式背景通常為黑 */
      margin: 0;
      padding: 0;
      overflow: hidden; /* 防止捲動 */
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* === AR 視窗容器 === */
    #ar-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* 相機畫面 */
    #reader {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
    }
    /* 隱藏 html5-qrcode 預設的醜醜邊框和按鈕 */
    #reader video { object-fit: cover; height: 100%; }

    /* === AR 資訊疊加層 (HUD) === */
    #ar-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none; /* 讓點擊穿透到下面，除非點到按鈕 */
      z-index: 10;
      display: flex;
      flex-direction: column;
      justify-content: flex-end; /* 資訊顯示在下方 */
      padding: 20px;
      background: rgba(0,0,0,0.0); /* 完全透明 */
      transition: background 0.3s;
    }

    /* 當顯示結果時，背景稍微變暗一點點以利閱讀 */
    #ar-overlay.active {
      background: rgba(0,0,0,0.3);
      pointer-events: auto; /* 啟用點擊 */
    }

    /* === 掃描框 (裝飾用) === */
    .scan-frame {
      position: absolute;
      top: 50%; left: 50%;
      width: 250px; height: 250px;
      transform: translate(-50%, -50%);
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 12px;
      box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); /* 讓框外變暗 */
      z-index: 5;
      pointer-events: none;
    }
    /* 掃描線動畫 */
    .scan-line {
      width: 100%; height: 2px;
      background: #00ff00;
      position: absolute;
      top: 0;
      animation: scanMove 2s infinite linear;
      box-shadow: 0 0 4px #00ff00;
    }
    @keyframes scanMove { 0% {top:0;} 50% {top:100%;} 100% {top:0;} }

    /* 當顯示結果時，隱藏掃描框 */
    .hidden { display: none !important; }

    /* === 資訊卡片 (AR 風格 - 毛玻璃) === */
    .ar-card {
      background: rgba(255, 255, 255, 0.85); /* 半透明白 */
      backdrop-filter: blur(10px); /* 毛玻璃特效 */
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.4);
      margin-bottom: 20px;
      transform: translateY(120%); /* 預設藏在下面 */
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      max-height: 70vh;
      overflow-y: auto;
    }

    .ar-card.show {
      transform: translateY(0);
    }

    .status-header { text-align: center; margin-bottom: 10px; }
    .car-id-title { font-size: 1.2em; font-weight: 900; color: #333; margin-bottom: 5px; }

    /* 按鈕樣式 */
    .ar-btn {
      width: 100%;
      padding: 14px;
      background: #222;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      margin-top: 15px;
      cursor: pointer;
    }
    .ar-btn:active { transform: scale(0.98); }

    /* 載入畫面 */
    #loadingOverlay {
      position: absolute; top:0; left:0; width:100%; height:100%;
      background: #111; color: white;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 999;
      text-align: center;
    }
    .spinner {
      width: 40px; height: 40px; border: 4px solid #333;
      border-top: 4px solid #007bff; border-radius: 50%;
      animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);} }

    /* 繼承您原有的 Badge 樣式 */
    .badge-wrap { display: flex; justify-content: center; margin: 10px 0; }
    .badge {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 20px; border-radius: 50px;
      font-weight: 700; font-size: 14px;
    }
    .badge svg { width: 18px; height: 18px; }
    .badge-green { color: #064e3b; background: #d1fae5; border: 1px solid #10b981; }
    .badge-red { color: #7f1d1d; background: #fee2e2; border: 1px solid #ef4444; }
    
    .detail-row {
        display: flex; justify-content: space-between;
        padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.1);
        font-size: 14px;
    }
    .detail-label { color: #666; }
    .detail-val { font-weight: 600; color: #000; }
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div>UT 台車點檢資料庫連線中...</div>
  <div style="font-size:12px; color:#888; margin-top:5px;">(首次載入約需 3-5 秒)</div>
</div>

<div id="ar-container">
  <div id="reader"></div>
  
  <div id="scanFrame" class="scan-frame">
    <div class="scan-line"></div>
  </div>

  <div id="ar-overlay">
    <div id="resultCard" class="ar-card">
      <div class="status-header">
        <div id="arCarId" class="car-id-title"></div>
        <div id="arBadgeArea"></div>
        <div id="arMsg" style="font-size:13px; color:#666;"></div>
      </div>
      
      <div id="arDetails"></div>

      <button class="ar-btn" id="closeArBtn">確認 / 掃描下一台</button>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // ⚙️ 設定檔 (保持不變)
  // ==========================================
  const CONFIG = {
    CHECK_MONTHS: [1, 7], 
    GAS_URL: "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec"
  };

  let allRecords = [];
  let isProcessing = false; // 控制是否暫停掃描 (AR 模式核心)
  const qrScanner = new Html5Qrcode("reader");

  // === 工具函式 (保持您的邏輯不變) ===
  function toDate(val){
    if (val == null) return null;
    if (Object.prototype.toString.call(val) === '[object Date]' && !isNaN(val)) return val;
    const s = String(val).trim().slice(0,19).replace(/\//g,'-').replace(' ', 'T');
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  function checkPeriodicStatus(recordDateVal) {
    const recordDate = toDate(recordDateVal);
    if (!recordDate) return { isOk: false, msg: "無有效日期", targetStr:"-", recordStr:"-" };

    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    const sortedMonths = CONFIG.CHECK_MONTHS.sort((a,b) => a-b);
    
    let targetMonth = null;
    for (let i = sortedMonths.length - 1; i >= 0; i--) {
        if (currentMonth >= sortedMonths[i]) {
            targetMonth = sortedMonths[i];
            break;
        }
    }
    if (targetMonth === null) targetMonth = sortedMonths[0]; 

    const targetYear = currentYear;
    const rYear = recordDate.getFullYear();
    const rMonth = recordDate.getMonth() + 1;
    const isMatch = (rYear === targetYear && rMonth === targetMonth);

    return {
        isOk: isMatch,
        targetStr: `${targetYear}年${targetMonth}月`,
        recordStr: `${rYear}年${rMonth}月`
    };
  }

  // === AR 核心邏輯 ===

  async function startScanner() {
    try {
      // 優先使用後置鏡頭
      await qrScanner.start(
        { facingMode: "environment" }, 
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText, decodedResult) => {
          // 掃描成功的回呼
          if (isProcessing) return; // 如果正在顯示結果，忽略新的掃描
          
          isProcessing = true; // 鎖定狀態
          handleScanSuccess(decodedText);
        },
        (errorMessage) => {
          // 掃描中...不做事
        }
      );
    } catch (err) {
      alert("無法啟動相機，請確認權限或使用 HTTPS");
    }
  }

  function handleScanSuccess(carId) {
    // 1. 震動回饋 (如果裝置支援)
    if (navigator.vibrate) navigator.vibrate(200);

    // 2. UI 變化：隱藏準心，顯示遮罩
    document.getElementById("scanFrame").classList.add("hidden");
    document.getElementById("ar-overlay").classList.add("active");

    // 3. 撈取資料並渲染
    renderARCard(carId);

    // 4. 顯示卡片動畫
    document.getElementById("resultCard").classList.add("show");
  }

  function renderARCard(carId) {
    const matches = allRecords.filter(r => r.carId === carId).sort((a,b)=>new Date(b.time)-new Date(a.time));
    const result = matches[0];

    const carIdEl = document.getElementById("arCarId");
    const badgeEl = document.getElementById("arBadgeArea");
    const msgEl = document.getElementById("arMsg");
    const detailsEl = document.getElementById("arDetails");

    carIdEl.innerText = `編號：${carId}`;
    detailsEl.innerHTML = ""; // 清空舊資料

    if (!result) {
      badgeEl.innerHTML = `<div class="badge badge-red">❌ 查無資料</div>`;
      msgEl.innerText = "系統中找不到此編號的近期紀錄";
    } else {
      const status = checkPeriodicStatus(result.time);
      
      // 徽章
      if (status.isOk) {
        badgeEl.innerHTML = `
          <div class="badge badge-green">
            <svg viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5a1 1 0 10-1.4 1.4l4.2 4.2a1 1 0 001.4 0l9-9a1 1 0 10-1.4-1.4L9 16.2z" fill="currentColor"/></svg>
            本期合格 (${status.targetStr})
          </div>`;
      } else {
        badgeEl.innerHTML = `
          <div class="badge badge-red">
            <svg viewBox="0 0 24 24"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2"/></svg>
            本期未點檢
          </div>`;
      }

      // 提示訊息
      let detailMsg = `最近紀錄：${result.time.split('T')[0]}`;
      if (!status.isOk) {
         detailMsg += ` (應為 ${status.targetStr})`;
         msgEl.style.color = "#d32f2f";
      } else {
         msgEl.style.color = "#2e7d32";
      }
      msgEl.innerText = detailMsg;

      // 生成詳細欄位 (排除 carId 和 time)
      const fields = Object.entries(result).filter(([k])=>!['carId','time'].includes(k));
      fields.forEach(([k, v]) => {
        detailsEl.innerHTML += `
          <div class="detail-row">
            <span class="detail-label">${k}</span>
            <span class="detail-val">${v || "-"}</span>
          </div>
        `;
      });
    }
  }

  // === 關閉 AR 卡片並重置 ===
  document.getElementById("closeArBtn").addEventListener("click", () => {
    // 1. 收起卡片
    document.getElementById("resultCard").classList.remove("show");
    document.getElementById("ar-overlay").classList.remove("active");
    
    // 2. 顯示準心
    document.getElementById("scanFrame").classList.remove("hidden");

    // 3. 延遲一點點再解鎖，避免按按鈕時手指還擋在鏡頭前誤觸
    setTimeout(() => {
      isProcessing = false; 
    }, 500);
  });

  // === 資料預載 (保持原有邏輯) ===
  async function preload() {
    // 這裡為了簡化，直接使用今天往回推 18 個月
    const now = new Date();
    const until = now.toISOString().split('T')[0];
    const past = new Date();
    past.setMonth(past.getMonth() - 18);
    const from = past.toISOString().split('T')[0];

    try {
      const res = await fetch(`${CONFIG.GAS_URL}?mode=list&from=${from}&until=${until}`);
      const data = await res.json();
      allRecords = data.records || [];
      
      // 資料載入完成，隱藏 Loading，啟動相機
      document.getElementById("loadingOverlay").style.display = "none";
      await startScanner();
      
    } catch(e) {
      document.querySelector("#loadingOverlay").innerHTML = `<div style="color:red">⚠️ 資料載入失敗<br>${e.message}</div>`;
    }
  }

  // 啟動
  preload();

</script>
</body>
</html>
