<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>UTå°è»Š çœŸARæ—‹è½‰ç‰ˆ</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      margin: 0; padding: 0;
      background-color: #000;
      font-family: sans-serif;
      overflow: hidden;
      height: 100vh; width: 100vw;
    }

    #ar-scene {
      position: relative;
      width: 100%; height: 100%;
      background: #000;
      perspective: 1000px; /* é–‹å•Ÿ 3D é€è¦–æ„Ÿ */
    }

    #reader { width: 100%; height: 100%; }
    #reader video { object-fit: cover; width: 100%; height: 100%; }

    /* === æœƒæ—‹è½‰çš„ AR æ¨™ç±¤ === */
    #ar-tag-container {
      position: absolute;
      top: 0; left: 0;
      width: 0; height: 0;
      /* ä½¿ç”¨ transform é€²è¡Œ GPU åŠ é€Ÿ */
      transform-style: preserve-3d;
      pointer-events: none;
      z-index: 10;
      will-change: transform; /* å‘Šè¨´ç€è¦½å™¨é€™æ±è¥¿æœƒä¸€ç›´å‹•ï¼Œè«‹æº–å‚™å¥½ GPU */
    }

    /* å¯¦éš›å…§å®¹å¡ç‰‡ */
    .ar-card {
      /* å¡ç‰‡ä¸­å¿ƒå°æº–åº§æ¨™é» */
      position: absolute;
      top: 0; left: 0; 
      width: 200px; 
      /* è®“å¡ç‰‡ä¸­å¿ƒé»ä½æ–¼ (0,0) */
      transform: translate(-50%, -50%); 
      
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid #00ff00;
      color: #00ff00;
      padding: 10px;
      font-size: 14px;
      font-weight: bold;
      
      /* åŠ ä¸Šä¸€é»ç«‹é«”é™°å½± */
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
      
      opacity: 0;
      transition: opacity 0.2s;
    }

    /* é€£æ¥ç·š (è®“å®ƒçœ‹èµ·ä¾†æ˜¯å¾ä¸­å¿ƒé•·å‡ºä¾†çš„) */
    .crosshair {
      position: absolute;
      top: -50px; left: 0;
      width: 2px; height: 50px;
      background: #00ff00;
      transform: translateX(-50%);
    }

    .tag-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom:1px solid #333; }
    .status-ng { color: #ff3333; }

    #debug-info {
      position: absolute; bottom: 10px; left: 10px; color: yellow; font-size: 10px; z-index:99;
      background: rgba(0,0,0,0.5); padding: 4px;
    }
    #cameraSelect { display: none; }
  </style>
</head>
<body>

<div id="ar-scene">
  <div id="reader"></div>
  <div id="debug-info">åˆå§‹åŒ–ä¸­...</div>

  <div id="ar-tag-container">
    <div class="ar-card" id="arCard">
      <div class="crosshair"></div> <div id="tagContent">æƒæä¸­...</div>
    </div>
  </div>
</div>

<select id="cameraSelect"></select>

<script>
  // ==========================================
  // âš™ï¸ è¨­å®šæª”
  // ==========================================
  const CONFIG = {
    GAS_URL: "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec",
    // å¹³æ»‘ä¿‚æ•¸ (0.1 = å¾ˆæ…¢å¾ˆæ»‘, 0.9 = å¾ˆå¿«å¾ˆæŠ–)
    LERP_FACTOR: 0.2 
  };

  let allRecords = [];
  let qrScanner = null;
  let currentCameraId = null;
  let hideTimer = null;

  // === å¹³æ»‘é‹å‹•è®Šæ•¸ (é€™å°±æ˜¯ä¸æŠ–å‹•çš„ç§˜å¯†) ===
  let targetX = 0, targetY = 0, targetAngle = 0, targetScale = 1;
  let currX = 0, currY = 0, currAngle = 0, currScale = 1;
  let isTracking = false;
  let animationFrameId = null;

  // è¼”åŠ©é‹ç®—ï¼šç·šæ€§æ’å€¼ (Linear Interpolation)
  const lerp = (start, end, factor) => start + (end - start) * factor;

  // ==========================================
  // ğŸ“ æ ¸å¿ƒæ•¸å­¸ï¼šè¨ˆç®—ä½ç½®ã€è§’åº¦ã€ç¸®æ”¾
  // ==========================================
  function calculatePose(decodedResult) {
    const loc = decodedResult.result.location;
    if (!loc) return null;

    // å–å¾—é—œéµé»
    const pTL = loc.topLeftCorner;     // å·¦ä¸Š
    const pTR = loc.topRightCorner;    // å³ä¸Š
    const pBL = loc.bottomLeftCorner;  // å·¦ä¸‹
    const pBR = loc.bottomRightCorner; // å³ä¸‹

    // 1. è¨ˆç®—ä¸­å¿ƒé» (Center)
    // ç°¡å–®å¹³å‡å››å€‹é»çš„åº§æ¨™
    const centerX = (pTL.x + pTR.x + pBR.x + pBL.x) / 4;
    const centerY = (pTL.y + pTR.y + pBR.y + pBL.y) / 4;

    // 2. è¨ˆç®—æ—‹è½‰è§’åº¦ (Rotation)
    // ä½¿ç”¨ Math.atan2 è¨ˆç®— å·¦ä¸Š(TL) åˆ° å³ä¸Š(TR) çš„æ–œç‡è§’åº¦
    const deltaY = pTR.y - pTL.y;
    const deltaX = pTR.x - pTL.x;
    const angleRad = Math.atan2(deltaY, deltaX);
    const angleDeg = angleRad * (180 / Math.PI);

    // 3. è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹ (Scale)
    // ç®—å‡º QR Code çš„å¯¬åº¦ (åƒç´ )ï¼Œç”¨ä¾†æ±ºå®šå¡ç‰‡è¦å¤šå¤§
    // å‡è¨­æ¨™æº– QR Code åœ¨ç•«é¢ä¸Šå¯¬åº¦ 150px æ™‚ scale = 1
    const widthPx = Math.sqrt(deltaX*deltaX + deltaY*deltaY);
    const baseScale = widthPx / 120; // èª¿æ•´é€™å€‹é™¤æ•¸ä¾†æ”¹è®Šå¡ç‰‡é è¨­å¤§å°

    return { x: centerX, y: centerY, angle: angleDeg, scale: baseScale };
  }

  // ==========================================
  // ğŸš€ æ¸²æŸ“è¿´åœˆ (Render Loop)
  // ==========================================
  function updateVisuals() {
    if (!isTracking) {
        document.getElementById("arCard").style.opacity = 0;
        animationFrameId = requestAnimationFrame(updateVisuals);
        return;
    }

    // 1. å¹³æ»‘ç§»å‹• (Lerp)
    // è®“ç›®å‰çš„æ•¸å€¼æ…¢æ…¢è¿½ä¸Šç›®æ¨™æ•¸å€¼
    currX = lerp(currX, targetX, CONFIG.LERP_FACTOR);
    currY = lerp(currY, targetY, CONFIG.LERP_FACTOR);
    currAngle = lerp(currAngle, targetAngle, CONFIG.LERP_FACTOR);
    currScale = lerp(currScale, targetScale, CONFIG.LERP_FACTOR);

    // 2. è½‰æ›åº§æ¨™ç³» (å½±ç‰‡åº§æ¨™ -> è¢å¹•åº§æ¨™)
    const videoEl = document.querySelector("#reader video");
    if (videoEl) {
        const vW = videoEl.videoWidth;
        const vH = videoEl.videoHeight;
        const dW = videoEl.offsetWidth;
        const dH = videoEl.offsetHeight;

        // Cover æ¨¡å¼çš„ç¸®æ”¾æ¯”
        const scale = Math.max(dW / vW, dH / vH);
        const overflowX = (vW * scale - dW) / 2;
        const overflowY = (vH * scale - dH) / 2;

        const screenX = (currX * scale) - overflowX;
        const screenY = (currY * scale) - overflowY;

        // 3. å¥—ç”¨ CSS è®Šå½¢
        const container = document.getElementById("ar-tag-container");
        const card = document.getElementById("arCard");

        // ç§»å‹•å®¹å™¨åˆ°ä¸­å¿ƒé»
        container.style.transform = `translate3d(${screenX}px, ${screenY}px, 0)`;
        
        // æ—‹è½‰ä¸¦ç¸®æ”¾å¡ç‰‡
        // é€™è£¡åŠ ä¸Š rotateX(0deg) æ˜¯ç‚ºäº†ä¿æŒå¹³é¢ï¼Œå¦‚æœä½ æƒ³è®“å®ƒç¨å¾®èººå¹³ï¼Œå¯ä»¥æ”¹ rotateX(20deg)
        card.style.transform = `translate(-50%, -50%) rotate(${currAngle}deg) scale(${currScale})`;
        card.style.opacity = 1;
    }

    animationFrameId = requestAnimationFrame(updateVisuals);
  }

  // ==========================================
  // ğŸ“· æƒæäº‹ä»¶è™•ç†
  // ==========================================
  function handleScan(decodedText, decodedResult) {
    const pose = calculatePose(decodedResult);
    if (pose) {
        // æ›´æ–°ç›®æ¨™æ•¸å€¼
        targetX = pose.x;
        targetY = pose.y;
        targetAngle = pose.angle;
        targetScale = pose.scale;
        
        isTracking = true;

        // æ›´æ–°å…§å®¹ (ç°¡å–®å¿«å–æ©Ÿåˆ¶)
        const card = document.getElementById("tagContent");
        if (card.dataset.lastId !== decodedText) {
            card.dataset.lastId = decodedText;
            updateContent(decodedText);
            if(navigator.vibrate) navigator.vibrate(50);
        }

        // è‡ªå‹•éš±è—è¨ˆæ™‚å™¨
        clearTimeout(hideTimer);
        hideTimer = setTimeout(() => {
            isTracking = false;
        }, 500); // 0.5ç§’æ²’æƒåˆ°å°±æ¶ˆå¤±
    }
  }

  // ==========================================
  // ğŸ“Š è³‡æ–™å…§å®¹æ¸²æŸ“
  // ==========================================
  function updateContent(id) {
    const matches = allRecords.filter(r => r.carId === id).sort((a,b)=>new Date(b.time)-new Date(a.time));
    const rec = matches[0];
    const el = document.getElementById("tagContent");
    
    if (!rec) {
        el.innerHTML = `<div style="color:red; text-align:center;">âŒ ç„¡æ­¤ç·¨è™Ÿ<br>${id}</div>`;
        return;
    }

    // æª¢æŸ¥é‚è¼¯
    const now = new Date();
    const m = now.getMonth() + 1;
    const targetM = (m >= 7) ? 7 : 1; // å‡è¨­åªæœ‰1, 7æœˆ
    const recDate = new Date(rec.time.replace(/-/g, '/'));
    const isOk = (recDate.getFullYear() === now.getFullYear() && (recDate.getMonth()+1) === targetM);

    const statusHtml = isOk 
        ? `<span style="color:#00ff00">âœ… åˆæ ¼</span>` 
        : `<span class="status-ng">âš ï¸ æœªæª¢</span>`;

    el.innerHTML = `
        <div class="tag-row"><span>ç·¨è™Ÿ</span><span>${id}</span></div>
        <div class="tag-row"><span>ç‹€æ…‹</span>${statusHtml}</div>
        <div class="tag-row"><span>æ‡‰æª¢</span><span>${now.getFullYear()}/${targetM}</span></div>
        <div style="font-size:10px; color:#aaa; margin-top:4px;">${rec.workerId || 'æœªçŸ¥äººå“¡'}</div>
    `;
  }

  // ==========================================
  // ğŸš€ å•Ÿå‹•ç›¸æ©Ÿ (ä¿æŒä½ç•«è³ªå„ªåŒ–)
  // ==========================================
  async function init() {
    // é è¼‰è³‡æ–™
    document.getElementById("debug-info").innerText = "è¼‰å…¥è³‡æ–™åº«...";
    const today = new Date().toISOString().split('T')[0];
    const past = new Date(); past.setMonth(past.getMonth()-18);
    try {
        const res = await fetch(`${CONFIG.GAS_URL}?mode=list&from=${past.toISOString().split('T')[0]}&until=${today}`);
        const data = await res.json();
        allRecords = data.records || [];
    } catch(e) { console.log(e); }

    // å•Ÿå‹•ç›¸æ©Ÿ
    document.getElementById("debug-info").innerText = "å•Ÿå‹•ç›¸æ©Ÿ...";
    qrScanner = new Html5Qrcode("reader");
    const devices = await Html5Qrcode.getCameras();
    
    if (devices && devices.length) {
      currentCameraId = devices[devices.length-1].id;
      
      const config = {
        fps: 15, // è¿½è¹¤éœ€è¦ç¨é«˜ FPS
        qrbox: { width: 200, height: 200 },
        aspectRatio: window.innerHeight / window.innerWidth,
        videoConstraints: {
          width: { ideal: 320 }, // å …æŒä½ç•«è³ªä»¥æ±‚æ•ˆèƒ½
          height: { ideal: 240 },
          facingMode: "environment"
        }
      };

      // å•Ÿå‹•æ¸²æŸ“è¿´åœˆ
      requestAnimationFrame(updateVisuals);

      await qrScanner.start(currentCameraId, config, handleScan, ()=>{});
      document.getElementById("debug-info").style.display = 'none';
    }
  }

  init();

</script>
</body>
</html>
