<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>UTå°è»Š AR é»æª¢ç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      background-color: #000;
      overflow: hidden; /* é˜²æ­¢æ»¾å‹•ï¼Œå…¨è¢å¹•é«”é©— */
    }

    /* éš±è—çš„åŸç”Ÿ Videoï¼Œç”¨æ–¼æ“·å–å½±åƒä¸²æµ */
    #videoElement {
      display: none; 
    }

    /* ä¸»ç•«å¸ƒï¼šé¡¯ç¤ºæ”å½±æ©Ÿç•«é¢ + AR ç–ŠåŠ å±¤ */
    #arCanvas {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      display: block;
    }

    /* è®€å–ä¸­çš„é®ç½© */
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85); color: white;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 999; text-align: center;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* åº•éƒ¨è³‡è¨Šåˆ— (HUD) */
    #hud {
      position: fixed; bottom: 20px; left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 20px; border-radius: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      font-weight: bold; color: #333;
      white-space: nowrap;
      z-index: 100;
      pointer-events: none; /* è®“é»æ“Šç©¿é€ */
    }
    .hud-icon { margin-right: 5px; }

  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div id="loadingText">æ­£åœ¨ä¸‹è¼‰å°è»Šè³‡æ–™åº«...</div>
  </div>

  <video id="videoElement" playsinline muted></video>
  <canvas id="arCanvas"></canvas>

  <div id="hud">ğŸ“· è«‹å°‡é¡é ­å°æº–å°è»Š QR Code</div>

<script>
  // ==========================================
  // âš™ï¸ è¨­å®šæª”
  // ==========================================
  const CONFIG = {
    CHECK_MONTHS: [1, 7], 
    GAS_URL: "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec"
  };

  let allRecords = [];
  const video = document.getElementById("videoElement");
  const canvas = document.getElementById("arCanvas");
  const ctx = canvas.getContext("2d");
  const hud = document.getElementById("hud");
  const loadingText = document.getElementById("loadingText");
  const overlay = document.getElementById("loadingOverlay");

  // ==========================================
  // ğŸ“… æ—¥æœŸèˆ‡é‚è¼¯è™•ç† (æ²¿ç”¨æ‚¨çš„æ ¸å¿ƒé‚è¼¯)
  // ==========================================
  function todayYMD(){
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  
  function minus18Months(ymd){
    const [y,m,d] = ymd.split('-').map(n=>parseInt(n,10));
    const dt = new Date(y, m-1, d);
    dt.setMonth(dt.getMonth() - 18);
    const yy = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${yy}-${mm}-${dd}`;
  }

  function toDate(val){
    if (!val) return null;
    if (Object.prototype.toString.call(val) === '[object Date]' && !isNaN(val)) return val;
    const s = String(val).trim().slice(0,19).replace(/\//g,'-').replace(' ', 'T');
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  function checkPeriodicStatus(recordDateVal) {
    const recordDate = toDate(recordDateVal);
    if (!recordDate) return { isOk: false, msg: "ç„¡æ•¸æ“š", color: "#999" };

    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;

    const sortedMonths = CONFIG.CHECK_MONTHS.sort((a,b) => a-b);
    let targetMonth = null;
    for (let i = sortedMonths.length - 1; i >= 0; i--) {
        if (currentMonth >= sortedMonths[i]) {
            targetMonth = sortedMonths[i];
            break;
        }
    }
    if (targetMonth === null) targetMonth = sortedMonths[0]; 

    const targetYear = currentYear;
    const rYear = recordDate.getFullYear();
    const rMonth = recordDate.getMonth() + 1;
    const isMatch = (rYear === targetYear && rMonth === targetMonth);

    return {
        isOk: isMatch,
        targetStr: `${targetMonth}æœˆ`,
        recordStr: `${rMonth}æœˆ`,
        lastDate: `${rYear}/${rMonth}/${recordDate.getDate()}`
    };
  }

  // å¾è³‡æ–™åº«æ‰¾è»Š
  function getCarData(carId) {
    // æ‰¾å‡ºæ‰€æœ‰ç¬¦åˆ carId çš„ç´€éŒ„ï¼Œå–æœ€æ–°çš„ä¸€ç­†
    const matches = allRecords.filter(r => r.carId === carId).sort((a,b)=>new Date(b.time)-new Date(a.time));
    if (matches.length === 0) return null;
    return matches[0];
  }

  // ==========================================
  // ğŸ¥ æ”å½±æ©Ÿèˆ‡ AR ç¹ªåœ–æ ¸å¿ƒ
  // ==========================================
  
  function startCamera() {
    // ä½¿ç”¨ facingMode: "environment" å¼·åˆ¶å¾Œé¡é ­
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(function(stream) {
        video.srcObject = stream;
        video.setAttribute("playsinline", true); // iOS å¿…é ˆ
        video.play();
        requestAnimationFrame(tick);
      })
      .catch(err => {
        alert("ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿï¼š" + err.message);
      });
  }

  function drawLine(begin, end, color) {
    ctx.beginPath();
    ctx.moveTo(begin.x, begin.y);
    ctx.lineTo(end.x, end.y);
    ctx.lineWidth = 4;
    ctx.strokeStyle = color;
    ctx.stroke();
  }

  function drawRoundedRect(x, y, width, height, radius, color) {
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height - radius);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    ctx.lineTo(x + radius, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
    ctx.fill();
  }

  function tick() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      // 1. è¨­å®š Canvas å¤§å°èˆ‡å½±ç‰‡ä¸€è‡´
      canvas.height = video.videoHeight;
      canvas.width = video.videoWidth;
      
      // 2. ç¹ªè£½ç•¶å‰æ”å½±æ©Ÿç•«é¢åˆ° Canvas (é€™å°±æ˜¯èƒŒæ™¯)
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // 3. ä½¿ç”¨ jsQR åˆ†æç•«é¢ä¸­çš„åƒç´ 
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, {
        inversionAttempts: "dontInvert",
      });

      // 4. å¦‚æœç™¼ç¾ QR Code
      if (code && code.data) {
        const carId = code.data.trim();
        const record = getCarData(carId);

        let color = "#FF3B30"; // é è¨­ç´…è‰² (Fail/æœªçŸ¥)
        let titleText = "æœªçŸ¥å°è»Š";
        let subText = "æŸ¥ç„¡æ­¤ç·¨è™Ÿè³‡æ–™";
        let statusIcon = "âŒ";

        if (record) {
            const status = checkPeriodicStatus(record.time);
            if (status.isOk) {
                color = "#34C759"; // ç¶ è‰² (Pass)
                titleText = `${carId} (åˆæ ¼)`;
                subText = `å·²æª¢: ${status.lastDate}`;
                statusIcon = "âœ…";
            } else {
                color = "#FF3B30"; // ç´…è‰² (Fail)
                titleText = `${carId} (æœªæª¢)`;
                subText = `éœ€æª¢: ${status.targetStr} (ç›®å‰:${status.recordStr})`;
                statusIcon = "âš ï¸";
            }
        } else {
            // è³‡æ–™åº«æ²’é€™å°è»Š
            titleText = `${carId}`;
        }

        // --- AR ç¹ªåœ–å€ ---

        // A. ç•«å‡º QR Code çš„é‚Šæ¡†
        drawLine(code.location.topLeftCorner, code.location.topRightCorner, color);
        drawLine(code.location.topRightCorner, code.location.bottomRightCorner, color);
        drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, color);
        drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, color);

        // B. è¨ˆç®—æ¨™ç±¤é¡¯ç¤ºä½ç½® (åœ¨ QR Code ä¸Šæ–¹)
        // å– top-left å’Œ top-right çš„ä¸­é–“é»
        const centerX = (code.location.topLeftCorner.x + code.location.topRightCorner.x) / 2;
        const topY = Math.min(code.location.topLeftCorner.y, code.location.topRightCorner.y);
        
        // C. ç¹ªè£½æµ®å‹•è³‡è¨Šå¡ (HUD Tag)
        const boxWidth = 220;
        const boxHeight = 70;
        const boxX = centerX - (boxWidth / 2);
        const boxY = topY - boxHeight - 20; // å¾€ä¸Šæµ®å‹• 20px

        // é™°å½±
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 10;
        
        // å¡ç‰‡èƒŒæ™¯
        drawRoundedRect(boxX, boxY, boxWidth, boxHeight, 10, "rgba(255, 255, 255, 0.95)");
        
        // é‚Šæ¢ (å·¦å´é¡è‰²æ¢æŒ‡ç¤ºç‹€æ…‹)
        drawRoundedRect(boxX, boxY, 10, boxHeight, 0, color); // ä¿®æ­£åœ“è§’æœƒæ¯”è¼ƒè¤‡é›œï¼Œé€™è£¡ç°¡åŒ–ç•«ä¸€å€‹æ¢
        
        // æ¸…é™¤é™°å½±è¨­å®šï¼Œé¿å…æ–‡å­—ç³Šæ‰
        ctx.shadowColor = "transparent";
        ctx.shadowBlur = 0;

        // æ–‡å­—è¨­å®š
        ctx.font = "bold 24px 'Microsoft JhengHei'";
        ctx.fillStyle = "#333";
        ctx.fillText(titleText, boxX + 25, boxY + 30);

        ctx.font = "16px 'Microsoft JhengHei'";
        ctx.fillStyle = "#666";
        ctx.fillText(subText, boxX + 25, boxY + 55);

        // æ›´æ–°åº•éƒ¨ HUD è®“ä½¿ç”¨è€…çŸ¥é“æƒåˆ°äº†
        hud.innerText = `${statusIcon} åµæ¸¬åˆ°ï¼š${carId}`;
        hud.style.color = color === "#34C759" ? "#006400" : "#8B0000";

      } else {
        // æ²’æƒåˆ°æ™‚ï¼Œé‡ç½®åº•éƒ¨ HUD
        hud.innerText = "ğŸ“· æœå°‹å°è»Š QR Code...";
        hud.style.color = "#333";
      }
    }
    requestAnimationFrame(tick);
  }

  // ==========================================
  // ğŸ“¥ è³‡æ–™é è¼‰
  // ==========================================
  async function preload() {
    const until = todayYMD();
    const from = minus18Months(until); 
    
    // è¼”åŠ©å‡½å¼ï¼šç¯©é¸æ—¥æœŸå€é–“
    const filterRange = (arr) => {
        const f = new Date(from).getTime();
        const u = new Date(until).setHours(23,59,59);
        return (arr||[]).filter(r=>{
            const t = toDate(r.time);
            return t && t.getTime() >= f && t.getTime() <= u;
        });
    }

    try {
      loadingText.innerText = "æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...";
      const res = await fetch(`${CONFIG.GAS_URL}?mode=list&from=${from}&until=${until}`);
      const data = await res.json();
      allRecords = filterRange(data.records);
      
      // è³‡æ–™è¼‰å…¥å®Œæˆï¼Œé—œé–‰é®ç½©ï¼Œå•Ÿå‹• AR
      overlay.style.display = "none";
      startCamera();

    } catch(e) {
      loadingText.innerText = "è®€å–å¤±æ•—ï¼Œå˜—è©¦è¼‰å…¥å…¨éƒ¨...";
      try {
          const res2 = await fetch(`${CONFIG.GAS_URL}?mode=list`);
          const data2 = await res2.json();
          allRecords = filterRange(data2.records);
          overlay.style.display = "none";
          startCamera();
      } catch(e2) { 
        loadingText.innerHTML = "<span style='color:red'>âŒ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</span>"; 
      }
    }
  }

  // å•Ÿå‹•
  preload();

</script>
</body>
</html>
