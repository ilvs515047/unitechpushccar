<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>UTå°è»Š AR é»æª¢ (ä½å»¶é²ç‰ˆ)</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    /* === åŸºç¤è¨­å®š === */
    body {
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      background-color: #000;
      margin: 0; padding: 0;
      overflow: hidden; /* ç¦æ­¢æ²å‹• */
      height: 100vh;
      display: flex; flex-direction: column;
    }

    /* === ç›¸æ©Ÿå®¹å™¨ === */
    #ar-container {
      position: relative;
      width: 100%; height: 100%;
      overflow: hidden;
      background: #000;
    }

    /* ç›¸æ©Ÿç•«é¢å¼·åˆ¶æ»¿ç‰ˆ */
    #reader {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
    }
    #reader video { object-fit: cover; height: 100%; }

    /* éš±è—åŸç”Ÿä¸‹æ‹‰é¸å–® (æˆ‘å€‘ç”¨è‡ªå‹•/ç¨‹å¼æ§åˆ¶) */
    #cameraSelect { display: none; }

    /* === AR ä»‹é¢å±¤ (HUD) === */
    #ar-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none; /* è®“é»æ“Šç©¿é€ */
      z-index: 10;
      display: flex; flex-direction: column; justify-content: flex-end;
      padding: 16px;
      background: rgba(0,0,0,0);
      transition: background 0.3s;
    }
    #ar-overlay.active {
      background: rgba(0,0,0,0.4); /* èƒŒæ™¯è®Šæš—ä»¥çªé¡¯å¡ç‰‡ */
      pointer-events: auto; /* å•Ÿç”¨é»æ“Š */
    }

    /* === æƒææ¡†èˆ‡é›·å°„å‹•ç•« === */
    .scan-frame {
      position: absolute;
      top: 50%; left: 50%;
      width: 240px; height: 240px;
      transform: translate(-50%, -50%);
      border: 2px solid rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      box-shadow: 0 0 0 2000px rgba(0,0,0,0.4); /* è®“å‘¨åœè®Šæš— */
      z-index: 5;
    }
    .scan-line {
      width: 100%; height: 2px;
      background: #0f0;
      box-shadow: 0 0 4px #0f0;
      position: absolute; top: 0;
      animation: scanMove 2s infinite linear;
    }
    @keyframes scanMove { 0% {top:0;} 50% {top:100%;} 100% {top:0;} }
    .hidden { display: none !important; }

    /* === çµæœå¡ç‰‡ (æ¯›ç»ç’ƒç‰¹æ•ˆ) === */
    .ar-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
      transform: translateY(120%); /* é è¨­è—åœ¨ä¸‹æ–¹ */
      transition: transform 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      max-height: 75vh;
      overflow-y: auto;
    }
    .ar-card.show { transform: translateY(0); }

    .status-header { text-align: center; margin-bottom: 12px; }
    .car-id-title { font-size: 20px; font-weight: 800; color: #333; margin: 4px 0; }
    
    /* å¾½ç« æ¨£å¼ */
    .badge-wrap { display: flex; justify-content: center; margin: 8px 0; }
    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 20px; border-radius: 50px;
      font-weight: 700; font-size: 15px;
    }
    .badge-green { color: #065f46; background: #d1fae5; border: 1px solid #10b981; }
    .badge-red { color: #7f1d1d; background: #fee2e2; border: 1px solid #ef4444; }

    /* è©³ç´°è³‡æ–™åˆ—è¡¨ */
    .detail-row {
      display: flex; justify-content: space-between;
      padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.1);
      font-size: 14px;
    }
    .detail-label { color: #666; }
    .detail-val { font-weight: 600; color: #111; text-align: right; }

    /* æŒ‰éˆ• */
    .ar-btn {
      width: 100%; padding: 14px;
      background: #2563eb; color: #fff;
      border: none; border-radius: 12px;
      font-size: 16px; font-weight: bold;
      margin-top: 16px; cursor: pointer;
    }
    .ar-btn:active { transform: scale(0.98); background: #1d4ed8; }

    /* è¼‰å…¥ç•«é¢ */
    #loadingOverlay {
      position: absolute; inset: 0; background: #111; color: #fff;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 999; text-align: center;
    }
    .spinner {
      width: 40px; height: 40px; border: 4px solid #333;
      border-top: 4px solid #3b82f6; border-radius: 50%;
      animation: spin 1s linear infinite; margin-bottom: 16px;
    }
    @keyframes spin { 0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);} }
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div style="font-size:18px;">æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...</div>
  <div style="font-size:13px; color:#aaa; margin-top:8px;">ä½¿ç”¨ä½å»¶é²æ¨¡å¼è¼‰å…¥è³‡æ–™åº«</div>
</div>

<select id="cameraSelect"></select>

<div id="ar-container">
  <div id="reader"></div>
  
  <div id="scanFrame" class="scan-frame">
    <div class="scan-line"></div>
    <div style="position:absolute; bottom:-30px; width:100%; text-align:center; color:#fff; font-weight:bold; text-shadow:0 1px 2px #000;">
      è«‹å°æº– QR Code
    </div>
  </div>

  <div id="ar-overlay">
    <div id="resultCard" class="ar-card">
      <div class="status-header">
        <div id="arCarId" class="car-id-title"></div>
        <div id="arBadgeArea"></div>
        <div id="arMsg" style="font-size:13px; color:#666;"></div>
      </div>
      <div id="arDetails"></div>
      <button class="ar-btn" id="closeArBtn">ç¢ºèª / æƒæä¸‹ä¸€å°</button>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // âš™ï¸ è¨­å®šæª”èˆ‡è³‡æ–™é‚è¼¯ (ä¿æŒä¸è®Š)
  // ==========================================
  const CONFIG = {
    CHECK_MONTHS: [1, 7], 
    GAS_URL: "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec"
  };

  let allRecords = [];
  let qrScanner = null;
  let currentCameraId = null;
  let isProcessing = false; // ARæ¨¡å¼é–ï¼šæ˜¯å¦æ­£åœ¨é¡¯ç¤ºå¡ç‰‡

  // æ—¥æœŸå·¥å…·èˆ‡æª¢æŸ¥é‚è¼¯
  function toDate(val){
    if (val == null) return null;
    if (Object.prototype.toString.call(val) === '[object Date]' && !isNaN(val)) return val;
    const s = String(val).trim().slice(0,19).replace(/\//g,'-').replace(' ', 'T');
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  function checkPeriodicStatus(recordDateVal) {
    const recordDate = toDate(recordDateVal);
    if (!recordDate) return { isOk: false, msg: "ç„¡æ—¥æœŸ", targetStr:"-", recordStr:"-" };
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    const sortedMonths = CONFIG.CHECK_MONTHS.sort((a,b) => a-b);
    let targetMonth = sortedMonths[0];
    for (let i = sortedMonths.length - 1; i >= 0; i--) {
        if (currentMonth >= sortedMonths[i]) { targetMonth = sortedMonths[i]; break; }
    }
    return {
        isOk: (recordDate.getFullYear() === currentYear && (recordDate.getMonth()+1) === targetMonth),
        targetStr: `${currentYear}å¹´${targetMonth}æœˆ`,
        recordStr: `${recordDate.getFullYear()}å¹´${recordDate.getMonth()+1}æœˆ`
    };
  }

  // ==========================================
  // ğŸ“· æ”å½±æ©Ÿæ ¸å¿ƒé‚è¼¯ (ä½¿ç”¨ä½ æä¾›çš„å„ªåŒ–ç‰ˆ)
  // ==========================================
  
  async function initCameraOptions() {
    try {
      // ç¢ºä¿ Reader å­˜åœ¨
      if(!document.getElementById("reader")) return;

      qrScanner = new Html5Qrcode("reader");
      const devices = await Html5Qrcode.getCameras();
      const camSelectEl = document.getElementById("cameraSelect");
      camSelectEl.innerHTML = "";

      if (devices && devices.length) {
        devices.forEach((device, index) => {
          const option = document.createElement("option");
          option.value = device.id;
          option.text = device.label || `Camera ${index + 1}`;
          camSelectEl.appendChild(option);
        });
        
        // é è¨­é¸æœ€å¾Œä¸€å€‹ (é€šå¸¸æ˜¯å¾Œé¡é ­)
        currentCameraId = devices[devices.length-1].id;
        camSelectEl.value = currentCameraId;

        await startScan();
      } else {
        alert("æ‰¾ä¸åˆ°æ”å½±æ©Ÿè¨­å‚™ï¼");
      }
    } catch (err) {
      console.error("åˆå§‹åŒ–å¤±æ•—:", err);
      alert("ç„¡æ³•å­˜å–æ”å½±æ©Ÿ: " + err);
    }
  }

  async function startScan() {
    if (!currentCameraId || !qrScanner) return;

    // é—œéµè¨­å®šï¼šé€™è£¡ä½¿ç”¨äº†ä½ æä¾›çš„ä½è§£æåº¦åƒæ•¸
    const config = {
      fps: 5,               // é™ä½ FPS æ¸›è¼•è² æ“”
      aspectRatio: 1.333,   // 4:3 æ¯”ä¾‹
      qrbox: { width: 220, height: 220 },
      videoConstraints: {
        width:  { ideal: 640 }, // é™ä½è§£æåº¦ (é—œéµ!)
        height: { ideal: 480 },
        facingMode: "environment" // å¼·åˆ¶å¾Œé¡é ­
      }
    };

    await qrScanner.start(
      currentCameraId,
      config,
      (decodedText) => {
        // === æƒææˆåŠŸå¾Œçš„ AR é‚è¼¯ ===
        if (isProcessing) return; // å¦‚æœæ­£åœ¨çœ‹å¡ç‰‡ï¼Œä¸è¦é‡è¤‡è§¸ç™¼
        
        isProcessing = true; // ä¸Šé–
        handleScanSuccess(decodedText.trim());
      },
      (errorMessage) => {
        // æƒä¸åˆ°æ™‚å¿½ç•¥
      }
    );
  }

  // ==========================================
  // ğŸ‘“ AR ä»‹é¢äº’å‹•é‚è¼¯
  // ==========================================

  function handleScanSuccess(carId) {
    // 1. éœ‡å‹•å›é¥‹
    if (navigator.vibrate) navigator.vibrate(200);

    // 2. ä»‹é¢è®ŠåŒ–ï¼šéš±è—æº–å¿ƒï¼Œé¡¯ç¤ºçµæœ
    document.getElementById("scanFrame").classList.add("hidden");
    document.getElementById("ar-overlay").classList.add("active");
    
    // 3. æ¸²æŸ“è³‡æ–™
    renderARCard(carId);

    // 4. å¡ç‰‡æ»‘å…¥
    document.getElementById("resultCard").classList.add("show");
  }

  function renderARCard(carId) {
    const matches = allRecords.filter(r => r.carId === carId).sort((a,b)=>new Date(b.time)-new Date(a.time));
    const result = matches[0];
    const carIdEl = document.getElementById("arCarId");
    const badgeEl = document.getElementById("arBadgeArea");
    const msgEl = document.getElementById("arMsg");
    const detailsEl = document.getElementById("arDetails");

    carIdEl.innerText = `ç·¨è™Ÿï¼š${carId}`;
    detailsEl.innerHTML = "";

    if (!result) {
      badgeEl.innerHTML = `<div class="badge badge-red">âŒ ç„¡è³‡æ–™</div>`;
      msgEl.innerText = "è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°æ­¤ç·¨è™Ÿ";
    } else {
      const status = checkPeriodicStatus(result.time);
      
      if (status.isOk) {
        badgeEl.innerHTML = `<div class="badge badge-green">âœ… æœ¬æœŸåˆæ ¼</div>`;
        msgEl.innerHTML = `æ‡‰æª¢: ${status.targetStr} <br> å¯¦æª¢: ${status.recordStr}`;
        msgEl.style.color = "#065f46";
      } else {
        badgeEl.innerHTML = `<div class="badge badge-red">âš ï¸ æœ¬æœŸæœªæª¢</div>`;
        msgEl.innerHTML = `æ‡‰æª¢: ${status.targetStr} <br> ä¸Šæ¬¡: ${status.recordStr}`;
        msgEl.style.color = "#b91c1c";
      }

      // ç”Ÿæˆæ¬„ä½ (æ’é™¤ä¸å¿…è¦çš„)
      const fields = Object.entries(result).filter(([k])=>!['carId','time','workerId'].includes(k));
      fields.forEach(([k, v]) => {
        detailsEl.innerHTML += `
          <div class="detail-row">
            <span class="detail-label">${k}</span>
            <span class="detail-val">${v || "-"}</span>
          </div>`;
      });
      // è£œä¸Šé»æª¢äºº
      if(result.workerId) {
         detailsEl.innerHTML += `<div class="detail-row"><span class="detail-label">é»æª¢äºº</span><span class="detail-val">${result.workerId}</span></div>`;
      }
    }
  }

  // é—œé–‰å¡ç‰‡æŒ‰éˆ•
  document.getElementById("closeArBtn").addEventListener("click", () => {
    // æ”¶èµ·å¡ç‰‡
    document.getElementById("resultCard").classList.remove("show");
    document.getElementById("ar-overlay").classList.remove("active");
    
    // é¡¯ç¤ºæº–å¿ƒ
    document.getElementById("scanFrame").classList.remove("hidden");

    // å»¶é²è§£é–ï¼Œé¿å…èª¤è§¸
    setTimeout(() => { isProcessing = false; }, 800);
  });

  // ==========================================
  // ğŸš€ å•Ÿå‹•æµç¨‹
  // ==========================================
  async function preload() {
    const loading = document.getElementById("loadingOverlay");
    const now = new Date();
    const until = now.toISOString().split('T')[0];
    const past = new Date(); past.setMonth(past.getMonth() - 18);
    const from = past.toISOString().split('T')[0];

    try {
      const res = await fetch(`${CONFIG.GAS_URL}?mode=list&from=${from}&until=${until}`);
      const data = await res.json();
      allRecords = data.records || [];
      
      loading.style.display = "none";
      await initCameraOptions(); // è¼‰å…¥å®Œè³‡æ–™æ‰é–‹ç›¸æ©Ÿ
      
    } catch(e) {
      loading.innerHTML = `<div style="color:#ff4444">é€£ç·šéŒ¯èª¤<br>${e.message}</div>`;
    }
  }

  // åŸ·è¡Œ
  preload();

</script>
</body>
</html>
