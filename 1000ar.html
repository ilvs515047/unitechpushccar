<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>UTå°è»Š AR é»æª¢ç³»çµ± (ç¯€èƒ½ç‰ˆ)</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: "Microsoft JhengHei", sans-serif;
      background-color: #000; overflow: hidden;
    }
    #videoElement { display: none; }
    #arCanvas { width: 100vw; height: 100vh; object-fit: cover; display: block; }
    
    /* è®€å–ç•«é¢ */
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); color: white;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 999;
    }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #00d2ff;
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* åº•éƒ¨è³‡è¨Šåˆ— */
    #hud {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,0.9); padding: 8px 20px;
      border-radius: 20px; font-weight: bold; color: #333;
      white-space: nowrap; pointer-events: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText">è³‡æ–™åº«åŒæ­¥ä¸­...</div>
  </div>

  <video id="videoElement" playsinline muted></video>
  <canvas id="arCanvas"></canvas>
  <div id="hud">ğŸ“· ç­‰å¾…æƒæ...</div>

<script>
  // ==========================================
  // 1. è¨­å®šèˆ‡é‚è¼¯ (å®Œå…¨ä¿ç•™æ‚¨åŸæœ¬çš„è¦å‰‡)
  // ==========================================
  const CONFIG = {
    CHECK_MONTHS: [1, 7], 
    GAS_URL: "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec"
  };

  let allRecords = [];
  
  // å„ªåŒ–è®Šæ•¸ï¼šç”¨æ–¼æ§åˆ¶æƒæé »ç‡
  let lastScanTime = 0;
  const SCAN_INTERVAL = 150; // æ¯ 150ms æƒæä¸€æ¬¡ (ç´„æ¯ç§’ 6-7 æ¬¡)ï¼Œå¤§å¹…çœé›»
  let lastCodeData = null;   // ç·©å­˜ä¸Šä¸€æ¬¡çš„æƒæçµæœï¼Œé¿å…ç•«é¢é–ƒçˆ

  const video = document.getElementById("videoElement");
  const canvas = document.getElementById("arCanvas");
  const ctx = canvas.getContext("2d", { alpha: false }); // alpha: false å¾®å¹…æå‡æ•ˆèƒ½
  const hud = document.getElementById("hud");

  // --- æ—¥æœŸèˆ‡æª¢æŸ¥é‚è¼¯ (ä¸è®Š) ---
  function todayYMD(){
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  }
  function minus18Months(ymd){
    const [y,m,d] = ymd.split('-').map(n=>parseInt(n,10));
    const dt = new Date(y, m-1, d);
    dt.setMonth(dt.getMonth() - 18);
    return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
  }
  function toDate(val){
    if (!val) return null;
    if (Object.prototype.toString.call(val) === '[object Date]') return val;
    const s = String(val).trim().slice(0,19).replace(/\//g,'-').replace(' ', 'T');
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  // æ ¸å¿ƒæª¢æŸ¥å‡½å¼
  function checkPeriodicStatus(recordDateVal) {
    const recordDate = toDate(recordDateVal);
    if (!recordDate) return { isOk: false, msg: "ç„¡æ•¸æ“š" };

    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;

    const sortedMonths = CONFIG.CHECK_MONTHS.sort((a,b) => a-b);
    let targetMonth = null;
    for (let i = sortedMonths.length - 1; i >= 0; i--) {
        if (currentMonth >= sortedMonths[i]) {
            targetMonth = sortedMonths[i];
            break;
        }
    }
    if (targetMonth === null) targetMonth = sortedMonths[0]; 

    const targetYear = currentYear;
    const rYear = recordDate.getFullYear();
    const rMonth = recordDate.getMonth() + 1;
    const isMatch = (rYear === targetYear && rMonth === targetMonth);

    return {
        isOk: isMatch,
        targetStr: `${targetMonth}æœˆ`,
        recordStr: `${rMonth}æœˆ`,
        lastDate: `${rYear}/${rMonth}/${recordDate.getDate()}`
    };
  }

  function getCarData(carId) {
    const matches = allRecords.filter(r => r.carId === carId).sort((a,b)=>new Date(b.time)-new Date(a.time));
    return matches.length > 0 ? matches[0] : null;
  }

  // ==========================================
  // 2. æ”å½±æ©Ÿå„ªåŒ–è¨­å®š
  // ==========================================
  function startCamera() {
    navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: "environment", 
        // ã€å„ªåŒ–é» 1ã€‘é™ä½è§£æåº¦åˆ° 640x480 (VGA)ï¼Œæ‰‹æ©Ÿè·‘èµ·ä¾†æ›´é †
        width: { ideal: 640 },
        height: { ideal: 480 },
        // ã€å„ªåŒ–é» 2ã€‘é™ä½æ”å½±æ©Ÿ FPS è«‹æ±‚ï¼Œç¯€çœå‚³è¼¸é »å¯¬
        frameRate: { ideal: 15, max: 20 } 
      } 
    }).then(stream => {
        video.srcObject = stream;
        video.setAttribute("playsinline", true);
        video.play();
        requestAnimationFrame(tick);
    }).catch(err => alert("æ”å½±æ©ŸéŒ¯èª¤: " + err.message));
  }

  // ==========================================
  // 3. AR ç¹ªåœ–èˆ‡é™æµ
  // ==========================================
  function drawRoundedRect(x, y, w, h, r, color) {
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.roundRect(x, y, w, h, r); // ç¾ä»£ç€è¦½å™¨æ”¯æ´ roundRect
    ctx.fill();
  }

  function tick(timestamp) {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      // è¨­å®š Canvas å¤§å° (åªéœ€è¨­å®šä¸€æ¬¡ï¼Œæˆ–åœ¨è¦–çª—æ”¹è®Šæ™‚è¨­å®šï¼Œé€™è£¡ç°¡åŒ–è™•ç†)
      if (canvas.width !== video.videoWidth) {
         canvas.width = video.videoWidth;
         canvas.height = video.videoHeight;
      }

      // 1. å…ˆç•«èƒŒæ™¯ (æ°¸é ä¿æŒæµæš¢ï¼Œçœ‹èµ·ä¾†ä¸å¡)
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // ã€å„ªåŒ–é» 3ã€‘é™åˆ¶æƒæé »ç‡ (æ¯ 150ms é‹ç®—ä¸€æ¬¡)
      // é€™èƒ½å¤§å¹…æ¸›å°‘æ‰‹æ©Ÿç™¼ç‡™æ©Ÿç‡
      if (timestamp - lastScanTime > SCAN_INTERVAL) {
        lastScanTime = timestamp;
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
        
        lastCodeData = code; // æ›´æ–°å…¨åŸŸè®Šæ•¸
      }

      // 2. å¦‚æœæœ‰ç·©å­˜çš„æƒæçµæœï¼Œå°±ç•«å‡ºä¾† (åˆ©ç”¨ç·©å­˜è®“æ¨™ç±¤é»è‘—åº¦æ›´å¥½)
      if (lastCodeData && lastCodeData.data) {
         drawOverlay(lastCodeData);
      } else {
         hud.innerText = "ğŸ“· æƒæä¸­...";
         hud.style.color = "#333";
      }
    }
    requestAnimationFrame(tick);
  }

  function drawOverlay(code) {
    const carId = code.data.trim();
    const record = getCarData(carId);
    
    // é è¨­æ¨£å¼ (Fail)
    let color = "rgba(220, 38, 38, 0.85)"; // ç´…è‰²åŠé€æ˜
    let title = "âš ï¸ æœªçŸ¥/æœªæª¢";
    let sub = "æŸ¥ç„¡è³‡æ–™";
    
    if (record) {
      const status = checkPeriodicStatus(record.time);
      if (status.isOk) {
        color = "rgba(22, 163, 74, 0.85)"; // ç¶ è‰²
        title = `âœ… ${carId} åˆæ ¼`;
        sub = `æ—¥æœŸ: ${status.lastDate}`;
        hud.innerText = `âœ… åˆæ ¼: ${carId}`;
        hud.style.color = "green";
      } else {
        color = "rgba(220, 38, 38, 0.85)"; // ç´…è‰²
        title = `âŒ ${carId} NG`;
        sub = `æ‡‰æª¢:${status.targetStr} (å¯¦:${status.recordStr})`;
        hud.innerText = `âŒ æœªå®Œæˆ: ${carId}`;
        hud.style.color = "red";
      }
    } else {
        title = `â“ ${carId}`;
        hud.innerText = `â“ æœªçŸ¥: ${carId}`;
    }

    // è¨ˆç®—ä½ç½®
    const loc = code.location;
    const x = loc.topLeftCorner.x;
    const y = loc.topLeftCorner.y;
    const w = (loc.topRightCorner.x - loc.topLeftCorner.x);
    
    // ç•«æ¡†æ¡† (ç·šæ¢)
    ctx.lineWidth = 4;
    ctx.strokeStyle = color;
    ctx.beginPath();
    ctx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
    ctx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
    ctx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
    ctx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
    ctx.closePath();
    ctx.stroke();

    // ç•«è³‡è¨Šå¡ (åœ¨æ¡†æ¡†ä¸Šæ–¹)
    const boxW = 180;
    const boxH = 60;
    // ç°¡å–®ç½®ä¸­ç®—æ³•
    const boxX = x + (w/2) - (boxW/2);
    const boxY = y - boxH - 10;

    drawRoundedRect(boxX, boxY, boxW, boxH, 8, "white"); // ç™½åº•
    drawRoundedRect(boxX, boxY, 8, boxH, 0, color);      // å·¦å´è‰²æ¢

    // æ–‡å­—
    ctx.fillStyle = "#333";
    ctx.font = "bold 18px Arial";
    ctx.fillText(title, boxX + 16, boxY + 24);
    
    ctx.fillStyle = "#666";
    ctx.font = "13px Arial";
    ctx.fillText(sub, boxX + 16, boxY + 46);
  }

  // ==========================================
  // 4. åˆå§‹åŒ–
  // ==========================================
  async function preload() {
    const until = todayYMD();
    const from = minus18Months(until); 
    const loadingText = document.getElementById("loadingText");
    
    try {
      const res = await fetch(`${CONFIG.GAS_URL}?mode=list&from=${from}&until=${until}`);
      const data = await res.json();
      allRecords = data.records || []; // é€™è£¡ç°¡åŒ–ç¯©é¸ï¼Œå‡è¨­å¾Œç«¯æˆ–å‰é¢çš„éæ¿¾å¤ ç”¨
      
      document.getElementById("loadingOverlay").style.display = "none";
      startCamera();
    } catch(e) {
      loadingText.innerHTML = "âŒ è³‡æ–™è¼‰å…¥å¤±æ•—<br>è«‹é‡æ–°æ•´ç†";
    }
  }

  preload();

</script>
</body>
</html>
