<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>UTå°è»Š ARé»æª¢ (Tablet Pro)</title>
  
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    body {
      margin: 0; padding: 0;
      background-color: #000;
      overflow: hidden; /* ç¦æ­¢æ²å‹• */
      font-family: "Segoe UI", sans-serif;
    }

    /* å®¹å™¨ï¼šç–ŠåŠ  Video å’Œ 3D Canvas */
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    /* åº•å±¤ï¼šç›¸æ©Ÿç•«é¢ */
    #reader {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0; left: 0;
      z-index: 1;
    }
    #reader video {
      object-fit: cover;
      width: 100%; height: 100%;
    }

    /* ä¸Šå±¤ï¼šThree.js 3D å ´æ™¯ */
    #canvas-container {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 2;
      pointer-events: none; /* è®“é»æ“Šç©¿é€ */
    }

    /* UIï¼šè¼‰å…¥ç•«é¢ */
    #overlay {
      position: absolute; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.85); color: #00ffcc;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 99; font-size: 1.2rem; text-align: center;
    }
    .loading-bar {
      width: 200px; height: 4px; background: #333; margin-top: 20px;
      border-radius: 2px; overflow: hidden;
    }
    .loading-progress {
      width: 0%; height: 100%; background: #00ffcc;
      transition: width 0.3s;
      box-shadow: 0 0 10px #00ffcc;
    }
    
    /* UIï¼šé™¤éŒ¯è³‡è¨Š */
    #debug {
      position: absolute; bottom: 10px; left: 10px;
      color: rgba(255,255,255,0.5); font-size: 12px; z-index: 10;
    }
    
    #cameraSelect { display: none; }
  </style>
</head>
<body>

<div id="container">
  <div id="reader"></div>
  
  <div id="canvas-container"></div>
  
  <div id="overlay">
    <div>ğŸš€ åˆå§‹åŒ– AR å¼•æ“...</div>
    <div class="loading-bar"><div class="loading-progress" id="loadBar"></div></div>
    <div style="font-size: 0.9rem; margin-top: 10px; color: #aaa;">Tablet Performance Mode</div>
  </div>
  
  <div id="debug">System Ready</div>
</div>
<select id="cameraSelect"></select>

<script>
  // ==========================================
  // 1. è¨­å®šæª” & è³‡æ–™å¿«å–
  // ==========================================
  const CONFIG = {
    CHECK_MONTHS: [1, 7], 
    GAS_URL: "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec"
  };

  let allRecords = [];
  let qrScanner = null;
  
  // Three.js è®Šæ•¸
  let scene, camera, renderer, arPlane;
  let textureCanvas, textureContext, arTexture;
  let isTracking = false;
  let hideTimer = null;

  // ==========================================
  // 2. è³‡æ–™é‚è¼¯ (Fetch & Check)
  // ==========================================
  function toDate(val){
    if (!val) return null;
    if (Object.prototype.toString.call(val) === '[object Date]' && !isNaN(val)) return val;
    const s = String(val).trim().slice(0,19).replace(/\//g,'-').replace(' ', 'T');
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  function checkStatus(carId) {
    // æ‰¾å‡ºè©²è»Šè³‡æ–™
    const matches = allRecords.filter(r => r.carId === carId).sort((a,b)=>new Date(b.time)-new Date(a.time));
    const record = matches[0];
    
    const now = new Date();
    const sortedMonths = CONFIG.CHECK_MONTHS.sort((a,b) => a-b);
    let targetMonth = sortedMonths[0];
    for (let i = sortedMonths.length - 1; i >= 0; i--) {
        if ((now.getMonth()+1) >= sortedMonths[i]) { targetMonth = sortedMonths[i]; break; }
    }
    const targetStr = `${now.getFullYear()}/${targetMonth}`;

    if (!record) {
      return { ok: false, msg: "ç„¡è³‡æ–™", detail: "ç³»çµ±æŸ¥ç„¡ç´€éŒ„", color: "#ff4444" };
    }
    
    const rDate = toDate(record.time);
    const isOk = (rDate.getFullYear() === now.getFullYear() && (rDate.getMonth()+1) === targetMonth);
    
    return {
      ok: isOk,
      msg: isOk ? "âœ… åˆæ ¼" : "âš ï¸ æœªæª¢",
      detail: isOk ? `æª¢:${rDate.getFullYear()}/${rDate.getMonth()+1}` : `æ‡‰æª¢:${targetStr}`,
      color: isOk ? "#00ff88" : "#ff4444",
      worker: record.workerId || ""
    };
  }

  // ==========================================
  // 3. Three.js 3D å¼•æ“åˆå§‹åŒ–
  // ==========================================
  function initThreeJS() {
    const container = document.getElementById('canvas-container');
    const width = container.clientWidth;
    const height = container.clientHeight;

    // A. å»ºç«‹å ´æ™¯
    scene = new THREE.Scene();

    // B. å»ºç«‹ç›¸æ©Ÿ (æ­£äº¤ç›¸æ©Ÿï¼Œé©åˆ UI ç–ŠåŠ )
    camera = new THREE.OrthographicCamera(width / -2, width / 2, height / 2, height / -2, 1, 1000);
    camera.position.z = 10;

    // C. å»ºç«‹æ¸²æŸ“å™¨ (é€æ˜èƒŒæ™¯)
    renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true }); // é–‹å•Ÿåé‹¸é½’
    renderer.setSize(width, height);
    renderer.setPixelRatio(window.devicePixelRatio); // æ”¯æ´ Retina/é«˜è§£æè¢å¹•
    container.appendChild(renderer.domElement);

    // D. æº–å‚™å‹•æ…‹ç´‹ç† (Canvas)
    // æˆ‘å€‘ä¸è®€å–åœ–ç‰‡ï¼Œè€Œæ˜¯ç”¨ç¨‹å¼ç¢¼åœ¨ Canvas ä¸Šç•«å‡ºè³‡è¨Šå¡ï¼Œé€™æ¨£æœ€éˆæ´»
    textureCanvas = document.createElement('canvas');
    textureCanvas.width = 512;  // é«˜è§£æåº¦è²¼åœ–
    textureCanvas.height = 256;
    textureContext = textureCanvas.getContext('2d');
    
    arTexture = new THREE.CanvasTexture(textureCanvas);
    arTexture.minFilter = THREE.LinearFilter;
    
    // E. å»ºç«‹ 3D é¢æ¿ (PlaneGeometry)
    const geometry = new THREE.PlaneGeometry(300, 150); // å¤§å°
    const material = new THREE.MeshBasicMaterial({ 
      map: arTexture, 
      transparent: true, 
      opacity: 0,
      side: THREE.DoubleSide
    });
    
    arPlane = new THREE.Mesh(geometry, material);
    scene.add(arPlane);

    // F. é–‹å§‹æ¸²æŸ“è¿´åœˆ
    animate();
  }

  function animate() {
    requestAnimationFrame(animate);
    
    // å¹³æ»‘æ·¡å‡ºæ•ˆæœ
    if (!isTracking && arPlane.material.opacity > 0) {
        arPlane.material.opacity -= 0.1;
    }
    
    renderer.render(scene, camera);
  }

  // ==========================================
  // 4. å‹•æ…‹ç¹ªè£½ AR å¡ç‰‡å…§å®¹
  // ==========================================
  function updateARCardTexture(carId) {
    const ctx = textureContext;
    const w = textureCanvas.width;
    const h = textureCanvas.height;
    const data = checkStatus(carId);

    // æ¸…ç©ºç•«å¸ƒ
    ctx.clearRect(0, 0, w, h);

    // 1. ç•«èƒŒæ™¯ (åŠé€æ˜é»‘ + ç§‘æŠ€æ„Ÿé‚Šæ¡†)
    ctx.fillStyle = "rgba(10, 20, 30, 0.85)"; // æ·±è—é»‘
    ctx.beginPath();
    ctx.roundRect(10, 10, w-20, h-20, 30); // åœ“è§’
    ctx.fill();

    // é‚Šæ¡†é¡è‰² (æ ¹æ“šç‹€æ…‹è®Šè‰²)
    ctx.lineWidth = 8;
    ctx.strokeStyle = data.color;
    ctx.stroke();

    // 2. ç•«é€£æ¥ç·š (è£é£¾)
    ctx.fillStyle = data.color;
    ctx.fillRect(40, h/2 - 50, 6, 100);

    // 3. ç•«æ–‡å­—
    ctx.textBaseline = "middle";
    
    // è»Šè™Ÿ
    ctx.font = "bold 60px Arial";
    ctx.fillStyle = "#ffffff";
    ctx.fillText(carId, 70, 70);

    // ç‹€æ…‹ (åˆæ ¼/æœªæª¢)
    ctx.font = "bold 50px Arial";
    ctx.fillStyle = data.color;
    ctx.fillText(data.msg, 320, 70);

    // åˆ†éš”ç·š
    ctx.strokeStyle = "rgba(255,255,255,0.3)";
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(60, 120); ctx.lineTo(w-40, 120); ctx.stroke();

    // è©³ç´°è³‡è¨Š
    ctx.font = "40px Arial";
    ctx.fillStyle = "#cccccc";
    ctx.fillText(data.detail, 70, 180);
    
    if (data.worker) {
        ctx.font = "30px Arial";
        ctx.fillStyle = "#888888";
        ctx.fillText(`äººå“¡: ${data.worker}`, 320, 180);
    }

    // å‘Šè¨´ Three.js ç´‹ç†æ›´æ–°äº†
    arTexture.needsUpdate = true;
  }

  // ==========================================
  // 5. æ ¸å¿ƒï¼šQR Code åº§æ¨™ -> 3D ç©ºé–“æ˜ å°„
  // ==========================================
  function updateMeshPosition(decodedResult) {
    const loc = decodedResult.result.location;
    if (!loc) return;

    // 1. å–å¾—è¦–è¨Šèˆ‡è¢å¹•çš„æ¯”ä¾‹é—œä¿‚ (åŒå‰)
    const videoEl = document.querySelector("#reader video");
    if (!videoEl) return;
    
    // è¨ˆç®—ç¸®æ”¾æ¯”èˆ‡åç§»
    const vW = videoEl.videoWidth;
    const vH = videoEl.videoHeight;
    const dW = videoEl.offsetWidth;
    const dH = videoEl.offsetHeight;
    const scale = Math.max(dW / vW, dH / vH);
    const overflowX = (vW * scale - dW) / 2;
    const overflowY = (vH * scale - dH) / 2;

    // 2. æ‰¾å‡º QR Code ä¸­å¿ƒé»èˆ‡å¯¬åº¦
    const pTL = loc.topLeftCorner;
    const pTR = loc.topRightCorner;
    
    // è½‰æ›æˆè¢å¹•åº§æ¨™ (Screen Coords)
    const screenCenterX = ((pTL.x + pTR.x) / 2 * scale) - overflowX;
    const screenCenterY = ((pTL.y + pTR.y) / 2 * scale) - overflowY;
    
    // è¨ˆç®—æ—‹è½‰è§’åº¦
    const angleRad = Math.atan2(pTR.y - pTL.y, pTR.x - pTL.x);

    // è¨ˆç®— QR Code åœ¨ç•«é¢ä¸Šçš„å¯¬åº¦ (ç”¨ä¾†æ±ºå®šç¸®æ”¾)
    const qrWidthOnScreen = Math.sqrt(Math.pow((pTR.x - pTL.x)*scale, 2) + Math.pow((pTR.y - pTL.y)*scale, 2));
    const baseScale = qrWidthOnScreen / 200; // åŸºæº–ç¸®æ”¾ä¿‚æ•¸

    // 3. æ›´æ–° Three.js ç‰©ä»¶
    // æ³¨æ„ï¼šThree.js çš„ (0,0) åœ¨ç•«é¢æ­£ä¸­å¿ƒï¼ŒYè»¸å‘ä¸Š
    // è¢å¹•åº§æ¨™ (0,0) åœ¨å·¦ä¸Šè§’ï¼ŒYè»¸å‘ä¸‹
    // è½‰æ›å…¬å¼ï¼š
    const threeX = screenCenterX - dW / 2;
    const threeY = -(screenCenterY - dH / 2); // Yè»¸åè½‰

    // ä½ç½®ï¼šç¨å¾®å¾€ä¸Šæµ®ä¸€é» (+ qrWidthOnScreen/2)
    arPlane.position.set(threeX, threeY + 100 * baseScale, 0); 
    
    // æ—‹è½‰ï¼šè·Ÿéš¨ QR Code å‚¾æ–œ
    arPlane.rotation.z = -angleRad; // Three.js æ—‹è½‰æ–¹å‘ç›¸å
    
    // ç¸®æ”¾ï¼šæ ¹æ“šè·é›¢é è¿‘
    arPlane.scale.set(baseScale, baseScale, 1);
    
    // é¡¯ç¤º
    arPlane.material.opacity = 1;
    isTracking = true;

    // è‡ªå‹•æ¶ˆå¤±è¨ˆæ™‚
    clearTimeout(hideTimer);
    hideTimer = setTimeout(() => {
        isTracking = false;
    }, 500);
  }

  // ==========================================
  // 6. ç³»çµ±å•Ÿå‹•æµç¨‹
  // ==========================================
  async function startSystem() {
    const bar = document.getElementById('loadBar');
    bar.style.width = "30%";

    // A. è¼‰å…¥è³‡æ–™
    const today = new Date().toISOString().split('T')[0];
    const past = new Date(); past.setMonth(past.getMonth()-18);
    try {
        const res = await fetch(`${CONFIG.GAS_URL}?mode=list&from=${past.toISOString().split('T')[0]}&until=${today}`);
        const data = await res.json();
        allRecords = data.records || [];
        bar.style.width = "70%";
    } catch(e) {
        console.error(e);
        alert("è³‡æ–™åº«é€£ç·šå¤±æ•—");
    }

    // B. åˆå§‹åŒ– 3D å¼•æ“
    initThreeJS();
    bar.style.width = "90%";

    // C. å•Ÿå‹•ç›¸æ©Ÿ
    qrScanner = new Html5Qrcode("reader");
    const devices = await Html5Qrcode.getCameras();
    if (devices && devices.length) {
       // å¹³æ¿é€šå¸¸æœ‰å¥½å¹¾å€‹é¡é ­ï¼Œå˜—è©¦é¸æœ€å¾Œä¸€å€‹ (é€šå¸¸æ˜¯ä¸»é¡é ­)
       const camId = devices[devices.length-1].id;
       
       // å¹³æ¿é…ç½®ï¼šé«˜ç•«è³ª
       const config = {
         fps: 20, // å¹³æ¿æ•ˆèƒ½å¥½ï¼ŒFPS é–‹é«˜ä¸€é»æ›´æµæš¢
         qrbox: { width: 300, height: 300 },
         aspectRatio: window.innerHeight / window.innerWidth,
         videoConstraints: {
            width: { ideal: 1280 }, // ä½¿ç”¨ 720p æˆ–æ›´é«˜
            height: { ideal: 720 },
            facingMode: "environment"
         }
       };

       await qrScanner.start(camId, config, (decodedText, decodedResult) => {
           // 1. ç¹ªè£½ç´‹ç† (å¦‚æœæƒæåˆ°æ–°çš„æ‰é‡ç¹ªï¼Œç¯€çœæ•ˆèƒ½)
           if (arPlane.userData.lastId !== decodedText) {
               arPlane.userData.lastId = decodedText;
               updateARCardTexture(decodedText);
               if(navigator.vibrate) navigator.vibrate(50);
           }
           // 2. æ›´æ–° 3D ä½ç½® (æ¯å¹€éƒ½åš)
           updateMeshPosition(decodedResult);
       }, () => {});
    }

    // D. éš±è—è¼‰å…¥ç•«é¢
    bar.style.width = "100%";
    setTimeout(()=>{
        document.getElementById('overlay').style.display = 'none';
    }, 500);
  }

  // å•Ÿå‹•
  startSystem();
  
  // è¦–çª—å¤§å°æ”¹è®Šæ™‚é‡è¨­ç›¸æ©Ÿ (å¹³æ¿æ—‹è½‰æ™‚å¾ˆé‡è¦)
  window.addEventListener('resize', () => {
    if(camera && renderer) {
        const w = document.body.clientWidth;
        const h = document.body.clientHeight;
        renderer.setSize(w, h);
        camera.left = -w / 2;
        camera.right = w / 2;
        camera.top = h / 2;
        camera.bottom = -h / 2;
        camera.updateProjectionMatrix();
    }
  });

</script>
</body>
</html>
