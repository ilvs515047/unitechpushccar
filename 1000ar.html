<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>UTå°è»Š çœŸARé»æª¢ç³»çµ±</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      margin: 0; padding: 0;
      background-color: #000;
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      overflow: hidden; /* é˜²æ­¢å·è»¸å‡ºç¾ */
      height: 100vh;
      width: 100vw;
    }

    /* === 1. å…¨è¢å¹•ç›¸æ©Ÿå®¹å™¨ === */
    #ar-scene {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
    }

    /* å¼·åˆ¶ video å¡«æ»¿ï¼Œé€™æ˜¯åº§æ¨™å°é½Šçš„é—œéµ */
    #reader {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
    }
    #reader video {
      width: 100%;
      height: 100%;
      object-fit: cover; /* è®“ç•«é¢å¡«æ»¿ä¸ç•™é»‘é‚Š */
    }

    /* === 2. æ‡¸æµ® AR æ¨™ç±¤ (é€™å°±æ˜¯é‚£å¼µå¡ç‰‡) === */
    #ar-tag {
      position: absolute;
      top: 0; left: 0;
      width: 240px;
      /* åˆå§‹éš±è— */
      opacity: 0; 
      transform: scale(0.8);
      transform-origin: top left; /* ä»¥å·¦ä¸Šè§’ç‚ºå®šä½é» */
      transition: opacity 0.2s, transform 0.1s linear; /* åº§æ¨™ç§»å‹•è¦é †æš¢ */
      pointer-events: auto; /* å…è¨±é»æ“Š */
      z-index: 10;
    }

    /* å¡ç‰‡æ¨£å¼ (ç§‘æŠ€æ„Ÿ) */
    .tag-content {
      background: rgba(16, 24, 39, 0.85); /* æ·±è—é»‘åŠé€æ˜ */
      backdrop-filter: blur(8px);
      border: 1px solid rgba(59, 130, 246, 0.5); /* äº®è—é‚Šæ¡† */
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 12px;
      color: #fff;
      position: relative;
    }
    
    /* é€£æ¥ç·š (æŒ‡å‘ QR Code çš„è£é£¾ç·š) */
    .tag-line {
      position: absolute;
      top: -20px; left: 20px;
      width: 2px; height: 20px;
      background: #3b82f6;
    }
    .tag-dot {
      position: absolute;
      top: -24px; left: 17px;
      width: 8px; height: 8px;
      background: #3b82f6;
      border-radius: 50%;
      box-shadow: 0 0 5px #3b82f6;
    }

    /* å…§å®¹æ’ç‰ˆ */
    .tag-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px; }
    .tag-id { font-size: 16px; font-weight: bold; color: #60a5fa; }
    .tag-status { font-size: 12px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    .status-ok { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid #059669; }
    .status-ng { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid #dc2626; }
    
    .tag-body { font-size: 13px; color: #cbd5e1; line-height: 1.4; }
    .tag-row { display: flex; justify-content: space-between; }
    
    /* è¼‰å…¥ä¸­å‹•ç•« */
    .loading-pulse {
      animation: pulse 1.5s infinite;
      text-align: center; font-size: 12px; color: #94a3b8;
    }
    @keyframes pulse { 0% {opacity:0.6;} 50% {opacity:1;} 100% {opacity:0.6;} }

    /* éš±è—çš„ select */
    #cameraSelect { display: none; }
    
    /* è¼”åŠ©è¨Šæ¯ */
    #guide-msg {
      position: absolute; bottom: 50px; left: 0; width: 100%;
      text-align: center; color: rgba(255,255,255,0.7);
      font-size: 14px; text-shadow: 0 1px 2px #000;
      pointer-events: none;
    }
  </style>
</head>
<body>

<div id="ar-scene">
  <div id="reader"></div>
  
  <div id="ar-tag">
    <div class="tag-dot"></div>
    <div class="tag-line"></div>
    <div class="tag-content" id="tagContent">
      <div class="loading-pulse">ğŸ” è®€å–è³‡æ–™ä¸­...</div>
    </div>
  </div>

  <div id="guide-msg">è«‹å°‡é¡é ­å°æº–å°è»Š QR Code</div>
</div>

<select id="cameraSelect"></select>

<script>
  // ==========================================
  // âš™ï¸ è¨­å®šæª”èˆ‡é‚è¼¯
  // ==========================================
  const CONFIG = {
    CHECK_MONTHS: [1, 7], 
    GAS_URL: "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec"
  };

  let allRecords = [];
  let qrScanner = null;
  let currentCameraId = null;
  
  // AR ç‹€æ…‹è®Šæ•¸
  let lastScannedId = null;   // ç´€éŒ„ä¸Šæ¬¡æƒåˆ°çš„ IDï¼Œé¿å…é‡è¤‡ fetch
  let lastScanTime = 0;       // ç”¨ä¾†åˆ¤æ–·æ˜¯å¦ã€Œè·Ÿä¸Ÿäº†ã€
  let hideTimer = null;       // éš±è—å¡ç‰‡çš„è¨ˆæ™‚å™¨
  const HIDE_DELAY_MS = 1000; // å¦‚æœ 1ç§’å…§æ²’æƒåˆ°ï¼Œå°±éš±è—å¡ç‰‡

  // æ—¥æœŸè™•ç†å·¥å…· (æ²¿ç”¨æ‚¨çš„é‚è¼¯)
  function toDate(val){
    if (!val) return null;
    if (Object.prototype.toString.call(val) === '[object Date]' && !isNaN(val)) return val;
    const s = String(val).trim().slice(0,19).replace(/\//g,'-').replace(' ', 'T');
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  function checkPeriodicStatus(recordDateVal) {
    const recordDate = toDate(recordDateVal);
    if (!recordDate) return { isOk: false, msg: "ç„¡", targetStr:"-", recordStr:"-" };
    const now = new Date();
    const sortedMonths = CONFIG.CHECK_MONTHS.sort((a,b) => a-b);
    let targetMonth = sortedMonths[0];
    for (let i = sortedMonths.length - 1; i >= 0; i--) {
        if ((now.getMonth()+1) >= sortedMonths[i]) { targetMonth = sortedMonths[i]; break; }
    }
    return {
        isOk: (recordDate.getFullYear() === now.getFullYear() && (recordDate.getMonth()+1) === targetMonth),
        targetStr: `${now.getFullYear()}/${targetMonth}`,
        recordStr: `${recordDate.getFullYear()}/${recordDate.getMonth()+1}`
    };
  }

  // ==========================================
  // ğŸš€ æ ¸å¿ƒï¼šæ›´æ–° AR æ¨™ç±¤ä½ç½®
  // ==========================================
  function updateARPosition(decodedResult) {
    // 1. å–å¾— QR Code çš„å››å€‹è§’è½åº§æ¨™ (é€™æ˜¯ video å…§çš„åŸå§‹åº§æ¨™)
    // format: { x: number, y: number }
    const loc = decodedResult.result.location; 
    
    if (!loc) return;

    // æˆ‘å€‘ç°¡å–®å–ã€Œå³ä¸Šè§’ (topRightCorner)ã€ä½œç‚ºæ¨™ç±¤çš„éŒ¨é»
    // ä½ ä¹Ÿå¯ä»¥ç®—ä¸­å¿ƒé»ï¼š(loc.topLeftCorner.x + loc.bottomRightCorner.x) / 2 ...
    const point = loc.topRightCorner; 

    // 2. åº§æ¨™è½‰æ›ï¼š Videoåº§æ¨™ -> è¢å¹•åº§æ¨™
    // Html5Qrcode çš„ video å…ƒç´ 
    const videoEl = document.querySelector("#reader video");
    if (!videoEl) return;

    // åŸå§‹å½±ç‰‡å°ºå¯¸ (ä¾‹å¦‚ 640x480)
    const videoWidth = videoEl.videoWidth;
    const videoHeight = videoEl.videoHeight;
    
    // å¯¦éš›é¡¯ç¤ºåœ¨è¢å¹•ä¸Šçš„å°ºå¯¸ (ä¾‹å¦‚ 390x844)
    const displayWidth = videoEl.offsetWidth;
    const displayHeight = videoEl.offsetHeight;

    // é€™è£¡æ˜¯ object-fit: cover çš„æ•¸å­¸é›£é»
    // æˆ‘å€‘éœ€è¦ç®—å‡ºã€Œç¸®æ”¾æ¯”ä¾‹ã€å’Œã€Œè£åˆ‡åç§»ã€
    const scaleX = displayWidth / videoWidth;
    const scaleY = displayHeight / videoHeight;
    const scale = Math.max(scaleX, scaleY); // å› ç‚ºæ˜¯ coverï¼Œå–æœ€å¤§å€¼

    // ç®—å‡ºå½±ç‰‡ç½®ä¸­å¾Œçš„åç§»é‡
    const overflowX = (videoWidth * scale - displayWidth) / 2;
    const overflowY = (videoHeight * scale - displayHeight) / 2;

    // æœ€çµ‚è¢å¹•åº§æ¨™å…¬å¼
    const screenX = (point.x * scale) - overflowX;
    const screenY = (point.y * scale) - overflowY;

    // 3. ç§»å‹• DOM å…ƒç´ 
    const tag = document.getElementById("ar-tag");
    
    // åŠ ä¸Šä¸€é»åç§»é‡ï¼Œè®“å¡ç‰‡ä¸è¦æ“‹ä½ QR Code æœ¬èº«ï¼Œè€Œæ˜¯æµ®åœ¨å³ä¸Šæ–¹
    tag.style.left = `${screenX + 10}px`; 
    tag.style.top = `${screenY - 30}px`;
    
    // é¡¯ç¤ºå¡ç‰‡
    tag.style.opacity = 1;
    tag.style.transform = "scale(1)";

    // é‡ç½®éš±è—è¨ˆæ™‚å™¨ (åªè¦æŒçºŒæƒåˆ°ï¼Œå°±ä¸æœƒæ¶ˆå¤±)
    clearTimeout(hideTimer);
    hideTimer = setTimeout(() => {
      // å¦‚æœè¶…é 1 ç§’æ²’æƒåˆ°ï¼Œå°±æ·¡å‡ºå¡ç‰‡
      tag.style.opacity = 0;
      tag.style.transform = "scale(0.8)";
      lastScannedId = null; // å…è¨±ä¸‹æ¬¡é‡æ–°è®€å–
    }, HIDE_DELAY_MS);
  }

  // ==========================================
  // ğŸ“‹ æ¸²æŸ“è³‡æ–™åˆ°å¡ç‰‡ä¸Š
  // ==========================================
  function updateTagContent(carId) {
    const contentEl = document.getElementById("tagContent");
    const matches = allRecords.filter(r => r.carId === carId).sort((a,b)=>new Date(b.time)-new Date(a.time));
    const result = matches[0];

    if (!result) {
      contentEl.innerHTML = `
        <div class="tag-header">
           <span class="tag-id">${carId}</span>
           <span class="tag-status status-ng">ç„¡è³‡æ–™</span>
        </div>
        <div class="tag-body">ç³»çµ±ä¸­ç„¡æ­¤ç´€éŒ„</div>
      `;
    } else {
      const status = checkPeriodicStatus(result.time);
      const statusClass = status.isOk ? "status-ok" : "status-ng";
      const statusText = status.isOk ? "åˆæ ¼" : "æœªæª¢";
      
      contentEl.innerHTML = `
        <div class="tag-header">
           <span class="tag-id">${carId}</span>
           <span class="tag-status ${statusClass}">${statusText}</span>
        </div>
        <div class="tag-body">
           <div class="tag-row"><span>ä¸Šæ¬¡:</span> <span>${status.recordStr}</span></div>
           <div class="tag-row"><span>æ‡‰æª¢:</span> <span>${status.targetStr}</span></div>
           <div style="margin-top:4px; font-size:11px; color:#94a3b8; border-top:1px dashed #444; padding-top:2px;">
             ${result.workerId ? 'é»æª¢äºº: '+result.workerId : ''}
           </div>
        </div>
      `;
    }
  }

  // ==========================================
  // ğŸ“· æ”å½±æ©Ÿåˆå§‹åŒ–
  // ==========================================
  async function initCamera() {
    qrScanner = new Html5Qrcode("reader");
    const devices = await Html5Qrcode.getCameras();
    
    if (devices && devices.length) {
      // æ‰¾æœ€å¾Œä¸€å€‹é¡é ­ (é€šå¸¸æ˜¯å¾Œç½®)
      currentCameraId = devices[devices.length-1].id;
      
      // ä½¿ç”¨æ‚¨çš„ä½å»¶é²åƒæ•¸
      const config = {
        fps: 15, // æé«˜ä¸€é» FPS è®“è¿½è¹¤æ¯”è¼ƒå¹³æ»‘ (5å¤ªå¡ï¼Œ15é‚„å¯ä»¥æ¥å—)
        qrbox: { width: 250, height: 250 },
        aspectRatio: window.innerHeight / window.innerWidth, // é…åˆå…¨è¢å¹•
        videoConstraints: {
          width:  { ideal: 640 }, // ä¿æŒä½è§£æåº¦ä»¥æ±‚æ•ˆèƒ½
          height: { ideal: 480 },
          facingMode: "environment"
        }
      };

      await qrScanner.start(
        currentCameraId,
        config,
        (decodedText, decodedResult) => {
          // === æƒææˆåŠŸ Callback (æœƒæŒçºŒè§¸ç™¼) ===
          
          // 1. æ›´æ–° AR ä½ç½® (æ¯å¹€éƒ½åš)
          updateARPosition(decodedResult);

          // 2. å¦‚æœæ˜¯æ–°çš„ IDï¼Œæ‰æ›´æ–°è³‡æ–™å…§å®¹ (æ¸›å°‘ DOM æ“ä½œ)
          if (decodedText !== lastScannedId) {
            lastScannedId = decodedText;
            updateTagContent(decodedText);
            
            // éœ‡å‹•ä¸€ä¸‹è¡¨ç¤ºæŠ“åˆ°äº†
            if (navigator.vibrate) navigator.vibrate(50);
          }
        },
        (error) => {
          // æƒä¸åˆ°æ™‚ä»€éº¼éƒ½ä¸åšï¼Œè®“ hideTimer è‡ªå·±å»è·‘
        }
      );
    } else {
      alert("ç„¡æ”å½±æ©Ÿ");
    }
  }

  // ==========================================
  // ğŸš€ å•Ÿå‹•
  // ==========================================
  async function preload() {
    const today = new Date().toISOString().split('T')[0];
    const past = new Date(); past.setMonth(past.getMonth()-18);
    const from = past.toISOString().split('T')[0];

    try {
      // é å…ˆè¼‰å…¥è³‡æ–™
      const res = await fetch(`${CONFIG.GAS_URL}?mode=list&from=${from}&until=${today}`);
      const data = await res.json();
      allRecords = data.records || [];
      
      document.getElementById("tagContent").innerHTML = '<div style="color:#fff">è«‹æƒæ...</div>';
      await initCamera();
    } catch(e) {
      alert("è³‡æ–™è¼‰å…¥å¤±æ•—");
    }
  }

  preload();

</script>
</body>
</html>
