<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>UTå°è»Š æ¥µé€ŸAR</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      margin: 0; padding: 0;
      background-color: #000;
      font-family: sans-serif; /* ç”¨æœ€é è¨­çš„å­—é«” */
      overflow: hidden;
      height: 100vh; width: 100vw;
    }

    #ar-scene {
      position: relative;
      width: 100%; height: 100%;
      background: #000;
    }

    #reader {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
    }
    #reader video {
      width: 100%; height: 100%;
      object-fit: cover;
    }

    /* === å„ªåŒ–å¾Œçš„ AR æ¨™ç±¤ === */
    /* ç§»é™¤æ‰€æœ‰é™°å½±ã€åœ“è§’ã€æ¯›ç»ç’ƒï¼Œåªä¿ç•™ç´”ç²¹çš„è‰²å¡Šä»¥æ±‚æœ€é«˜æ•ˆèƒ½ */
    #ar-tag {
      position: absolute;
      top: 0; left: 0;
      width: 220px;
      opacity: 0;
      transform-origin: top left;
      /* æ¸›å°‘å‹•ç•«æ™‚é–“ï¼Œè®“åæ‡‰æ›´éˆæ• */
      transition: top 0.1s linear, left 0.1s linear; 
      pointer-events: auto;
      z-index: 10;
    }

    .tag-content {
      /* [æ•ˆèƒ½é—œéµ] ç§»é™¤ backdrop-filter: blurï¼Œæ”¹ç”¨é«˜å°æ¯”ç´”è‰²èƒŒæ™¯ */
      background: rgba(0, 0, 0, 0.85); 
      border: 2px solid #00ff00; /* é«˜å°æ¯”ç¶ è‰²é‚Šæ¡† */
      padding: 8px;
      color: #fff;
    }

    /* ç°¡å–®çš„é€£ç·šï¼Œä¸ä½¿ç”¨è¤‡é›œ CSS */
    .tag-line {
      position: absolute; top: -15px; left: 0;
      width: 2px; height: 15px; background: #00ff00;
    }

    .tag-header { 
      display: flex; justify-content: space-between; 
      border-bottom: 1px solid #555; padding-bottom: 4px; margin-bottom: 4px;
    }
    .tag-id { font-size: 16px; font-weight: bold; color: #00ff00; }
    
    .tag-row { font-size: 12px; display: flex; justify-content: space-between; line-height: 1.5; }
    .status-ok { color: #00ff00; font-weight: bold; }
    .status-ng { color: #ff0000; font-weight: bold; }

    #cameraSelect { display: none; }
    
    #debug-fps {
      position: absolute; top: 5px; left: 5px; 
      color: #0f0; font-size: 10px; background: rgba(0,0,0,0.5); z-index:99;
    }
  </style>
</head>
<body>

<div id="ar-scene">
  <div id="reader"></div>
  <div id="debug-fps">ä½ç•«è³ªæ¨¡å¼: 320p</div>
  
  <div id="ar-tag">
    <div class="tag-line"></div>
    <div class="tag-content" id="tagContent">
      <div>è®€å–ä¸­...</div>
    </div>
  </div>
</div>

<select id="cameraSelect"></select>

<script>
  // ==========================================
  // âš™ï¸ è¨­å®šæª”
  // ==========================================
  const CONFIG = {
    CHECK_MONTHS: [1, 7], 
    GAS_URL: "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec"
  };

  let allRecords = [];
  let qrScanner = null;
  let currentCameraId = null;
  let hideTimer = null;
  const HIDE_DELAY_MS = 1000;

  // ç°¡å–®æ—¥æœŸè™•ç†
  function toDate(val){
    if (!val) return null;
    if (Object.prototype.toString.call(val) === '[object Date]' && !isNaN(val)) return val;
    const s = String(val).trim().slice(0,19).replace(/\//g,'-').replace(' ', 'T');
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  function checkPeriodicStatus(recordDateVal) {
    const recordDate = toDate(recordDateVal);
    if (!recordDate) return { isOk: false, targetStr:"-", recordStr:"-" };
    const now = new Date();
    const sortedMonths = CONFIG.CHECK_MONTHS.sort((a,b) => a-b);
    let targetMonth = sortedMonths[0];
    for (let i = sortedMonths.length - 1; i >= 0; i--) {
        if ((now.getMonth()+1) >= sortedMonths[i]) { targetMonth = sortedMonths[i]; break; }
    }
    return {
        isOk: (recordDate.getFullYear() === now.getFullYear() && (recordDate.getMonth()+1) === targetMonth),
        targetStr: `${now.getFullYear()}/${targetMonth}`,
        recordStr: `${recordDate.getFullYear()}/${recordDate.getMonth()+1}`
    };
  }

  // ==========================================
  // ğŸš€ AR ä½ç½®æ›´æ–° (æ¥µç°¡ç‰ˆ)
  // ==========================================
  function updateARPosition(decodedResult) {
    const loc = decodedResult.result.location; 
    if (!loc) return;

    // ä½¿ç”¨å³ä¸Šè§’
    const point = loc.topRightCorner; 

    const videoEl = document.querySelector("#reader video");
    if (!videoEl) return;

    const videoWidth = videoEl.videoWidth;
    const videoHeight = videoEl.videoHeight;
    const displayWidth = videoEl.offsetWidth;
    const displayHeight = videoEl.offsetHeight;

    // ç¸®æ”¾è¨ˆç®—
    const scale = Math.max(displayWidth / videoWidth, displayHeight / videoHeight);
    const overflowX = (videoWidth * scale - displayWidth) / 2;
    const overflowY = (videoHeight * scale - displayHeight) / 2;

    const screenX = (point.x * scale) - overflowX;
    const screenY = (point.y * scale) - overflowY;

    const tag = document.getElementById("ar-tag");
    
    // ç›´æ¥è¨­å®šä½ç½®ï¼Œä¸é€²è¡Œè¤‡é›œé‹ç®—
    tag.style.left = `${screenX}px`; 
    tag.style.top = `${screenY - 20}px`; // ç¨å¾®å¾€ä¸Šæä¸€é»
    
    tag.style.opacity = 1;

    clearTimeout(hideTimer);
    hideTimer = setTimeout(() => {
      tag.style.opacity = 0;
    }, HIDE_DELAY_MS);
  }

  // ==========================================
  // ğŸ“‹ å…§å®¹æ›´æ–°
  // ==========================================
  function updateTagContent(carId) {
    const contentEl = document.getElementById("tagContent");
    const matches = allRecords.filter(r => r.carId === carId).sort((a,b)=>new Date(b.time)-new Date(a.time));
    const result = matches[0];

    if (!result) {
      contentEl.innerHTML = `
        <div class="tag-header"><span class="tag-id">${carId}</span><span class="status-ng">ç„¡è³‡æ–™</span></div>
        <div class="tag-row">æŸ¥ç„¡æ­¤å°è»Šç´€éŒ„</div>
      `;
    } else {
      const status = checkPeriodicStatus(result.time);
      const statusText = status.isOk ? `<span class="status-ok">åˆæ ¼</span>` : `<span class="status-ng">æœªæª¢</span>`;
      
      contentEl.innerHTML = `
        <div class="tag-header"><span class="tag-id">${carId}</span>${statusText}</div>
        <div class="tag-row"><span>æ‡‰æª¢:${status.targetStr}</span></div>
        <div class="tag-row"><span>å¯¦æª¢:${status.recordStr}</span></div>
        <div class="tag-row"><span>äººå“¡:${result.workerId || '-'}</span></div>
      `;
    }
  }

  // ==========================================
  // ğŸ“· æ”å½±æ©Ÿå•Ÿå‹• (ä½ç•«è³ªæ¨¡å¼)
  // ==========================================
  async function initCamera() {
    qrScanner = new Html5Qrcode("reader");
    const devices = await Html5Qrcode.getCameras();
    
    if (devices && devices.length) {
      currentCameraId = devices[devices.length-1].id;
      
      const config = {
        fps: 10, // é™ä½ FPSï¼Œæ¸›å°‘ CPU è² æ“”
        qrbox: { width: 180, height: 180 }, // ç¸®å°æƒææ¡†
        aspectRatio: window.innerHeight / window.innerWidth,
        videoConstraints: {
          // [æ•ˆèƒ½é—œéµ] å¼·åˆ¶ä½¿ç”¨æ¥µä½è§£æåº¦ 320x240 (QVGA)
          width:  { ideal: 320 }, 
          height: { ideal: 240 },
          facingMode: "environment"
        }
      };

      await qrScanner.start(
        currentCameraId,
        config,
        (decodedText, decodedResult) => {
          updateARPosition(decodedResult);
          if (document.getElementById("tagContent").dataset.lastId !== decodedText) {
             document.getElementById("tagContent").dataset.lastId = decodedText;
             updateTagContent(decodedText);
             if (navigator.vibrate) navigator.vibrate(50);
          }
        },
        (error) => {}
      );
    } else {
      alert("ç„¡æ”å½±æ©Ÿ");
    }
  }

  // ==========================================
  // ğŸš€ å•Ÿå‹•
  // ==========================================
  async function preload() {
    const today = new Date().toISOString().split('T')[0];
    const past = new Date(); past.setMonth(past.getMonth()-18);
    const from = past.toISOString().split('T')[0];

    try {
      const res = await fetch(`${CONFIG.GAS_URL}?mode=list&from=${from}&until=${today}`);
      const data = await res.json();
      allRecords = data.records || [];
      document.getElementById("tagContent").innerHTML = '<div>è«‹æƒæ...</div>';
      await initCamera();
    } catch(e) {
      document.getElementById("debug-fps").innerText = "è³‡æ–™é€£ç·šå¤±æ•—";
    }
  }

  preload();

</script>
</body>
</html>
