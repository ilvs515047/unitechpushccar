<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>UTå°è»Š AR é»æª¢ç³»çµ± v2</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; position: relative; width: 100vw; height: 100vh; }
    #reader { width: 100%; height: 100%; }
    /* è®“å½±ç‰‡å¡«æ»¿å…¨è¢å¹• */
    #reader video { object-fit: cover !important; width: 100% !important; height: 100% !important; }

    /* AR è³‡è¨Šå¡ */
    .ar-card {
      position: absolute;
      background: rgba(255, 255, 255, 0.92);
      border-left: 5px solid #007bff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      width: 180px;
      z-index: 9999;
      pointer-events: none; /* é¿å…æ“‹ä½è§¸æ§ */
      display: none; 
      transition: transform 0.1s linear; /* å¹³æ»‘è·Ÿéš¨ */
    }

    .status-ok { color: #16a34a; font-weight: bold; }
    .status-ng { color: #dc2626; font-weight: bold; }
    .ar-info { font-size: 11px; color: #555; margin-top: 4px; }

    #loadingOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div>ğŸ“¡ è³‡æ–™åº«åŒæ­¥ä¸­...</div>
</div>

<div id="reader"></div>

<div id="infoCard" class="ar-card">
    <div id="ar-carId" style="font-size: 12px; color: #666;"></div>
    <div id="ar-status"></div>
    <div id="ar-date" class="ar-info"></div>
</div>

<script>
  const CONFIG = {
    CHECK_MONTHS: [1, 7],
    GAS_URL: "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec"
  };

  let allRecords = [];
  const infoCard = document.getElementById('infoCard');
  const html5QrCode = new Html5Qrcode("reader");

  // ç‹€æ…‹åˆ¤æ–·é‚è¼¯
  function getCarStatus(carId) {
    const matches = allRecords.filter(r => r.carId === carId).sort((a,b)=>new Date(b.time)-new Date(a.time));
    if (matches.length === 0) return { isOk: false, date: "ç„¡è³‡æ–™", msg: "âŒ å°šæœªé»æª¢" };

    const lastDate = new Date(matches[0].time);
    const now = new Date();
    const curMonth = now.getMonth() + 1;
    
    const sortedMonths = CONFIG.CHECK_MONTHS.sort((a,b) => a-b);
    let targetMonth = sortedMonths[0];
    for (let i = sortedMonths.length - 1; i >= 0; i--) {
        if (curMonth >= sortedMonths[i]) { targetMonth = sortedMonths[i]; break; }
    }

    const isOk = (lastDate.getFullYear() === now.getFullYear() && (lastDate.getMonth() + 1) === targetMonth);
    return { isOk, date: matches[0].time, msg: isOk ? "âœ… æœ¬æœŸåˆæ ¼" : "âš ï¸ éæœ¬æœŸç´€éŒ„" };
  }

  const onScanSuccess = (decodedText, decodedResult) => {
    // é—œéµä¿®æ­£ï¼šå¾ decodedResult.region ç²å– QR Code çš„åº§æ¨™ç¯„åœ
    const region = decodedResult.region;
    if (region && region.bbox) {
        const { x, y, width, height } = region.bbox;
        
        // æ›´æ–°å…§å®¹
        const status = getCarStatus(decodedText);
        document.getElementById('ar-carId').innerText = "ç·¨è™Ÿ: " + decodedText;
        document.getElementById('ar-status').innerText = status.msg;
        document.getElementById('ar-status').className = status.isOk ? 'status-ok' : 'status-ng';
        document.getElementById('ar-date').innerText = "æ—¥æœŸ: " + status.date;

        // è¨ˆç®—ä½ç½® (å°‡å¡ç‰‡æ”¾åœ¨ QR Code çš„ä¸Šæ–¹)
        // æ³¨æ„ï¼šé€™è£¡çš„åæ¨™æ˜¯ç›¸å°æ–¼ video å…ƒç´ çš„åŸå§‹åƒç´ ï¼Œéœ€æ›ç®—æˆè¢å¹•ç™¾åˆ†æ¯”æˆ–ç›´æ¥ä½¿ç”¨
        const displayX = (x / region.canvasWidth) * window.innerWidth;
        const displayY = (y / region.canvasHeight) * window.innerHeight;

        infoCard.style.display = 'block';
        infoCard.style.left = `0px`;
        infoCard.style.top = `0px`;
        infoCard.style.transform = `translate(${displayX}px, ${displayY - 100}px)`;

        // åµæ¸¬åœé “æ¶ˆå¤±
        clearTimeout(window.arTimer);
        window.arTimer = setTimeout(() => {
            infoCard.style.display = 'none';
        }, 1500);
    }
  };

  async function init() {
    try {
      // 1. å…ˆæŠ“è³‡æ–™
      const res = await fetch(`${CONFIG.GAS_URL}?mode=list`);
      const data = await res.json();
      allRecords = data.records || [];
      document.getElementById('loadingOverlay').style.display = 'none';

      // 2. å•Ÿå‹•ç›¸æ©Ÿ (èª¿æ•´åƒæ•¸ä»¥åˆ© AR è¿½è¹¤)
      const config = { 
        fps: 20,          // æé«˜å¹€ç‡è®“è¿½è¹¤æ›´é †
        qrbox: (w, h) => { return { width: w*0.8, height: h*0.8 } },
        aspectRatio: 1.0  // å¼·åˆ¶æ¯”ä¾‹ä¸€è‡´
      };

      await html5QrCode.start(
        { facingMode: "environment" }, 
        config,
        onScanSuccess
      );
    } catch (e) {
      console.error(e);
      document.getElementById('loadingOverlay').innerText = "éŒ¯èª¤: " + e;
    }
  }

  init();
</script>
</body>
</html>
