<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>台車點檢系統</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <h2>台車點檢系統</h2>
  <label>選擇模式：</label>
  <select id="mode">
    <option value="checkin">✅ 我要點檢</option>
    <option value="lookup">🔍 查詢是否已點檢</option>
  </select>
  <br><br>
  <label>點檢人員姓名：</label>
  <input type="text" id="username" placeholder="請輸入姓名（查詢可空白）">
  <div id="reader" style="width:300px; margin-top:20px;"></div>
  <p id="result" style="font-weight:bold;"></p>
  <script>
    const reader = new Html5Qrcode("reader");
    const resultEl = document.getElementById("result");
    
    // ✅ 啟動相機掃描器
    function startScanner() {
      reader.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText, decodedResult) => {
          console.log("✅ 掃描成功：", decodedText);
          reader.pause(); // 暫停攝影機，避免重複掃描
          sendToServer(decodedText);
        },
        err => {
          // 你可以顯示錯誤或忽略
        }
      ).catch(err => {
        console.error("🚨 無法啟動攝影機：", err);
        alert("⚠️ 無法啟動相機，請確認已允許瀏覽器權限");
      });
    }
    startScanner(); // 一開始就啟動
    
    // ✅ 發送資料給 GAS (修正版)
    function sendToServer(qrData) {
      const mode = document.getElementById("mode").value;
      const user = document.getElementById("username").value;
      
      if (!qrData) {
        alert("⚠️ QR code 為空！");
        reader.resume(); return;
      }
      if (mode === 'checkin' && !user.trim()) {
        alert("❌ 點檢時請輸入姓名！");
        reader.resume(); return;
      }

      // 顯示處理中
      resultEl.innerText = "📤 處理中...";
      
      // 替換成您的新部署 URL
      const GAS_URL = "https://script.google.com/macros/s/AKfycbziUzozOkRFDxOiYEVBatznlFcSqNup1wJAPrJckRtMP8T0jVzmJwf2IvCDCEDrpBSw/exec";
      
      fetch(GAS_URL, {
        method: "POST",
        mode: "cors", // 明確指定 CORS 模式
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          mode: mode,
          carId: qrData,
          user: user
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.text();
      })
      .then(txt => {
        console.log("📥 伺服器回應：", txt);
        resultEl.innerText = `📋 ${qrData} → ${txt}`;
        setTimeout(() => {
          reader.resume(); // 2 秒後恢復掃描
          resultEl.innerText = ""; // 清除顯示
        }, 2000);
      })
      .catch(err => {
        console.error("❌ 發送失敗：", err);
        resultEl.innerText = "❌ 發送失敗";
        alert("🚨 無法送出資料，請確認網路與權限！詳細錯誤：" + err.message);
        setTimeout(() => {
          reader.resume(); // 發生錯誤也要恢復掃描
          resultEl.innerText = ""; // 清除顯示
        }, 2000);
      });
    }
  </script>
</body>
</html>
