<!doctype html>
<meta charset="utf-8" />
<title>UT 台車點檢模擬器（批次 + 同波間隔 + 文字帶入台車編號）</title>
<style>
  body{font-family:system-ui,"Microsoft JhengHei",sans-serif;max-width:980px;margin:24px auto;padding:0 16px;background:#f7f7f8}
  h2{margin:0 0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{display:block;font-size:14px;color:#333}
  input,select,button{padding:8px 10px;font-size:14px}
  input[type="number"]{width:140px}
  #log{white-space:pre-wrap;background:#0f1115;color:#e6e6eb;padding:12px;border-radius:10px;height:300px;overflow:auto}
  .ok{color:#7ee787}.err{color:#ff7b72}.warn{color:#f1e05a}
  .card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:14px;margin:12px 0}
  .muted{opacity:.8}
  button{border:0;border-radius:10px;cursor:pointer}
  #start{background:#2ea043;color:#fff}
  #stop{background:#6e7681;color:#fff}
</style>

<h2>UT 台車點檢模擬器（批次 + 同波間隔 + 文字帶入台車編號）</h2>

<div class="card">
  <label>GAS 端點</label>
  <input id="endpoint" style="width:100%"
    value="https://script.google.com/macros/s/AKfycbyfVxeSGcLO1uLgorrkWPF6VesOijY7b6lolRbAXMc7I2DTA-ez3YtkFFHqVevOk6lG/exec" />
</div>

<div class="card">
  <div class="row">
    <div>
      <label>波與波之間間隔（毫秒）</label>
      <input id="interval" type="number" value="1000" min="0" />
    </div>
    <div>
      <label>抖動（±%）</label>
      <input id="jitter" type="number" value="10" min="0" max="80" />
    </div>
    <div>
      <label>每波筆數（Batch Size）</label>
      <input id="batchSize" type="number" value="3" min="1" />
    </div>
    <div>
      <label>同波內相鄰筆間隔（毫秒）</label>
      <input id="intraDelay" type="number" value="500" min="0" />
    </div>
    <div>
      <label>台車數量</label>
      <input id="cartCount" type="number" value="5" min="1" />
    </div>
  </div>

  <div class="row" style="margin-top:8px">
    <div>
      <label>送出模式</label>
      <select id="mode">
        <option value="seq">依序（T001→T002→…）</option>
        <option value="rand">隨機</option>
      </select>
    </div>
    <div>
      <label>異常機率（0~1）</label>
      <input id="pAbn" type="number" step="0.01" value="0.15" min="0" max="1" />
    </div>
    <div>
      <label>工號前綴</label>
      <input id="empPrefix" value="E" />
    </div>
    <div>
      <label>工號範圍（100~999）</label>
      <input id="empMin" type="number" value="100" />
      <input id="empMax" type="number" value="999" />
    </div>
    <div>
      <label>台車前綴</label>
      <input id="cartPrefix" value="T" />
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <button id="start">開始</button>
    <button id="stop">停止</button>
    <span id="status" class="muted">狀態：待機</span>
  </div>
</div>

<h3>Log</h3>
<div id="log"></div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  let timer = null, carts = [], idx = 0, running = false;

  const ITEMS = [
    ["f1","f1_ok"],
    ["f2","f2_ok"],
    ["f3","f3_ok"],
    ["b1","b1_ok"],
    ["b2","b2_ok"],
    ["b3","b3_ok"],
    ["frame","frame_ok"]
  ];

  function buildCarts(n, prefix="T"){
    carts = Array.from({length:n}, (_,i)=> `${prefix}${String(i+1).padStart(3,'0')}`);
    idx = 0;
  }
  function pickCart(mode){
    if (mode === "rand") return carts[Math.floor(Math.random()*carts.length)];
    const v = carts[idx % carts.length]; idx++; return v;
  }
  function rndInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function delay(ms){ return new Promise(r => setTimeout(r, ms)); }
  function jittered(ms, pct){
    const d = ms * (pct/100);
    return Math.max(0, Math.round(ms + (Math.random()*2 - 1) * d));
  }

  // 產生 payload：所有文字欄都帶上「【carId】…」
  function mkPayload(carId, pAbn){
    const abnormal = Math.random() < pAbn;
    const obj = {
      mode: "checkin_detail",
      carId,
      workerId: `${$('empPrefix').value || 'E'}${rndInt(parseInt($('empMin').value||'100',10), parseInt($('empMax').value||'999',10))}`
    };
    for (const [textKey, okKey] of ITEMS) {
      if (abnormal && Math.random() < 0.4) {
        // 異常：寫明異常 + 當下台車編號，不勾 ok
        obj[textKey] = `【${carId}】異常：需檢修`;
      } else {
        // 正常：也寫入台車編號，並勾 ok=on
        obj[textKey] = `【${carId}】無異常`;
        obj[okKey]   = "on";
      }
    }
    return obj;
  }

  function toQuery(params){
    return Object.entries(params).map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
  }

  const TIMEOUT_MS = 20000;
  const controllers = new Set();

  async function fetchWithTimeout(url, options={}, timeout=TIMEOUT_MS){
    const ctrl = new AbortController();
    controllers.add(ctrl);
    const id = setTimeout(()=>ctrl.abort(), timeout);
    try {
      return await fetch(url, { ...options, signal: ctrl.signal });
    } finally {
      clearTimeout(id);
      controllers.delete(ctrl);
    }
  }

  async function sendOne(url, carId, pAbn){
    const params = mkPayload(carId, pAbn);
    const full   = `${url}?${toQuery(params)}`;
    try{
      const res = await fetchWithTimeout(full, { method:'GET' });
      const txt = await res.text().catch(()=> '');
      if (res.ok) {
        log(`✅ ${new Date().toISOString()}  car=${carId}  ← ${res.status} ${txt.slice(0,120)}`, 'ok');
      } else {
        log(`⚠️ ${new Date().toISOString()}  ${res.status} ${txt.slice(0,140)}`, 'warn');
      }
    }catch(e){
      log(`❌ ${new Date().toISOString()}  ${e}`, 'err');
    }
  }

  // 批次 + 同波內間隔
  async function tickBatch(){
    if (!running) return;

    const base     = parseInt($('interval').value || '1000',10);
    const jt       = parseInt($('jitter').value   || '0',10);
    const url      = $('endpoint').value.trim();
    const mode     = $('mode').value;
    const pAbn     = parseFloat($('pAbn').value || '0');
    const batchSz  = Math.max(1, parseInt($('batchSize').value || '1',10));
    const intra    = Math.max(0, parseInt($('intraDelay').value || '0',10));

    if (!url) { log('❗ 請填入 GAS 端點'); stop(); return; }

    const currentBatchId = Date.now(); // 若日後要回推，可加在 payload（此版本先不帶）

    for (let k = 0; k < batchSz; k++) {
      if (!running) break;
      const carId = pickCart(mode);
      sendOne(url, carId, pAbn);
      if (k < batchSz - 1) await delay(intra);
    }

    timer = setTimeout(tickBatch, jittered(base, jt));
  }

  function start(){
    if (running) return;
    buildCarts(parseInt($('cartCount').value || '5',10), $('cartPrefix').value || 'T');
    $('status').textContent = '狀態：執行中…';
    log('--- start ---');
    running = true;
    tickBatch();
  }

  function stop(){
    running = false;
    if (timer) clearTimeout(timer);
    timer = null;
    controllers.forEach(c => { try { c.abort(); } catch(_){} });
    controllers.clear();
    $('status').textContent = '狀態：待機';
    log('--- stop ---');
  }

  function log(s, cls){
    const el = $('log');
    const span = document.createElement('span');
    if (cls) span.className = cls;
    span.textContent = s + '\n';
    el.appendChild(span);
    el.scrollTop = el.scrollHeight;
  }

  $('start').onclick = start;
  $('stop').onclick  = stop;
})();
</script>
