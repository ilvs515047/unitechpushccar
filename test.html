<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å°è»Šé»æª¢ç³»çµ±</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h2>å°è»Šé»æª¢ç³»çµ±</h2>
  <div id="reader" style="width:300px;"></div>
  <p id="carIdDisplay" style="font-weight:bold; margin-top:10px;"></p>

  <button onclick="lookupRecord()">ğŸ” æŸ¥è©¢</button>
  <button onclick="checkinRecord()">âœ… é»æª¢</button>
  <p id="result" style="margin-top: 10px; font-weight:bold;"></p>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwfpGrT8eMmmN5RS-_NAskcuirU7cuqE7v2DulGMyS_lF1U05Pg7-QxtYIxPrH9ScC2/exec";
    let scannedCarId = "";

    // å•Ÿç”¨ QR Code æƒæå™¨
    const qrScanner = new Html5Qrcode("reader");
    qrScanner.start(
      { facingMode: "environment" },  // å¾Œé¡é ­
      { fps: 10, qrbox: 250 },
      qrCodeMessage => {
        scannedCarId = qrCodeMessage;
        document.getElementById("carIdDisplay").innerText = `ğŸ“· æ­¤ç‚ºç·¨è™Ÿï¼šã€Œ${scannedCarId}ã€çš„å°è»Š`;
        qrScanner.stop(); // æƒå®Œåœæ‰
      },
      errorMessage => {
        // å¯ä»¥å¿½ç•¥æƒæéŒ¯èª¤
      }
    ).catch(err => {
      document.getElementById("carIdDisplay").innerText = "âŒ ç„¡æ³•å•Ÿç”¨æ”å½±æ©Ÿï¼š" + err;
    });

    // æŸ¥è©¢æœ€è¿‘é»æª¢ç´€éŒ„
    function lookupRecord() {
      if (!scannedCarId) {
        alert("è«‹å…ˆæƒæå°è»Š QR Codeï¼");
        return;
      }

      const url = new URL(GAS_URL);
      url.searchParams.append("mode", "lookup");
      url.searchParams.append("carId", scannedCarId);

      fetch(url)
        .then(res => res.text())
        .then(txt => {
          document.getElementById("result").innerText = txt;
        })
        .catch(err => {
          document.getElementById("result").innerText = "âŒ æŸ¥è©¢å¤±æ•—ï¼š" + err.message;
        });
    }

    // é»æª¢ä¸¦å¡«å¯«ç•°éŸ³ç‹€æ³
    function checkinRecord() {
      if (!scannedCarId) {
        alert("è«‹å…ˆæƒæå°è»Š QR Codeï¼");
        return;
      }

      const noise = prompt("è«‹è¼¸å…¥æ˜¯å¦æœ‰ç•°éŸ³ï¼Ÿï¼ˆä¾‹å¦‚ï¼šç„¡ã€æœ‰ç•°éŸ³ï¼‰");
      if (noise === null || noise.trim() === "") {
        alert("æœªå¡«å¯«ç•°éŸ³æƒ…æ³ï¼Œå·²å–æ¶ˆé»æª¢");
        return;
      }

      const url = new URL(GAS_URL);
      url.searchParams.append("mode", "checkin");
      url.searchParams.append("carId", scannedCarId);
      url.searchParams.append("noise", noise.trim());

      fetch(url)
        .then(res => res.text())
        .then(txt => {
          document.getElementById("result").innerText = txt;
        })
        .catch(err => {
          document.getElementById("result").innerText = "âŒ é»æª¢å¤±æ•—ï¼š" + err.message;
        });
    }
  </script>
</body>
</html>
