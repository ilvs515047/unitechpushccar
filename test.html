<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UT 台車點檢表單</title>
  <script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwwA7ZiTNgYCfpN4O5VTLTgGDoN5ZsFupcLjQKsoOMAvJu3lwkQnLDkvFypjNCKpfPh/exec";
  let scannedCarId = "";
  const qrScanner = new Html5Qrcode("reader");
  let currentCameraId = null;

  // ===== 佇列與重試邏輯（新增） =====
  const requestQueue = [];
  let isProcessing = false;

  const MAX_RETRIES = 3;
  const BASE_DELAY = 400;   // ms
  const TIMEOUT_MS = 10000; // 單次請求逾時

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
  function jitter(ms){ return ms + Math.floor(Math.random() * 150); }

  async function fetchWithTimeout(url, options = {}, timeout = TIMEOUT_MS) {
    const ctrl = new AbortController();
    const id = setTimeout(() => ctrl.abort(), timeout);
    try {
      const res = await fetch(url, { ...options, signal: ctrl.signal });
      return res;
    } finally {
      clearTimeout(id);
    }
  }

  async function trySendOnce(paramsObj) {
    const url = GAS_URL + "?" + new URLSearchParams(paramsObj);
    const res = await fetchWithTimeout(url, { method: "GET" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const txt = await res.text();
    return txt;
  }

  async function sendWithRetry(item) {
    let attempt = 0;
    while (attempt < MAX_RETRIES) {
      try {
        const txt = await trySendOnce(item.params);
        return { ok: true, text: txt };
      } catch (err) {
        attempt++;
        if (attempt >= MAX_RETRIES) return { ok: false, error: err };
        const delay = jitter(BASE_DELAY * Math.pow(2, attempt - 1)); // 400, 800, 1600 +/- jitter
        await sleep(delay);
      }
    }
  }

  async function processQueue() {
    if (isProcessing) return;
    if (requestQueue.length === 0) return;

    isProcessing = true;
    document.getElementById("loadingOverlay").style.display = "flex";

    while (requestQueue.length > 0) {
      const item = requestQueue[0];
      const result = await sendWithRetry(item);

      if (result.ok) {
        document.getElementById("result").innerText = result.text || "✅ 已記錄";
        // 維持你原本成功流程
        item.formEl.reset();
        alert("✅ 點檢成功！");
        document.getElementById("rescanBtn").click();
        requestQueue.shift(); // 移除已成功
      } else {
        // 失敗就回報並丟棄這筆（避免卡住後面的）
        document.getElementById("result").innerText = "❌ 點檢失敗：" + (result.error?.message || "未知錯誤");
        alert("❌ 提交失敗，請檢查網路連線或聯絡管理員。");
        requestQueue.shift();
      }
    }

    document.getElementById("loadingOverlay").style.display = "none";
    isProcessing = false;
  }

  function enqueueSubmission(params, formEl){
    requestQueue.push({ params, formEl });
    processQueue();
  }
  // ===== 佇列邏輯結束 =====

  async function initCameraOptions() {
    try {
      const devices = await Html5Qrcode.getCameras();
      const cameraSelect = document.getElementById("cameraSelect");
      cameraSelect.innerHTML = "";

      if (devices && devices.length) {
        devices.forEach((device, index) => {
          const option = document.createElement("option");
          option.value = device.id;
          option.text = device.label || `Camera ${index + 1}`;
          cameraSelect.appendChild(option);
        });

        currentCameraId = cameraSelect.value;
        cameraSelect.addEventListener("change", async () => {
          currentCameraId = cameraSelect.value;
          await restartScanner();
        });

        await startScan();
      } else {
        alert("找不到攝影機設備！");
      }
    } catch (err) {
      console.error("初始化攝影機失敗:", err);
      alert("無法存取攝影機，請檢查瀏覽器權限。");
    }
  }

  async function startScan() {
    if (!currentCameraId) return;

    await qrScanner.start(
      currentCameraId,
      {
        fps: 5,
        aspectRatio: 1.333,
        qrbox: { width: 200, height: 200 },
        videoConstraints: {
          width: { ideal: 640 },
          height: { ideal: 480 },
          facingMode: "environment"
        }
      },
      (qrCodeMessage) => {
        scannedCarId = qrCodeMessage.trim();
        document.getElementById("carIdDisplay").innerText = `📷 此為編號：「${scannedCarId}」的台車`;
        qrScanner.stop();
        document.getElementById("reader").style.display = "none";
        document.getElementById("cameraSelect").style.display = "none";
        document.getElementById("checkForm").style.display = "block";
        document.getElementById("rescanBtn").style.display = "block";
      },
      (errorMessage) => {
        // 可選擇忽略錯誤
      }
    );
  }

  async function restartScanner() {
    if (qrScanner && qrScanner.isScanning) {
      await qrScanner.stop();
    }
    await startScan();
  }

  document.getElementById("rescanBtn").addEventListener("click", async () => {
    document.getElementById("checkForm").style.display = "none";
    document.getElementById("checkForm").reset();
    document.getElementById("result").innerText = "";
    document.getElementById("carIdDisplay").innerText = "📷 等待重新掃描 QR Code...";
    document.getElementById("rescanBtn").style.display = "none";
    document.getElementById("reader").style.display = "block";
    document.getElementById("cameraSelect").style.display = "block";
    await restartScanner();
  });

  document.getElementById("checkForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const workerIdInput = document.querySelector('input[name="workerId"]');
    if (!workerIdInput.value.trim()) {
      alert("⚠️ 請填寫點檢人員工號！");
      workerIdInput.focus();
      return;
    }

    const requiredPairs = [
      ["f1", "f1_ok"], ["f2", "f2_ok"], ["f3", "f3_ok"],
      ["b1", "b1_ok"], ["b2", "b2_ok"], ["b3", "b3_ok"],
      ["frame", "frame_ok"]
    ];

    const formData = new FormData(this);
    let allValid = true;

    for (const [textName, checkName] of requiredPairs) {
      const textVal = formData.get(textName)?.trim();
      const checkboxVal = formData.get(checkName);
      if (!textVal && !checkboxVal) {
        allValid = false;
        break;
      }
    }

    if (!allValid) {
      alert("⚠️ 所有檢查項目都必須填寫文字或勾選「無異常」！");
      return;
    }

    const data = {
      mode: "checkin_detail",
      carId: scannedCarId,
      workerId: formData.get("workerId")?.trim() || ""
    };

    for (const [key, val] of formData.entries()) {
      if (key !== "workerId") {
        // 維持你原設計：沒填就是空字串；checkbox 有值就帶值
        data[key] = val || "";
      }
    }

    // 進入佇列，由佇列統一處理送出與重試
    enqueueSubmission(data, this);
    // 顯示 overlay 交給 processQueue 控制
  });

  initCameraOptions();
</script>


</body>
</html>
