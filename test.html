<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>UT å°è»Šé»æª¢è¡¨å–®</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .section { margin-bottom: 20px; }
    label { display: block; margin-top: 10px; }
    input[type="text"] { width: 100%; padding: 4px; margin-top: 4px; }
  </style>
</head>
<body>
  <h2>UTå°è»Šé»æª¢ç³»çµ±ï¼ˆé»æª¢ç«¯ï¼‰</h2>
  <div id="reader" style="width:300px;"></div>
  <p id="carIdDisplay" style="font-weight:bold;"></p>

  <form id="checkForm" style="display:none;">
    <div class="section"><strong>ğŸ”§ å‰è¼ªï¼ˆè½‰å‘è¼ªï¼‰</strong>
      <label>1. è»Šæ¶&éµç‰‡å¹³å°ç„Šæ¥å¤šå°‘% <input type="text" name="f1"></label>
      <label><input type="checkbox" name="f1_ok"> ç„¡ç•°å¸¸</label>

      <label>2. éµç‰‡å¹³å°&è»Šè¼ªæ˜¯å¦ç•°å¸¸ <input type="text" name="f2"></label>
      <label><input type="checkbox" name="f2_ok"> ç„¡ç•°å¸¸</label>

      <label>3. è»Šè¼ª/ç…è»Šæè¿° <input type="text" name="f3"></label>
      <label><input type="checkbox" name="f3_ok"> ç„¡ç•°å¸¸</label>
    </div>

    <div class="section"><strong>ğŸ”§ å¾Œè¼ªï¼ˆæ‰‹æŠŠç«¯ï¼‰</strong>
      <label>1. è»Šæ¶&éµç‰‡å¹³å°ç„Šæ¥å¤šå°‘% <input type="text" name="b1"></label>
      <label><input type="checkbox" name="b1_ok"> ç„¡ç•°å¸¸</label>

      <label>2. éµç‰‡å¹³å°&è»Šè¼ªæ˜¯å¦ç•°å¸¸ <input type="text" name="b2"></label>
      <label><input type="checkbox" name="b2_ok"> ç„¡ç•°å¸¸</label>

      <label>3. è»Šè¼ª/ç…è»Šæè¿° <input type="text" name="b3"></label>
      <label><input type="checkbox" name="b3_ok"> ç„¡ç•°å¸¸</label>
    </div>

    <div class="section"><strong>ğŸ”§ è»Šæ¶/éª¨æ¶æ¥ç¸«è™•</strong>
      <label>æè¿°ç‹€æ³ <input type="text" name="frame"></label>
      <label><input type="checkbox" name="frame_ok"> ç„¡ç•°å¸¸</label>
    </div>

    <button type="submit">âœ… æäº¤é»æª¢</button>
  </form>

  <p id="result" style="font-weight:bold; margin-top:20px;"></p>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyXV5ac5j1WVTLKhFdBzMOICnNQAkfwdpKUENj9L1LcAfgxi8xT3c6QLIdRHed7LARv/exec";
    let scannedCarId = "";


  const qrScanner = new Html5Qrcode("reader");
  qrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qrCodeMessage => {
      scannedCarId = qrCodeMessage;
      document.getElementById("carIdDisplay").innerText = `ğŸ“· æ­¤ç‚ºç·¨è™Ÿï¼šã€Œ${scannedCarId}ã€çš„å°è»Š`;
      qrScanner.stop();
      document.getElementById("checkForm").style.display = "block";
    },
    errorMessage => {}
  ).catch(err => {
    document.getElementById("carIdDisplay").innerText = "âŒ ç„¡æ³•å•Ÿç”¨æ”å½±æ©Ÿï¼š" + err;
  });

  document.getElementById("checkForm").addEventListener("submit", function(e) {
  e.preventDefault();

  const requiredFields = [
    "f1", "f1_ok", "f2", "f2_ok", "f3", "f3_ok",
    "b1", "b1_ok", "b2", "b2_ok", "b3", "b3_ok",
    "frame", "frame_ok"
  ];

  const formData = new FormData(this);
  let allValid = true;

  // æ¯ä¸€çµ„ï¼ˆæ–‡å­— + å‹¾é¸ï¼‰éƒ½è¦è‡³å°‘å¡«å…¶ä¸­ä¸€å€‹
  for (let i = 0; i < requiredFields.length; i += 2) {
    const textVal = formData.get(requiredFields[i])?.trim();
    const checkboxVal = formData.get(requiredFields[i + 1]);
    if (!textVal && !checkboxVal) {
      allValid = false;
      break;
    }
  }

  if (!allValid) {
    alert("âš ï¸ æ‰€æœ‰æª¢æŸ¥é …ç›®éƒ½å¿…é ˆå¡«å¯«æ–‡å­—æˆ–å‹¾é¸ç„¡ç•°å¸¸ï¼");
    return;
  }

  // æº–å‚™é€å‡ºè³‡æ–™
  const data = {
    mode: "checkin_detail",
    carId: scannedCarId
  };

  for (const [key, val] of formData.entries()) {
    data[key] = val || "";
  }

  fetch(GAS_URL + "?" + new URLSearchParams(data))
    .then(res => res.text())
    .then(txt => {
      document.getElementById("result").innerText = txt;
      this.reset();
      alert("âœ… é»æª¢æˆåŠŸï¼");
    })
    .catch(err => {
      document.getElementById("result").innerText = "âŒ é»æª¢å¤±æ•—ï¼š" + err.message;
    });
});

</script>
</body>
</html>
