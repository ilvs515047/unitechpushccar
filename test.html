<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>台車點檢系統</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h2>台車點檢系統</h2>
  <div id="reader" style="width:300px;"></div>
  <p id="carIdDisplay" style="font-weight:bold; margin-top:10px;"></p>

  <button onclick="lookupRecord()">🔍 查詢</button>
  <button onclick="checkinRecord()">✅ 點檢</button>
  <p id="result" style="margin-top: 10px; font-weight:bold;"></p>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwfpGrT8eMmmN5RS-_NAskcuirU7cuqE7v2DulGMyS_lF1U05Pg7-QxtYIxPrH9ScC2/exec";
    let scannedCarId = "";

    // 啟用 QR Code 掃描器
    const qrScanner = new Html5Qrcode("reader");
    qrScanner.start(
      { facingMode: "environment" },  // 後鏡頭
      { fps: 10, qrbox: 250 },
      qrCodeMessage => {
        scannedCarId = qrCodeMessage;
        document.getElementById("carIdDisplay").innerText = `📷 此為編號：「${scannedCarId}」的台車`;
        qrScanner.stop(); // 掃完停掉
      },
      errorMessage => {
        // 可以忽略掃描錯誤
      }
    ).catch(err => {
      document.getElementById("carIdDisplay").innerText = "❌ 無法啟用攝影機：" + err;
    });

    // 查詢最近點檢紀錄
    function lookupRecord() {
      if (!scannedCarId) {
        alert("請先掃描台車 QR Code！");
        return;
      }

      const url = new URL(GAS_URL);
      url.searchParams.append("mode", "lookup");
      url.searchParams.append("carId", scannedCarId);

      fetch(url)
        .then(res => res.text())
        .then(txt => {
          document.getElementById("result").innerText = txt;
        })
        .catch(err => {
          document.getElementById("result").innerText = "❌ 查詢失敗：" + err.message;
        });
    }

    // 點檢並填寫異音狀況
    function checkinRecord() {
      if (!scannedCarId) {
        alert("請先掃描台車 QR Code！");
        return;
      }

      const noise = prompt("請輸入是否有異音？（例如：無、有異音）");
      if (noise === null || noise.trim() === "") {
        alert("未填寫異音情況，已取消點檢");
        return;
      }

      const url = new URL(GAS_URL);
      url.searchParams.append("mode", "checkin");
      url.searchParams.append("carId", scannedCarId);
      url.searchParams.append("noise", noise.trim());

      fetch(url)
        .then(res => res.text())
        .then(txt => {
          document.getElementById("result").innerText = txt;
        })
        .catch(err => {
          document.getElementById("result").innerText = "❌ 點檢失敗：" + err.message;
        });
    }
  </script>
</body>
</html>
