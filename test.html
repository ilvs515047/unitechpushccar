<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UT å°è»Šé»æª¢è¡¨å–®</title>
  <script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwwA7ZiTNgYCfpN4O5VTLTgGDoN5ZsFupcLjQKsoOMAvJu3lwkQnLDkvFypjNCKpfPh/exec";
  let scannedCarId = "";
  const qrScanner = new Html5Qrcode("reader");
  let currentCameraId = null;

  // ===== ä½‡åˆ—èˆ‡é‡è©¦é‚è¼¯ï¼ˆæ–°å¢ï¼‰ =====
  const requestQueue = [];
  let isProcessing = false;

  const MAX_RETRIES = 3;
  const BASE_DELAY = 400;   // ms
  const TIMEOUT_MS = 10000; // å–®æ¬¡è«‹æ±‚é€¾æ™‚

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
  function jitter(ms){ return ms + Math.floor(Math.random() * 150); }

  async function fetchWithTimeout(url, options = {}, timeout = TIMEOUT_MS) {
    const ctrl = new AbortController();
    const id = setTimeout(() => ctrl.abort(), timeout);
    try {
      const res = await fetch(url, { ...options, signal: ctrl.signal });
      return res;
    } finally {
      clearTimeout(id);
    }
  }

  async function trySendOnce(paramsObj) {
    const url = GAS_URL + "?" + new URLSearchParams(paramsObj);
    const res = await fetchWithTimeout(url, { method: "GET" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const txt = await res.text();
    return txt;
  }

  async function sendWithRetry(item) {
    let attempt = 0;
    while (attempt < MAX_RETRIES) {
      try {
        const txt = await trySendOnce(item.params);
        return { ok: true, text: txt };
      } catch (err) {
        attempt++;
        if (attempt >= MAX_RETRIES) return { ok: false, error: err };
        const delay = jitter(BASE_DELAY * Math.pow(2, attempt - 1)); // 400, 800, 1600 +/- jitter
        await sleep(delay);
      }
    }
  }

  async function processQueue() {
    if (isProcessing) return;
    if (requestQueue.length === 0) return;

    isProcessing = true;
    document.getElementById("loadingOverlay").style.display = "flex";

    while (requestQueue.length > 0) {
      const item = requestQueue[0];
      const result = await sendWithRetry(item);

      if (result.ok) {
        document.getElementById("result").innerText = result.text || "âœ… å·²è¨˜éŒ„";
        // ç¶­æŒä½ åŸæœ¬æˆåŠŸæµç¨‹
        item.formEl.reset();
        alert("âœ… é»æª¢æˆåŠŸï¼");
        document.getElementById("rescanBtn").click();
        requestQueue.shift(); // ç§»é™¤å·²æˆåŠŸ
      } else {
        // å¤±æ•—å°±å›å ±ä¸¦ä¸Ÿæ£„é€™ç­†ï¼ˆé¿å…å¡ä½å¾Œé¢çš„ï¼‰
        document.getElementById("result").innerText = "âŒ é»æª¢å¤±æ•—ï¼š" + (result.error?.message || "æœªçŸ¥éŒ¯èª¤");
        alert("âŒ æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯çµ¡ç®¡ç†å“¡ã€‚");
        requestQueue.shift();
      }
    }

    document.getElementById("loadingOverlay").style.display = "none";
    isProcessing = false;
  }

  function enqueueSubmission(params, formEl){
    requestQueue.push({ params, formEl });
    processQueue();
  }
  // ===== ä½‡åˆ—é‚è¼¯çµæŸ =====

  async function initCameraOptions() {
    try {
      const devices = await Html5Qrcode.getCameras();
      const cameraSelect = document.getElementById("cameraSelect");
      cameraSelect.innerHTML = "";

      if (devices && devices.length) {
        devices.forEach((device, index) => {
          const option = document.createElement("option");
          option.value = device.id;
          option.text = device.label || `Camera ${index + 1}`;
          cameraSelect.appendChild(option);
        });

        currentCameraId = cameraSelect.value;
        cameraSelect.addEventListener("change", async () => {
          currentCameraId = cameraSelect.value;
          await restartScanner();
        });

        await startScan();
      } else {
        alert("æ‰¾ä¸åˆ°æ”å½±æ©Ÿè¨­å‚™ï¼");
      }
    } catch (err) {
      console.error("åˆå§‹åŒ–æ”å½±æ©Ÿå¤±æ•—:", err);
      alert("ç„¡æ³•å­˜å–æ”å½±æ©Ÿï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™ã€‚");
    }
  }

  async function startScan() {
    if (!currentCameraId) return;

    await qrScanner.start(
      currentCameraId,
      {
        fps: 5,
        aspectRatio: 1.333,
        qrbox: { width: 200, height: 200 },
        videoConstraints: {
          width: { ideal: 640 },
          height: { ideal: 480 },
          facingMode: "environment"
        }
      },
      (qrCodeMessage) => {
        scannedCarId = qrCodeMessage.trim();
        document.getElementById("carIdDisplay").innerText = `ğŸ“· æ­¤ç‚ºç·¨è™Ÿï¼šã€Œ${scannedCarId}ã€çš„å°è»Š`;
        qrScanner.stop();
        document.getElementById("reader").style.display = "none";
        document.getElementById("cameraSelect").style.display = "none";
        document.getElementById("checkForm").style.display = "block";
        document.getElementById("rescanBtn").style.display = "block";
      },
      (errorMessage) => {
        // å¯é¸æ“‡å¿½ç•¥éŒ¯èª¤
      }
    );
  }

  async function restartScanner() {
    if (qrScanner && qrScanner.isScanning) {
      await qrScanner.stop();
    }
    await startScan();
  }

  document.getElementById("rescanBtn").addEventListener("click", async () => {
    document.getElementById("checkForm").style.display = "none";
    document.getElementById("checkForm").reset();
    document.getElementById("result").innerText = "";
    document.getElementById("carIdDisplay").innerText = "ğŸ“· ç­‰å¾…é‡æ–°æƒæ QR Code...";
    document.getElementById("rescanBtn").style.display = "none";
    document.getElementById("reader").style.display = "block";
    document.getElementById("cameraSelect").style.display = "block";
    await restartScanner();
  });

  document.getElementById("checkForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const workerIdInput = document.querySelector('input[name="workerId"]');
    if (!workerIdInput.value.trim()) {
      alert("âš ï¸ è«‹å¡«å¯«é»æª¢äººå“¡å·¥è™Ÿï¼");
      workerIdInput.focus();
      return;
    }

    const requiredPairs = [
      ["f1", "f1_ok"], ["f2", "f2_ok"], ["f3", "f3_ok"],
      ["b1", "b1_ok"], ["b2", "b2_ok"], ["b3", "b3_ok"],
      ["frame", "frame_ok"]
    ];

    const formData = new FormData(this);
    let allValid = true;

    for (const [textName, checkName] of requiredPairs) {
      const textVal = formData.get(textName)?.trim();
      const checkboxVal = formData.get(checkName);
      if (!textVal && !checkboxVal) {
        allValid = false;
        break;
      }
    }

    if (!allValid) {
      alert("âš ï¸ æ‰€æœ‰æª¢æŸ¥é …ç›®éƒ½å¿…é ˆå¡«å¯«æ–‡å­—æˆ–å‹¾é¸ã€Œç„¡ç•°å¸¸ã€ï¼");
      return;
    }

    const data = {
      mode: "checkin_detail",
      carId: scannedCarId,
      workerId: formData.get("workerId")?.trim() || ""
    };

    for (const [key, val] of formData.entries()) {
      if (key !== "workerId") {
        // ç¶­æŒä½ åŸè¨­è¨ˆï¼šæ²’å¡«å°±æ˜¯ç©ºå­—ä¸²ï¼›checkbox æœ‰å€¼å°±å¸¶å€¼
        data[key] = val || "";
      }
    }

    // é€²å…¥ä½‡åˆ—ï¼Œç”±ä½‡åˆ—çµ±ä¸€è™•ç†é€å‡ºèˆ‡é‡è©¦
    enqueueSubmission(data, this);
    // é¡¯ç¤º overlay äº¤çµ¦ processQueue æ§åˆ¶
  });

  initCameraOptions();
</script>


</body>
</html>
