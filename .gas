function doGet(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("工作表1");
  const mode = e.parameter.mode;

  if (!mode) {
    return ContentService.createTextOutput("❌ 未提供操作模式");
  }

  if (mode === "list") {
    const data = sheet.getDataRange().getValues();
    const headers = ["時間", "台車編號"].concat(data[0].slice(17, 27)); // A, B + R~AA
    headers.push("備註"); // 顯示最右欄
    const rows = data.slice(1).map(row => {
      const time = Utilities.formatDate(new Date(row[0]), "Asia/Taipei", "yyyy-MM-dd HH:mm:ss");
      const record = [time, row[1]].concat(row.slice(17, 27));
      record.push(row[row.length - 1]); // 加上最右欄（備註）
      return record;
    });
    return ContentService.createTextOutput(JSON.stringify({
      headers: headers,
      records: rows
    })).setMimeType(ContentService.MimeType.JSON);
  }

  return ContentService.createTextOutput("⚠️ 未知的操作模式");
}

function doPost(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("工作表1");
  const mode = e.parameter.mode;

  if (mode === "note") {
    const carId = e.parameter.carId;
    const note = e.parameter.note;
    const timestamp = e.parameter.timestamp; // 新增時間欄位識別

    if (!carId || !note || !timestamp) {
      return ContentService.createTextOutput("❌ 缺少 carId、timestamp 或 note");
    }

    const data = sheet.getDataRange().getValues();
    const timeCol = 0;    // 時間欄 A = index 0
    const carIdCol = 1;   // 台車欄 B = index 1
    const noteCol = data[0].length - 1; // 備註為最後一欄

    for (let i = 1; i < data.length; i++) {
      const timeStr = Utilities.formatDate(new Date(data[i][timeCol]), "Asia/Taipei", "yyyy-MM-dd HH:mm:ss");
      if (String(data[i][carIdCol]).trim() === carId.trim() && timeStr === timestamp.trim()) {
        sheet.getRange(i + 1, noteCol + 1).setValue(note);
        return ContentService.createTextOutput("✅ 備註已儲存！");
      }
    }
    return ContentService.createTextOutput("❌ 找不到對應的時間與台車編號紀錄！");
  }

  return ContentService.createTextOutput("⚠️ 未知的操作模式");
}
