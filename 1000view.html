<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UTå°è»Šé»æª¢ç´€éŒ„æŸ¥è©¢ï¼ˆé€±æœŸåˆ¶ï¼‰</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      background-color: #f7f7f7;
      padding: 20px;
      margin: 0;
    }
    h2 { text-align: center; color: #333; }
    #reader { width: 100%; max-width: 320px; margin: 0 auto 20px; }
    #cameraSelect {
      display: none; margin: 0 auto 10px; padding: 6px; font-size: 14px;
      width: 100%; max-width: 320px;
    }
    .status { text-align: center; font-weight: bold; margin-bottom: 10px; }
    .info { text-align: center; font-size: 15px; margin: 8px 0; color: #444; }
    .error { color: red; text-align: center; font-weight: bold; }
    .card {
      background-color: white; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 16px; margin-bottom: 16px;
    }
    .card-title { font-weight: bold; color: #555; margin-bottom: 6px; }
    .card-content { font-size: 15px; color: #222; word-wrap: break-word; }
    button {
      width: 100%; padding: 12px; background-color: #007bff; color: white;
      border: none; font-size: 16px; border-radius: 8px; cursor: pointer; margin-top: 12px;
    }
    button:hover { background-color: #0056b3; }
    #loadingOverlay {
      display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4); color: white; font-size: 20px;
      justify-content: center; align-items: center; z-index: 999;
      text-align:center; padding: 0 16px;
    }

    /* ====== å¾½ç« æ¨£å¼ ====== */
    .badge-wrap { display: flex; justify-content: center; margin: 12px 0 4px; }
    .badge {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 16px 28px; border-radius: 999px;
      font-weight: 700; letter-spacing: .5px; user-select: none;
    }
    .badge svg { width: 18px; height: 18px; }

    .badge-green {
      color: #063b1f;
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 40%, #16a34a 100%);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.9) inset, 0 6px 18px rgba(34,197,94,0.35);
      border: 1px solid rgba(6, 78, 59, 0.25);
      animation: pulseGlowGreen 1.6s infinite ease-in-out;
    }
    .badge-green svg { filter: drop-shadow(0 1px 0 rgba(255,255,255,0.4)); fill:#064e3b; }

    .badge-red {
      color: #7f1d1d;
      background: linear-gradient(135deg, #f87171 0%, #ef4444 40%, #dc2626 100%);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.9) inset, 0 6px 18px rgba(239,68,68,0.35);
      border: 1px solid rgba(127,29,29,0.25);
      animation: pulseGlowRed 1.6s infinite ease-in-out;
    }
    .badge-red svg { filter: drop-shadow(0 1px 0 rgba(255,255,255,0.4)); fill:#7f1d1d; }

    @keyframes pulseGlowGreen {
      0% { transform:scale(1); } 50% { transform:scale(1.03); } 100%{ transform:scale(1); }
    }
    @keyframes pulseGlowRed {
      0% { transform:scale(1); } 50% { transform:scale(1.03); } 100%{ transform:scale(1); }
    }

    .date-row {
      display: flex; flex-direction: column; align-items: center; gap: 8px; margin: 8px 0 12px;
    }
    .rule-info {
        font-size: 12px; color: #888; text-align: center; margin-bottom: 8px;
    }
  </style>
</head>
<body>

<h2>ğŸ“‹ UTç‡¿è¯å°è»Šé»æª¢ç´€éŒ„</h2>
<div class="rule-info">æª¢æŸ¥è¦å‰‡ï¼šå¿…é ˆå®Œæˆç•¶å¹´åº¦ 1æœˆ æˆ– 7æœˆ ä¹‹é»æª¢</div>

<select id="cameraSelect"></select>
<div id="reader"></div>
<p id="carIdDisplay" class="status">ğŸ“· ç­‰å¾…æƒæ QR Code...</p>
<div id="resultArea"></div>
<div id="loadingOverlay">ğŸ‘Œ è³‡æ–™åº«è¼‰å…¥ä¸­ï¼Œè«‹è€å¿ƒç­‰å¾…...</div>

<script>
  // ==========================================
  // âš™ï¸ è¨­å®šæª”å€åŸŸ (åœ¨æ­¤å®šç¾©æª¢æŸ¥æœˆä»½)
  // ==========================================
  const CONFIG = {
    // å®šç¾©é€™ä¸€å¹´ç•¶ä¸­ï¼Œå“ªå¹¾å€‹æœˆä»½æ˜¯ã€Œæª¢æŸ¥æœˆã€
    // æ‚¨æƒ³è¦ 1æœˆ å’Œ 7æœˆï¼Œå°±å¡«å…¥ [1, 7]
    CHECK_MONTHS: [1, 7], 
    
    GAS_URL: "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec"
  };
  // ==========================================

  let allRecords = [];
  let scannedCarId = "";
  let currentCameraId = null;
  const qrScanner = new Html5Qrcode("reader");

  // æ—¥æœŸå·¥å…·
  function todayYMD(){
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  
  // ç‚ºäº†ä¿éšªï¼Œé€™è£¡æŠ“å‰ä¸€å¹´åŠçš„è³‡æ–™ï¼Œé¿å…å¹´åˆæŸ¥ä¸åˆ°å»å¹´åº•çš„
  function minus18Months(ymd){
    const [y,m,d] = ymd.split('-').map(n=>parseInt(n,10));
    const dt = new Date(y, m-1, d);
    dt.setMonth(dt.getMonth() - 18);
    const yy = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${yy}-${mm}-${dd}`;
  }
  
  function toDate(val){
    if (val == null) return null;
    if (Object.prototype.toString.call(val) === '[object Date]' && !isNaN(val)) return val;
    const s = String(val).trim().slice(0,19).replace(/\//g,'-').replace(' ', 'T');
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  // âœ… æ ¸å¿ƒæ–°é‚è¼¯ï¼šæª¢æŸ¥æ˜¯å¦ç¬¦åˆã€Œç•¶æœŸæœˆä»½ã€
  function checkPeriodicStatus(recordDateVal) {
    const recordDate = toDate(recordDateVal);
    if (!recordDate) return { isOk: false, msg: "ç„¡æœ‰æ•ˆæ—¥æœŸ" };

    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1; // 1-12

    // 1. æ‰¾å‡ºã€Œç•¶ä¸‹ã€æ‡‰è©²è¦å°æ‡‰å“ªä¸€å€‹æª¢æŸ¥æœˆä»½
    // é‚è¼¯ï¼šåœ¨ CONFIG.CHECK_MONTHS è£¡é¢ï¼Œæ‰¾å‡ºã€Œå°æ–¼ç­‰æ–¼ç›®å‰æœˆä»½ã€çš„æœ€å¤§å€¼
    // ä¾‹å¦‚è¨­å®š [1, 7]
    // è‹¥ç¾åœ¨æ˜¯ 2æœˆ -> ç›®æ¨™æ˜¯ 1æœˆ
    // è‹¥ç¾åœ¨æ˜¯ 8æœˆ -> ç›®æ¨™æ˜¯ 7æœˆ
    // è‹¥ç¾åœ¨æ˜¯ 1æœˆ -> ç›®æ¨™æ˜¯ 1æœˆ
    
    // å…ˆæ’åºç¢ºä¿é †åº
    const sortedMonths = CONFIG.CHECK_MONTHS.sort((a,b) => a-b);
    
    let targetMonth = null;
    // é€†å‘å°‹æ‰¾ï¼Œæ‰¾åˆ°ç¬¬ä¸€å€‹æ¯”ç¾åœ¨æœˆä»½å°çš„æª¢æŸ¥æœˆ
    for (let i = sortedMonths.length - 1; i >= 0; i--) {
        if (currentMonth >= sortedMonths[i]) {
            targetMonth = sortedMonths[i];
            break;
        }
    }

    // å¦‚æœç¾åœ¨æœˆä»½æ¯”åˆ—è¡¨è£¡æœ€å°çš„é‚„å° (ä¾‹å¦‚è¨­å®š[4,7], ç¾åœ¨æ˜¯2æœˆ)ï¼Œé‚£æ‡‰è©²è¦çœ‹å»å¹´çš„æœ€å¾Œä¸€æ¬¡å—ï¼Ÿ
    // ä¾ç…§æ‚¨çš„è¦å‰‡ï¼šã€Œç•¶å¹´ã€çš„æª¢æŸ¥ã€‚
    // å¦‚æœç¾åœ¨æ˜¯ 2026/02ï¼Œè¨­å®šæ˜¯ [1, 7]ï¼Œç›®æ¨™å°±æ˜¯ 2026/01ã€‚
    // å¦‚æœç¾åœ¨æ˜¯ 2026/01ï¼Œç›®æ¨™ä¹Ÿæ˜¯ 2026/01ã€‚
    // å¦‚æœç¾åœ¨é‚„æ²’åˆ°æª¢æŸ¥æœˆï¼ˆç†è«–ä¸Šä¸å¤ªå¯èƒ½ï¼Œé™¤éè¨­å®šæª”åªæœ‰[12]ç„¶å¾Œç¾åœ¨æ˜¯1æœˆï¼‰ï¼Œæš«è¨­ç‚ºå¹´åˆ
    
    if (targetMonth === null) {
        // é€™ç¨®æƒ…æ³å¾ˆå°‘è¦‹ï¼Œé™¤éè¨­å®š [7] ä½†ç¾åœ¨æ˜¯ 2æœˆã€‚
        // é€™ç¨®æƒ…æ³ä»£è¡¨ä»Šå¹´é‚„æ²’åˆ°æª¢æŸ¥é€±æœŸï¼Œæš«æ™‚ç®— Pass é‚„æ˜¯ Fail?
        // æ ¹æ“šæ‚¨çš„è¦å‰‡ï¼Œæ‡‰ç”±ä½¿ç”¨è€…è‡ªè¡Œå®šç¾©ï¼Œé€™è£¡å‡è¨­è‹¥æœªé”ç¬¬ä¸€å€‹æª¢æŸ¥æœˆï¼Œå‰‡ä¸å¼·åˆ¶æª¢æŸ¥(æˆ–æª¢æŸ¥å»å¹´çš„)ã€‚
        // ä½†ä¾æ‚¨çš„ä¾‹å­ (1æœˆèˆ‡7æœˆ)ï¼Œç›®å‰ä¸€å®šæœƒè½å…¥ 1 æˆ– 7ã€‚
        targetMonth = sortedMonths[0]; 
    }

    const targetYear = currentYear;

    // 2. æª¢æŸ¥ç´€éŒ„æ˜¯å¦ã€Œå‰›å¥½ã€è½åœ¨è©²å¹´ä»½èˆ‡æœˆä»½
    const rYear = recordDate.getFullYear();
    const rMonth = recordDate.getMonth() + 1;

    // åˆ¤æ–·ï¼šå¹´ä»½å¿…é ˆç›¸åŒ ä¸” æœˆä»½å¿…é ˆæ˜¯ç›®æ¨™æœˆ
    // (ä¾‹å¦‚ï¼šç¾åœ¨8æœˆï¼Œç›®æ¨™7æœˆã€‚è‹¥ç´€éŒ„æ˜¯6æœˆ -> NGã€‚è‹¥ç´€éŒ„æ˜¯7æœˆ -> OK)
    const isMatch = (rYear === targetYear && rMonth === targetMonth);

    return {
        isOk: isMatch,
        targetStr: `${targetYear}å¹´${targetMonth}æœˆ`,
        recordStr: `${rYear}å¹´${rMonth}æœˆ`
    };
  }

  // ... (ä»¥ä¸‹æ”å½±æ©Ÿèˆ‡è³‡æ–™è¼‰å…¥é‚è¼¯èˆ‡ä¹‹å‰é¡ä¼¼ï¼Œä½†å¾®èª¿é¡¯ç¤º) ...

  async function initCameraOptions() {
    try {
      const devices = await Html5Qrcode.getCameras();
      const select = document.getElementById("cameraSelect");
      select.innerHTML = "";
      if (devices.length === 0) return alert("æ‰¾ä¸åˆ°æ”å½±æ©Ÿï¼");
      devices.forEach((d, i) => {
        let opt = document.createElement("option");
        opt.value = d.id; opt.text = d.label || `Camera ${i+1}`;
        select.appendChild(opt);
      });
      select.style.display = devices.length > 1 ? "block" : "none";
      currentCameraId = select.value;
      select.addEventListener("change", async () => {
        currentCameraId = select.value;
        await restartScanner();
      });
      await startScanner();
    } catch (e) { alert("æ”å½±æ©ŸéŒ¯èª¤: " + e.message); }
  }

  async function startScanner() {
    if (!currentCameraId) return;
    await qrScanner.start(currentCameraId, { fps: 5, qrbox: 250 }, 
      (txt) => {
        scannedCarId = txt.trim();
        document.getElementById("carIdDisplay").innerText = `ğŸšš ç·¨è™Ÿï¼š${scannedCarId}`;
        qrScanner.stop().then(() => displayResultFromCache(scannedCarId));
      },
      () => {}
    );
  }
  async function restartScanner() {
    if (qrScanner.isScanning) await qrScanner.stop();
    await startScanner();
  }

  function displayResultFromCache(carId) {
    const matches = allRecords.filter(r => r.carId === carId).sort((a,b)=>new Date(b.time)-new Date(a.time));
    const result = matches[0];
    const area = document.getElementById("resultArea");
    area.innerHTML = `<div style="text-align:center; margin-bottom:12px;"><button id="rescanBtn">ğŸ”„ æƒæä¸‹ä¸€å°</button></div>`;

    if (!result) {
      area.innerHTML += `<p class="error">âŒ æŸ¥ç„¡ ${carId} è¿‘æœŸè³‡æ–™</p>`;
    } else {
      // ä½¿ç”¨æ–°çš„é‚è¼¯æª¢æŸ¥
      const status = checkPeriodicStatus(result.time);
      
      const badgeHTML = status.isOk
      ? `<div class="badge-wrap"><div class="badge badge-green"><svg viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5a1 1 0 10-1.4 1.4l4.2 4.2a1 1 0 001.4 0l9-9a1 1 0 10-1.4-1.4L9 16.2z"/></svg><span>æœ¬æœŸåˆæ ¼ (${status.targetStr})</span></div></div>`
      : `<div class="badge-wrap"><div class="badge badge-red"><svg viewBox="0 0 24 24"><path d="M6 6l12 12M6 18L18 6" stroke-width="2"/></svg><span>æœ¬æœŸæœªé»æª¢</span></div></div>`;
      
      // é¡¯ç¤ºè©³ç´°åŸå›  (é™¤éŒ¯ç”¨ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“ç‚ºä½• NG)
      // è‹¥ NGï¼Œæç¤ºæ‡‰è©²è¦æ˜¯å¹¾æœˆ
      let detailMsg = `ğŸ“… æœ€è¿‘é»æª¢ï¼š${result.time}`;
      if (!status.isOk) {
          detailMsg += `<br><span style="color:#dc2626; font-size:13px;">(éœ€æœ‰ ${status.targetStr} ä¹‹ç´€éŒ„ï¼Œç›®å‰ç‚º ${status.recordStr})</span>`;
      }

      area.innerHTML += `
        <div class="date-row">
          ${badgeHTML}
          <div class="info">${detailMsg}</div>
        </div>
      `;

      const fields = Object.entries(result).filter(([k])=>!['carId','time'].includes(k));
      for(const [k,v] of fields) {
        area.innerHTML += `<div class="card"><div class="card-title">${k}</div><div class="card-content">${v||"-"}</div></div>`;
      }
    }
    
    document.getElementById("rescanBtn").addEventListener("click", async()=>{
      area.innerHTML=""; document.getElementById("carIdDisplay").innerText="ğŸ“· ç­‰å¾…æƒæ..."; await restartScanner();
    });
  }

  async function preload() {
    const until = todayYMD();
    const from = minus18Months(until); // æŠ“å¯¬é¬†ä¸€é»ï¼Œç¢ºä¿æŠ“å¾—åˆ°è³‡æ–™
    const ov = document.getElementById("loadingOverlay");
    
    // è¼”åŠ©å‡½å¼ï¼šç¯©é¸æ—¥æœŸå€é–“
    const filterRange = (arr) => {
        const f = new Date(from).getTime();
        const u = new Date(until).setHours(23,59,59);
        return (arr||[]).filter(r=>{
            const t = toDate(r.time);
            return t && t.getTime() >= f && t.getTime() <= u;
        });
    }

    try {
      const res = await fetch(`${CONFIG.GAS_URL}?mode=list&from=${from}&until=${until}`);
      const data = await res.json();
      allRecords = filterRange(data.records);
      ov.style.display="none";
      await initCameraOptions();
    } catch(e) {
      ov.textContent = "âš ï¸ è®€å–å¤±æ•—ï¼Œå˜—è©¦è¼‰å…¥å…¨éƒ¨...";
      try {
          const res2 = await fetch(`${CONFIG.GAS_URL}?mode=list`);
          const data2 = await res2.json();
          allRecords = filterRange(data2.records);
          ov.style.display="none";
          await initCameraOptions();
      } catch(e2) { ov.textContent="âŒ è³‡æ–™è¼‰å…¥å¤±æ•—"; }
    }
  }

  preload();
</script>
</body>
</html>
