<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UT台車點檢紀錄查詢（快速查閱）</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      background-color: #f7f7f7;
      padding: 20px;
      margin: 0;
    }
    h2 { text-align: center; color: #333; }
    #reader { width: 100%; max-width: 320px; margin: 0 auto 20px; }
    #cameraSelect {
      display: none; margin: 0 auto 10px; padding: 6px; font-size: 14px;
      width: 100%; max-width: 320px;
    }
    .status { text-align: center; font-weight: bold; margin-bottom: 10px; }
    .info { text-align: center; font-size: 15px; margin: 8px 0; color: #444; }
    .error { color: red; text-align: center; font-weight: bold; }
    .card {
      background-color: white; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 16px; margin-bottom: 16px;
    }
    .card-title { font-weight: bold; color: #555; margin-bottom: 6px; }
    .card-content { font-size: 15px; color: #222; word-wrap: break-word; }
    button {
      width: 100%; padding: 12px; background-color: #007bff; color: white;
      border: none; font-size: 16px; border-radius: 8px; cursor: pointer; margin-top: 12px;
    }
    button:hover { background-color: #0056b3; }
    #loadingOverlay {
      display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4); color: white; font-size: 20px;
      justify-content: center; align-items: center; z-index: 999;
      text-align:center; padding: 0 16px;
    }

    /* ====== 徽章樣式 ====== */
    .badge-wrap {
      display: flex;
      justify-content: center;
      margin: 12px 0 4px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 700;
      letter-spacing: .5px;
      user-select: none;
    }
    .badge svg { width: 18px; height: 18px; }

    .badge-green {
      color: #063b1f;
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 40%, #16a34a 100%);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.9) inset,
                  0 6px 18px rgba(34,197,94,0.35),
                  0 0 24px rgba(52,211,153,0.45);
      border: 1px solid rgba(6, 78, 59, 0.25);
      animation: pulseGlowGreen 1.6s infinite ease-in-out;
    }
    .badge-green svg { filter: drop-shadow(0 1px 0 rgba(255,255,255,0.4)); fill:#064e3b; }

    .badge-red {
      color: #7f1d1d;
      background: linear-gradient(135deg, #f87171 0%, #ef4444 40%, #dc2626 100%);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.9) inset,
                  0 6px 18px rgba(239,68,68,0.35),
                  0 0 24px rgba(239,68,68,0.45);
      border: 1px solid rgba(127,29,29,0.25);
      animation: pulseGlowRed 1.6s infinite ease-in-out;
    }
    .badge-red svg { filter: drop-shadow(0 1px 0 rgba(255,255,255,0.4)); fill:#7f1d1d; }

    @keyframes pulseGlowGreen {
      0% { transform:scale(1); box-shadow:0 0 0 2px rgba(255,255,255,0.9) inset,0 6px 18px rgba(34,197,94,0.35),0 0 24px rgba(52,211,153,0.45); }
      50% { transform:scale(1.03); box-shadow:0 0 0 2px rgba(255,255,255,0.9) inset,0 10px 26px rgba(34,197,94,0.50),0 0 36px rgba(52,211,153,0.65); }
      100%{ transform:scale(1); box-shadow:0 0 0 2px rgba(255,255,255,0.9) inset,0 6px 18px rgba(34,197,94,0.35),0 0 24px rgba(52,211,153,0.45); }
    }
    @keyframes pulseGlowRed {
      0% { transform:scale(1); box-shadow:0 0 0 2px rgba(255,255,255,0.9) inset,0 6px 18px rgba(239,68,68,0.35),0 0 24px rgba(239,68,68,0.45); }
      50% { transform:scale(1.03); box-shadow:0 0 0 2px rgba(255,255,255,0.9) inset,0 10px 26px rgba(239,68,68,0.50),0 0 36px rgba(239,68,68,0.65); }
      100%{ transform:scale(1); box-shadow:0 0 0 2px rgba(255,255,255,0.9) inset,0 6px 18px rgba(239,68,68,0.35),0 0 24px rgba(239,68,68,0.45); }
    }

    .date-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin: 8px 0 12px;
    }
  </style>
</head>
<body>

<h2>📋 UT燿華台車點檢紀錄查詢（最下方按鈕可以再次查詢，不用重新載資料）</h2>
<select id="cameraSelect"></select>
<div id="reader"></div>
<p id="carIdDisplay" class="status">📷 等待掃描 QR Code...</p>
<div id="resultArea"></div>
<!-- 移除原本固定在底部的按鈕，改為動態插入 -->
<div id="loadingOverlay">👌 資料庫載入中，請耐心等待約10秒，感謝（只抓今天往前一年的資料）…</div>

<script>
  // ===== 基本設定 =====
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec";
  let allRecords = [];
  let scannedCarId = "";
  let currentCameraId = null;
  const qrScanner = new Html5Qrcode("reader");

  // ===== 日期工具：今天與「今天往前一年」 =====
  function todayYMD(){
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function minusOneYearSameDay(ymd){
    const [y,m,d] = ymd.split('-').map(n=>parseInt(n,10));
    const dt = new Date(y, m-1, d);
    dt.setFullYear(dt.getFullYear()-1);
    const yy = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${yy}-${mm}-${dd}`;
  }
  function startOfDay(ymd){ const [y,m,d]=ymd.split('-').map(Number); return new Date(y,m-1,d,0,0,0,0); }
  function endOfDay(ymd){ const [y,m,d]=ymd.split('-').map(Number); return new Date(y,m-1,d,23,59,59,999); }

  // 將各種格式的 time 轉 Date；失敗回 null
  function toDate(val){
    if (val == null) return null;
    if (Object.prototype.toString.call(val) === '[object Date]' && !isNaN(val)) return val;
    const s = String(val).trim();
    const s19 = s.slice(0,19);
    const norm = s19.replace(/\//g,'-').replace(' ', 'T');
    const d1 = new Date(norm);
    if (!isNaN(d1)) return d1;
    const d2 = new Date(s);
    return isNaN(d2) ? null : d2;
  }

  // 前端備援篩選：只保留 [from, until]（含端點）
  function filterByRange(rawArray, fromYMD, untilYMD){
    const from = startOfDay(fromYMD).getTime();
    const until = endOfDay(untilYMD).getTime();
    return (rawArray || []).filter(r=>{
      const t = toDate(r.time);
      if (!t) return false;
      const ts = t.getTime();
      return ts >= from && ts <= until;
    });
  }

  // ✅ 是否在「今天往前的 n 個月」內（含端點）
  function isWithinLastNMonths(dateVal, n=6){
    const t = toDate(dateVal);
    if (!t) return false;
    const now = new Date();
    const from = new Date(now.getFullYear(), now.getMonth() - n, now.getDate(), 0,0,0,0).getTime();
    const ts = t.getTime();
    return ts >= from && ts <= now.getTime();
  }

  // ✅ 載入攝影機清單
  async function initCameraOptions() {
    try {
      const devices = await Html5Qrcode.getCameras();
      const select = document.getElementById("cameraSelect");
      select.innerHTML = "";

      if (devices.length === 0) {
        alert("找不到攝影機！");
        return;
      }

      devices.forEach((device, index) => {
        const option = document.createElement("option");
        option.value = device.id;
        option.text = device.label || `Camera ${index + 1}`;
        select.appendChild(option);
      });

      // 若有多顆鏡頭才顯示下拉
      select.style.display = devices.length > 1 ? "block" : "none";

      currentCameraId = select.value;
      select.addEventListener("change", async () => {
        currentCameraId = select.value;
        await restartScanner();
      });

      await startScanner();
    } catch (err) {
      alert("無法存取攝影機：" + err.message);
    }
  }

  // ✅ 啟動掃描器
  async function startScanner() {
    if (!currentCameraId) return;

    await qrScanner.start(
      currentCameraId,
      {
        fps: 5,
        aspectRatio: 1.777,
        qrbox: { width: 250, height: 250 },
        videoConstraints: {
          width: { ideal: 640 },
          height: { ideal: 480 },
          facingMode: "environment"
        }
      },
      (qrCodeMessage) => {
        scannedCarId = qrCodeMessage.trim();
        document.getElementById("carIdDisplay").innerText = `🚚 台車編號：${scannedCarId}`;
        qrScanner.stop().then(() => {
          displayResultFromCache(scannedCarId);
        }).catch(()=>{ /* 安全忽略 */ });
      },
      (/* errorMessage */) => { /* 可忽略連續失敗 */ }
    );
  }

  async function restartScanner() {
    if (qrScanner && qrScanner.isScanning) {
      await qrScanner.stop();
    }
    await startScanner();
  }

  // ✅ 根據快取資料顯示結果（把「重新掃描」放到日期上方）
  function displayResultFromCache(carId) {
    const matches = allRecords
      .filter(r => r.carId === carId)
      .sort((a, b) => new Date(b.time) - new Date(a.time));
    const result = matches[0];
    const resultArea = document.getElementById("resultArea");
    resultArea.innerHTML = "";

    // 先插入「重新掃描」按鈕（在日期上方）
    resultArea.innerHTML += `
      <div style="text-align:center; margin-bottom:12px;">
        <button id="rescanBtn">🔄 重新掃描</button>
      </div>
    `;

    // 若無資料，顯示錯誤訊息（按鈕已在上面）
    if (!result) {
      resultArea.innerHTML += `<p class="error">❌ 查無 ${carId} 的點檢資料（或不在近一年範圍內）</p>`;
      // 綁事件
      document.getElementById("rescanBtn").addEventListener("click", async () => {
        resultArea.innerHTML = "";
        document.getElementById("carIdDisplay").innerText = "📷 等待重新掃描 QR Code...";
        await restartScanner();
      });
      return;
    }

    const within6M = isWithinLastNMonths(result.time, 6);

    // 徽章
    const badgeHTML = within6M
      ? `
      <div class="badge-wrap">
        <div class="badge badge-green" title="已檢驗（半年內）">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M9 16.2l-3.5-3.5a1 1 0 10-1.4 1.4l4.2 4.2a1 1 0 001.4 0l9-9a1 1 0 10-1.4-1.4L9 16.2z"></path>
          </svg>
          <span>已檢驗</span>
        </div>
      </div>`
      : `
      <div class="badge-wrap">
        <div class="badge badge-red" title="半年以上未點檢">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M6 6l12 12M6 18L18 6" stroke-width="2"></path>
          </svg>
          <span>半年以上未點檢</span>
        </div>
      </div>`;

    // 日期列（按鈕已在上方）
    resultArea.innerHTML += `
      <div class="date-row">
        ${badgeHTML}
        <div class="info">📅 點檢時間：${result.time}</div>
      </div>
    `;

    // 其餘欄位
    const fields = Object.entries(result).filter(([key]) => !['carId', 'time'].includes(key));
    for (const [key, val] of fields) {
      resultArea.innerHTML += `
        <div class="card">
          <div class="card-title">${key}</div>
          <div class="card-content">${val ?? "-"}</div>
        </div>
      `;
    }

    // 綁定「重新掃描」事件
    document.getElementById("rescanBtn").addEventListener("click", async () => {
      resultArea.innerHTML = "";
      document.getElementById("carIdDisplay").innerText = "📷 等待重新掃描 QR Code...";
      await restartScanner();
    });
  }

  // ✅ 預載資料（只抓今天往前一年）
  async function preloadDataAndInit() {
    const until = todayYMD();
    const from  = minusOneYearSameDay(until);
    const overlay = document.getElementById("loadingOverlay");
    try {
      const res = await fetch(`${GAS_URL}?mode=list&from=${encodeURIComponent(from)}&until=${encodeURIComponent(until)}`, { cache: "no-store" });
      if (!res.ok) throw new Error("GAS 回傳非 200：" + res.status);
      const data = await res.json();

      const raw = data.records || [];
      allRecords = filterByRange(raw, from, until);

      overlay.style.display = "none";
      await initCameraOptions();
    } catch (err) {
      overlay.textContent = "⚠️ 後端區間請求失敗，改用前端篩選…";
      try {
        const res2 = await fetch(`${GAS_URL}?mode=list`, { cache: "no-store" });
        if (!res2.ok) throw new Error("GAS 回傳非 200：" + res2.status);
        const data2 = await res2.json();
        const raw2 = data2.records || [];
        allRecords = filterByRange(raw2, from, until);
        overlay.style.display = "none";
        await initCameraOptions();
      } catch (err2) {
        overlay.textContent = "❌ 載入資料失敗：" + err2.message;
      }
    }
  }

  preloadDataAndInit();
</script>
</body>
</html>
