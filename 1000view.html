<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UTå°è»Šé»æª¢ç´€éŒ„æŸ¥è©¢ï¼ˆè£œé»æ©Ÿåˆ¶ç‰ˆï¼‰</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      background-color: #f7f7f7;
      padding: 20px;
      margin: 0;
    }
    h2 { text-align: center; color: #333; }
    #reader { width: 100%; max-width: 320px; margin: 0 auto 20px; }
    #cameraSelect {
      display: none; margin: 0 auto 10px; padding: 6px; font-size: 14px;
      width: 100%; max-width: 320px;
    }
    .status { text-align: center; font-weight: bold; margin-bottom: 10px; }
    .info { text-align: center; font-size: 15px; margin: 8px 0; color: #444; }
    .error { color: red; text-align: center; font-weight: bold; }
    .card {
      background-color: white; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 16px; margin-bottom: 16px;
    }
    .card-title { font-weight: bold; color: #555; margin-bottom: 6px; }
    .card-content { font-size: 15px; color: #222; word-wrap: break-word; }
    button {
      width: 100%; padding: 12px; background-color: #007bff; color: white;
      border: none; font-size: 16px; border-radius: 8px; cursor: pointer; margin-top: 12px;
    }
    button:hover { background-color: #0056b3; }
    #loadingOverlay {
      display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4); color: white; font-size: 20px;
      justify-content: center; align-items: center; z-index: 999;
      text-align:center; padding: 0 16px;
    }

    /* ====== å¾½ç« æ¨£å¼ ====== */
    .badge-wrap { display: flex; justify-content: center; margin: 12px 0 4px; }
    .badge {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 16px 28px; border-radius: 999px;
      font-weight: 700; letter-spacing: .5px; user-select: none;
      text-align: center;
    }
    .badge svg { width: 18px; height: 18px; }

    /* ç¶ è‰²ï¼šæ­£å¸¸ */
    .badge-green {
      color: #063b1f;
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 40%, #16a34a 100%);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.9) inset, 0 6px 18px rgba(34,197,94,0.35);
      border: 1px solid rgba(6, 78, 59, 0.25);
      animation: pulseGlowGreen 1.6s infinite ease-in-out;
    }
    .badge-green svg { filter: drop-shadow(0 1px 0 rgba(255,255,255,0.4)); fill:#064e3b; }

    /* é»ƒè‰²ï¼šè£œé» */
    .badge-yellow {
      color: #713f12; /* æ·±è¤è‰²æ–‡å­— */
      background: linear-gradient(135deg, #facc15 0%, #eab308 40%, #ca8a04 100%);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.9) inset, 0 6px 18px rgba(234,179,8,0.35);
      border: 1px solid rgba(113, 63, 18, 0.25);
      animation: pulseGlowYellow 1.6s infinite ease-in-out;
    }
    .badge-yellow svg { filter: drop-shadow(0 1px 0 rgba(255,255,255,0.4)); fill:#713f12; }

    /* ç´…è‰²ï¼šç•°å¸¸ */
    .badge-red {
      color: #7f1d1d;
      background: linear-gradient(135deg, #f87171 0%, #ef4444 40%, #dc2626 100%);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.9) inset, 0 6px 18px rgba(239,68,68,0.35);
      border: 1px solid rgba(127,29,29,0.25);
      animation: pulseGlowRed 1.6s infinite ease-in-out;
    }
    .badge-red svg { filter: drop-shadow(0 1px 0 rgba(255,255,255,0.4)); fill:#7f1d1d; }

    @keyframes pulseGlowGreen { 0% { transform:scale(1); } 50% { transform:scale(1.03); } 100%{ transform:scale(1); } }
    @keyframes pulseGlowYellow { 0% { transform:scale(1); } 50% { transform:scale(1.03); } 100%{ transform:scale(1); } }
    @keyframes pulseGlowRed { 0% { transform:scale(1); } 50% { transform:scale(1.03); } 100%{ transform:scale(1); } }

    .date-row {
      display: flex; flex-direction: column; align-items: center; gap: 8px; margin: 8px 0 12px;
    }
    .rule-info {
        font-size: 12px; color: #888; text-align: center; margin-bottom: 8px;
    }
  </style>
</head>
<body>

<h2>ğŸ“‹ UTç‡¿è¯å°è»Šé»æª¢ç´€éŒ„</h2>
<div class="rule-info">æ¨™æº–ï¼š1æœˆã€7æœˆ / è£œé»ï¼šå…¶é¤˜æœˆä»½ (é»ƒç‡ˆ)</div>

<select id="cameraSelect"></select>
<div id="reader"></div>
<p id="carIdDisplay" class="status">ğŸ“· ç­‰å¾…æƒæ QR Code...</p>
<div id="resultArea"></div>
<div id="loadingOverlay">ğŸ‘Œ è³‡æ–™åº«è¼‰å…¥ä¸­ï¼Œè«‹è€å¿ƒç­‰å¾…...</div>

<script>
  // ==========================================
  // âš™ï¸ è¨­å®šæª”å€åŸŸ
  // ==========================================
  const CONFIG = {
    CHECK_MONTHS: [1, 7], 
    GAS_URL: "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec"
  };
  // ==========================================

  let allRecords = [];
  let scannedCarId = "";
  let currentCameraId = null;
  const qrScanner = new Html5Qrcode("reader");

  function todayYMD(){
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  
  function minus18Months(ymd){
    const [y,m,d] = ymd.split('-').map(n=>parseInt(n,10));
    const dt = new Date(y, m-1, d);
    dt.setMonth(dt.getMonth() - 18);
    const yy = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${yy}-${mm}-${dd}`;
  }
  
  function toDate(val){
    if (val == null) return null;
    if (Object.prototype.toString.call(val) === '[object Date]' && !isNaN(val)) return val;
    const s = String(val).trim().slice(0,19).replace(/\//g,'-').replace(' ', 'T');
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  // âœ… æ ¸å¿ƒæ–°é‚è¼¯ï¼šä¸‰æ®µå¼åˆ¤å®š (Green / Yellow / Red)
  function checkPeriodicStatus(recordDateVal) {
    const recordDate = toDate(recordDateVal);
    if (!recordDate) return { status: 'error', msg: "ç„¡æœ‰æ•ˆæ—¥æœŸ" };

    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;

    // 1. æ‰¾å‡ºç›®å‰çš„æª¢æŸ¥ç›®æ¨™æœˆ (åŒèˆŠé‚è¼¯)
    const sortedMonths = CONFIG.CHECK_MONTHS.sort((a,b) => a-b);
    let targetMonth = sortedMonths[0]; // fallback
    for (let i = sortedMonths.length - 1; i >= 0; i--) {
        if (currentMonth >= sortedMonths[i]) {
            targetMonth = sortedMonths[i];
            break;
        }
    }
    
    // å¦‚æœç¾åœ¨æœˆä»½æ¯”åˆ—è¡¨æœ€å°é‚„å°(ä¾‹å¦‚1æœˆ)ï¼Œä½†è¨­å®šæª”æ˜¯[1,7]ï¼Œå‰‡ç›®æ¨™æ˜¯1æœˆã€‚æ­¤é‚è¼¯å·²ç”±ä¸Šæ–¹è¿´åœˆæ¶µè“‹ã€‚

    const targetYear = currentYear;
    const rYear = recordDate.getFullYear();
    const rMonth = recordDate.getMonth() + 1;

    // é‚è¼¯åˆ¤å®šå€
    // A. å¹´ä»½å¿…é ˆæ˜¯ä»Šå¹´ (è‹¥ä¸æ˜¯ä»Šå¹´ï¼Œç›´æ¥ç´…ç‡ˆ)
    if (rYear !== targetYear) {
      return { 
        status: 'red', 
        targetStr: `${targetYear}å¹´${targetMonth}æœˆ`, 
        recordStr: `${rYear}å¹´${rMonth}æœˆ`
      };
    }

    // B. å¹´ä»½æ­£ç¢ºï¼Œæª¢æŸ¥æœˆä»½
    if (rMonth === targetMonth) {
      // å®Œç¾ç¬¦åˆ (ä¾‹å¦‚ç›®æ¨™1æœˆï¼Œç´€éŒ„1æœˆ) -> ç¶ ç‡ˆ
      return { 
        status: 'green', 
        targetStr: `${targetYear}å¹´${targetMonth}æœˆ`, 
        recordStr: `${rYear}å¹´${rMonth}æœˆ`
      };
    } else if (rMonth > targetMonth) {
      // é›–ç„¶å¹´ä»½å°ï¼Œä½†æœˆä»½è¶…éç›®æ¨™ (ä¾‹å¦‚ç›®æ¨™1æœˆï¼Œç´€éŒ„2~6æœˆ) -> é»ƒç‡ˆ
      return { 
        status: 'yellow', 
        targetStr: `${targetYear}å¹´${targetMonth}æœˆ`, 
        recordStr: `${rYear}å¹´${rMonth}æœˆ`
      };
    } else {
      // æœˆä»½å°æ–¼ç›®æ¨™ (ä¾‹å¦‚ç›®æ¨™7æœˆï¼Œç´€éŒ„å»æ˜¯1æœˆ) -> ç´…ç‡ˆ (é€™æ˜¯ä¸Šä¸€æœŸçš„ç´€éŒ„)
      return { 
        status: 'red', 
        targetStr: `${targetYear}å¹´${targetMonth}æœˆ`, 
        recordStr: `${rYear}å¹´${rMonth}æœˆ`
      };
    }
  }

  async function initCameraOptions() {
    try {
      const devices = await Html5Qrcode.getCameras();
      const select = document.getElementById("cameraSelect");
      select.innerHTML = "";
      if (devices.length === 0) return alert("æ‰¾ä¸åˆ°æ”å½±æ©Ÿï¼");
      devices.forEach((d, i) => {
        let opt = document.createElement("option");
        opt.value = d.id; opt.text = d.label || `Camera ${i+1}`;
        select.appendChild(opt);
      });
      select.style.display = devices.length > 1 ? "block" : "none";
      currentCameraId = select.value;
      select.addEventListener("change", async () => {
        currentCameraId = select.value;
        await restartScanner();
      });
      await startScanner();
    } catch (e) { alert("æ”å½±æ©ŸéŒ¯èª¤: " + e.message); }
  }

  async function startScanner() {
    if (!currentCameraId) return;
    // ğŸ”¥ ç¯€èƒ½æ¨¡å¼è¨­å®š
    const config = {
      fps: 2,  
      qrbox: 250,
      videoConstraints: {
        width: { min: 480, ideal: 640, max: 640 },
        height: { min: 480, ideal: 640, max: 640 },
        facingMode: "environment" 
      }
    };

    await qrScanner.start(currentCameraId, config, 
      (txt) => {
        scannedCarId = txt.trim();
        document.getElementById("carIdDisplay").innerText = `ğŸšš ç·¨è™Ÿï¼š${scannedCarId}`;
        qrScanner.stop().then(() => displayResultFromCache(scannedCarId));
      },
      () => {}
    );
  }
  
  async function restartScanner() {
    if (qrScanner.isScanning) await qrScanner.stop();
    await startScanner();
  }

  function displayResultFromCache(carId) {
    const matches = allRecords.filter(r => r.carId === carId).sort((a,b)=>new Date(b.time)-new Date(a.time));
    const result = matches[0];
    const area = document.getElementById("resultArea");
    area.innerHTML = `<div style="text-align:center; margin-bottom:12px;"><button id="rescanBtn">ğŸ”„ æƒæä¸‹ä¸€å°</button></div>`;

    if (!result) {
      area.innerHTML += `<p class="error">âŒ æŸ¥ç„¡ ${carId} è¿‘æœŸè³‡æ–™</p>`;
    } else {
      const checkRes = checkPeriodicStatus(result.time);
      
      let badgeHTML = "";
      let detailInfo = `ğŸ“… æœ€è¿‘é»æª¢ï¼š${result.time}`;

      // æ ¹æ“šä¸‰ç¨®ç‹€æ…‹é¡¯ç¤ºä¸åŒ Badge
      if (checkRes.status === 'green') {
        // ğŸŸ¢ ç¶ ç‡ˆï¼šå®Œç¾åˆæ ¼
        badgeHTML = `
          <div class="badge-wrap">
            <div class="badge badge-green">
              <svg viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5a1 1 0 10-1.4 1.4l4.2 4.2a1 1 0 001.4 0l9-9a1 1 0 10-1.4-1.4L9 16.2z"/></svg>
              <span>æœ¬æœŸåˆæ ¼ (${checkRes.targetStr})</span>
            </div>
          </div>`;
          
      } else if (checkRes.status === 'yellow') {
        // ğŸŸ¡ é»ƒç‡ˆï¼šè£œé»
        badgeHTML = `
          <div class="badge-wrap">
            <div class="badge badge-yellow">
              <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
              <span>æœªåœ¨${checkRes.targetStr}é»æª¢ï¼Œå·²è£œé»</span>
            </div>
          </div>`;
          
      } else {
        // ğŸ”´ ç´…ç‡ˆï¼šæœªé»æª¢æˆ–éæœŸ
        badgeHTML = `
          <div class="badge-wrap">
            <div class="badge badge-red">
              <svg viewBox="0 0 24 24"><path d="M6 6l12 12M6 18L18 6" stroke-width="2"/></svg>
              <span>æœ¬æœŸæœªé»æª¢</span>
            </div>
          </div>`;
          
        detailInfo += `<br><span style="color:#dc2626; font-size:13px;">(éœ€æœ‰ ${checkRes.targetStr} ä¹‹ç´€éŒ„ï¼Œç›®å‰ç‚º ${checkRes.recordStr})</span>`;
      }

      area.innerHTML += `
        <div class="date-row">
          ${badgeHTML}
          <div class="info">${detailInfo}</div>
        </div>
      `;

      const fields = Object.entries(result).filter(([k])=>!['carId','time'].includes(k));
      for(const [k,v] of fields) {
        area.innerHTML += `<div class="card"><div class="card-title">${k}</div><div class="card-content">${v||"-"}</div></div>`;
      }
    }
    
    document.getElementById("rescanBtn").addEventListener("click", async()=>{
      area.innerHTML=""; document.getElementById("carIdDisplay").innerText="ğŸ“· ç­‰å¾…æƒæ..."; await restartScanner();
    });
  }

  async function preload() {
    const until = todayYMD();
    const from = minus18Months(until);
    const ov = document.getElementById("loadingOverlay");
    
    const filterRange = (arr) => {
        const f = new Date(from).getTime();
        const u = new Date(until).setHours(23,59,59);
        return (arr||[]).filter(r=>{
            const t = toDate(r.time);
            return t && t.getTime() >= f && t.getTime() <= u;
        });
    }

    try {
      const res = await fetch(`${CONFIG.GAS_URL}?mode=list&from=${from}&until=${until}`);
      const data = await res.json();
      allRecords = filterRange(data.records);
      ov.style.display="none";
      await initCameraOptions();
    } catch(e) {
      ov.textContent = "âš ï¸ è®€å–å¤±æ•—ï¼Œå˜—è©¦è¼‰å…¥å…¨éƒ¨...";
      try {
          const res2 = await fetch(`${CONFIG.GAS_URL}?mode=list`);
          const data2 = await res2.json();
          allRecords = filterRange(data2.records);
          ov.style.display="none";
          await initCameraOptions();
      } catch(e2) { ov.textContent="âŒ è³‡æ–™è¼‰å…¥å¤±æ•—"; }
    }
  }

  preload();
</script>
</body>
</html>
