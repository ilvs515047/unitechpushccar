<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UT台車點檢紀錄查詢（快取版）</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      background-color: #f7f7f7;
      padding: 20px;
      margin: 0;
    }
    h2 { text-align: center; color: #333; }
    #reader { width: 100%; max-width: 320px; margin: 0 auto 20px; }
    #cameraSelect {
      display: block; margin: 0 auto 10px; padding: 6px; font-size: 14px;
      width: 100%; max-width: 320px;
    }
    .status { text-align: center; font-weight: bold; margin-bottom: 10px; }
    .info { text-align: center; font-size: 15px; margin: 8px 0; color: #444; }
    .error { color: red; text-align: center; font-weight: bold; }
    .card {
      background-color: white; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 16px; margin-bottom: 16px;
    }
    .card-title { font-weight: bold; color: #555; margin-bottom: 6px; }
    .card-content { font-size: 15px; color: #222; word-wrap: break-word; }
    button {
      width: 100%; padding: 12px; background-color: #007bff; color: white;
      border: none; font-size: 16px; border-radius: 8px; cursor: pointer; margin-top: 12px;
    }
    button:hover { background-color: #0056b3; }
    #loadingOverlay {
      display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4); color: white; font-size: 20px;
      justify-content: center; align-items: center; z-index: 999;
      text-align:center; padding: 0 16px;
    }
  </style>
</head>
<body>

<h2>📋 UT燿華台車點檢紀錄查詢（快取版）</h2>
<select id="cameraSelect" style="display: none;"></select>
<div id="reader"></div>
<p id="carIdDisplay" class="status">📷 等待掃描 QR Code...</p>
<div id="resultArea"></div>
<button id="rescanBtn" style="display:none;">🔄 重新掃描</button>
<div id="loadingOverlay">👌 資料庫載入中（只抓今天往前一年的資料）…</div>

<script>
  // ===== 基本設定 =====
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec";
  let allRecords = [];
  let scannedCarId = "";
  let currentCameraId = null;
  const qrScanner = new Html5Qrcode("reader");

  // ===== 日期工具：今天與「今天往前一年」 =====
  function todayYMD(){
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function minusOneYearSameDay(ymd){
    const [y,m,d] = ymd.split('-').map(n=>parseInt(n,10));
    const dt = new Date(y, m-1, d);
    dt.setFullYear(dt.getFullYear()-1);
    const yy = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${yy}-${mm}-${dd}`;
  }
  function startOfDay(ymd){ const [y,m,d]=ymd.split('-').map(Number); return new Date(y,m-1,d,0,0,0,0); }
  function endOfDay(ymd){ const [y,m,d]=ymd.split('-').map(Number); return new Date(y,m-1,d,23,59,59,999); }

  // 將各種格式的 time 轉 Date；失敗回 null
  function toDate(val){
    if (val == null) return null;
    if (Object.prototype.toString.call(val) === '[object Date]' && !isNaN(val)) return val;
    const s = String(val).trim();
    // 常見：YYYY-MM-DD HH:mm:ss 或 YYYY/MM/DD HH:mm
    const s19 = s.slice(0,19);
    const norm = s19.replace(/\//g,'-').replace(' ', 'T');
    const d1 = new Date(norm);
    if (!isNaN(d1)) return d1;
    const d2 = new Date(s);
    return isNaN(d2) ? null : d2;
  }

  // 前端備援篩選：只保留 [from, until]（含端點）
  function filterByRange(rawArray, fromYMD, untilYMD){
    const from = startOfDay(fromYMD).getTime();
    const until = endOfDay(untilYMD).getTime();
    return (rawArray || []).filter(r=>{
      const t = toDate(r.time);
      if (!t) return false;
      const ts = t.getTime();
      return ts >= from && ts <= until;
    });
  }

  // ✅ 載入攝影機清單
  async function initCameraOptions() {
    try {
      const devices = await Html5Qrcode.getCameras();
      const select = document.getElementById("cameraSelect");
      select.innerHTML = "";

      if (devices.length === 0) {
        alert("找不到攝影機！");
        return;
      }

      devices.forEach((device, index) => {
        const option = document.createElement("option");
        option.value = device.id;
        option.text = device.label || `Camera ${index + 1}`;
        select.appendChild(option);
      });

      currentCameraId = select.value;
      select.addEventListener("change", async () => {
        currentCameraId = select.value;
        await restartScanner();
      });

      await startScanner();
    } catch (err) {
      alert("無法存取攝影機：" + err.message);
    }
  }

  // ✅ 啟動掃描器
  async function startScanner() {
    if (!currentCameraId) return;

    await qrScanner.start(
      currentCameraId,
      {
        fps: 5,
        aspectRatio: 1.777,
        qrbox: { width: 250, height: 250 },
        videoConstraints: {
          width: { ideal: 640 },
          height: { ideal: 480 },
          facingMode: "environment"
        }
      },
      (qrCodeMessage) => {
        scannedCarId = qrCodeMessage.trim();
        document.getElementById("carIdDisplay").innerText = `🚚 台車編號：${scannedCarId}`;
        qrScanner.stop().then(() => {
          displayResultFromCache(scannedCarId);
        });
      },
      (errorMessage) => {
        // 可忽略
      }
    );
  }

  async function restartScanner() {
    if (qrScanner && qrScanner.isScanning) {
      await qrScanner.stop();
    }
    await startScanner();
  }

  // ✅ 根據快取資料顯示結果
  function displayResultFromCache(carId) {
    const matches = allRecords
      .filter(r => r.carId === carId)
      .sort((a, b) => new Date(b.time) - new Date(a.time));
    const result = matches[0];
    const resultArea = document.getElementById("resultArea");

    if (!result) {
      resultArea.innerHTML = `<p class="error">❌ 查無 ${carId} 的點檢資料（或不在近一年範圍內）</p>`;
      document.getElementById("rescanBtn").style.display = "inline-block";
      return;
    }

    resultArea.innerHTML = `<div class="info">📅 點檢時間：${result.time}</div>`;
    const fields = Object.entries(result).filter(([key]) => !['carId', 'time'].includes(key));

    for (const [key, val] of fields) {
      resultArea.innerHTML += `
        <div class="card">
          <div class="card-title">${key}</div>
          <div class="card-content">${val || "-"}</div>
        </div>
      `;
    }

    document.getElementById("rescanBtn").style.display = "inline-block";
  }

  // ✅ 點擊重新掃描
  document.getElementById("rescanBtn").addEventListener("click", async () => {
    document.getElementById("resultArea").innerHTML = "";
    document.getElementById("carIdDisplay").innerText = "📷 等待重新掃描 QR Code...";
    document.getElementById("rescanBtn").style.display = "none";
    await restartScanner();
  });

  // ✅ 預載資料（只抓今天往前一年）
  async function preloadDataAndInit() {
    const until = todayYMD();
    const from  = minusOneYearSameDay(until); // 含端點：from 00:00:00 ~ until 23:59:59
    const overlay = document.getElementById("loadingOverlay");
    try {
      // 1) 嘗試由後端做區間過濾（建議日後支援）
      const res = await fetch(`${GAS_URL}?mode=list&from=${encodeURIComponent(from)}&until=${encodeURIComponent(until)}`, { cache: "no-store" });
      if (!res.ok) throw new Error("GAS 回傳非 200：" + res.status);
      const data = await res.json();

      // 2) 保險：若後端未支援 from/until，這裡以 time 欄位做前端區間過濾
      const raw = data.records || [];
      allRecords = filterByRange(raw, from, until);

      overlay.style.display = "none";
      await initCameraOptions();
    } catch (err) {
      // 若整個請求失敗，再嘗試抓舊 API（無範圍），然後前端過濾
      overlay.textContent = "⚠️ 後端區間請求失敗，改用前端篩選…";
      try {
        const res2 = await fetch(`${GAS_URL}?mode=list`, { cache: "no-store" });
        if (!res2.ok) throw new Error("GAS 回傳非 200：" + res2.status);
        const data2 = await res2.json();
        const raw2 = data2.records || [];
        allRecords = filterByRange(raw2, from, until);
        overlay.style.display = "none";
        await initCameraOptions();
      } catch (err2) {
        overlay.textContent = "❌ 載入資料失敗：" + err2.message;
      }
    }
  }

  preloadDataAndInit();
</script>
</body>
</html>
