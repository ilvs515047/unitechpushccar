<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UTå°è»Šé»æª¢ç´€éŒ„æŸ¥è©¢ï¼ˆå¿«å–ç‰ˆï¼‰</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      background-color: #f7f7f7;
      padding: 20px;
      margin: 0;
    }
    h2 { text-align: center; color: #333; }
    #reader { width: 100%; max-width: 320px; margin: 0 auto 20px; }
    #cameraSelect {
      display: block; margin: 0 auto 10px; padding: 6px; font-size: 14px;
      width: 100%; max-width: 320px;
    }
    .status { text-align: center; font-weight: bold; margin-bottom: 10px; }
    .info { text-align: center; font-size: 15px; margin: 8px 0; color: #444; }
    .error { color: red; text-align: center; font-weight: bold; }
    .card {
      background-color: white; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 16px; margin-bottom: 16px;
    }
    .card-title { font-weight: bold; color: #555; margin-bottom: 6px; }
    .card-content { font-size: 15px; color: #222; word-wrap: break-word; }
    button {
      width: 100%; padding: 12px; background-color: #007bff; color: white;
      border: none; font-size: 16px; border-radius: 8px; cursor: pointer; margin-top: 12px;
    }
    button:hover { background-color: #0056b3; }
    #loadingOverlay {
      display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4); color: white; font-size: 20px;
      justify-content: center; align-items: center; z-index: 999;
      text-align:center; padding: 0 16px;
    }
  </style>
</head>
<body>

<h2>ğŸ“‹ UTç‡¿è¯å°è»Šé»æª¢ç´€éŒ„æŸ¥è©¢ï¼ˆå¿«å–ç‰ˆï¼‰</h2>
<select id="cameraSelect" style="display: none;"></select>
<div id="reader"></div>
<p id="carIdDisplay" class="status">ğŸ“· ç­‰å¾…æƒæ QR Code...</p>
<div id="resultArea"></div>
<button id="rescanBtn" style="display:none;">ğŸ”„ é‡æ–°æƒæ</button>
<div id="loadingOverlay">ğŸ‘Œ è³‡æ–™åº«è¼‰å…¥ä¸­ï¼ˆåªæŠ“ä»Šå¤©å¾€å‰ä¸€å¹´çš„è³‡æ–™ï¼‰â€¦</div>

<script>
  // ===== åŸºæœ¬è¨­å®š =====
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec";
  let allRecords = [];
  let scannedCarId = "";
  let currentCameraId = null;
  const qrScanner = new Html5Qrcode("reader");

  // ===== æ—¥æœŸå·¥å…·ï¼šä»Šå¤©èˆ‡ã€Œä»Šå¤©å¾€å‰ä¸€å¹´ã€ =====
  function todayYMD(){
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function minusOneYearSameDay(ymd){
    const [y,m,d] = ymd.split('-').map(n=>parseInt(n,10));
    const dt = new Date(y, m-1, d);
    dt.setFullYear(dt.getFullYear()-1);
    const yy = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${yy}-${mm}-${dd}`;
  }
  function startOfDay(ymd){ const [y,m,d]=ymd.split('-').map(Number); return new Date(y,m-1,d,0,0,0,0); }
  function endOfDay(ymd){ const [y,m,d]=ymd.split('-').map(Number); return new Date(y,m-1,d,23,59,59,999); }

  // å°‡å„ç¨®æ ¼å¼çš„ time è½‰ Dateï¼›å¤±æ•—å› null
  function toDate(val){
    if (val == null) return null;
    if (Object.prototype.toString.call(val) === '[object Date]' && !isNaN(val)) return val;
    const s = String(val).trim();
    // å¸¸è¦‹ï¼šYYYY-MM-DD HH:mm:ss æˆ– YYYY/MM/DD HH:mm
    const s19 = s.slice(0,19);
    const norm = s19.replace(/\//g,'-').replace(' ', 'T');
    const d1 = new Date(norm);
    if (!isNaN(d1)) return d1;
    const d2 = new Date(s);
    return isNaN(d2) ? null : d2;
  }

  // å‰ç«¯å‚™æ´ç¯©é¸ï¼šåªä¿ç•™ [from, until]ï¼ˆå«ç«¯é»ï¼‰
  function filterByRange(rawArray, fromYMD, untilYMD){
    const from = startOfDay(fromYMD).getTime();
    const until = endOfDay(untilYMD).getTime();
    return (rawArray || []).filter(r=>{
      const t = toDate(r.time);
      if (!t) return false;
      const ts = t.getTime();
      return ts >= from && ts <= until;
    });
  }

  // âœ… è¼‰å…¥æ”å½±æ©Ÿæ¸…å–®
  async function initCameraOptions() {
    try {
      const devices = await Html5Qrcode.getCameras();
      const select = document.getElementById("cameraSelect");
      select.innerHTML = "";

      if (devices.length === 0) {
        alert("æ‰¾ä¸åˆ°æ”å½±æ©Ÿï¼");
        return;
      }

      devices.forEach((device, index) => {
        const option = document.createElement("option");
        option.value = device.id;
        option.text = device.label || `Camera ${index + 1}`;
        select.appendChild(option);
      });

      currentCameraId = select.value;
      select.addEventListener("change", async () => {
        currentCameraId = select.value;
        await restartScanner();
      });

      await startScanner();
    } catch (err) {
      alert("ç„¡æ³•å­˜å–æ”å½±æ©Ÿï¼š" + err.message);
    }
  }

  // âœ… å•Ÿå‹•æƒæå™¨
  async function startScanner() {
    if (!currentCameraId) return;

    await qrScanner.start(
      currentCameraId,
      {
        fps: 5,
        aspectRatio: 1.777,
        qrbox: { width: 250, height: 250 },
        videoConstraints: {
          width: { ideal: 640 },
          height: { ideal: 480 },
          facingMode: "environment"
        }
      },
      (qrCodeMessage) => {
        scannedCarId = qrCodeMessage.trim();
        document.getElementById("carIdDisplay").innerText = `ğŸšš å°è»Šç·¨è™Ÿï¼š${scannedCarId}`;
        qrScanner.stop().then(() => {
          displayResultFromCache(scannedCarId);
        });
      },
      (errorMessage) => {
        // å¯å¿½ç•¥
      }
    );
  }

  async function restartScanner() {
    if (qrScanner && qrScanner.isScanning) {
      await qrScanner.stop();
    }
    await startScanner();
  }

  // âœ… æ ¹æ“šå¿«å–è³‡æ–™é¡¯ç¤ºçµæœ
  function displayResultFromCache(carId) {
    const matches = allRecords
      .filter(r => r.carId === carId)
      .sort((a, b) => new Date(b.time) - new Date(a.time));
    const result = matches[0];
    const resultArea = document.getElementById("resultArea");

    if (!result) {
      resultArea.innerHTML = `<p class="error">âŒ æŸ¥ç„¡ ${carId} çš„é»æª¢è³‡æ–™ï¼ˆæˆ–ä¸åœ¨è¿‘ä¸€å¹´ç¯„åœå…§ï¼‰</p>`;
      document.getElementById("rescanBtn").style.display = "inline-block";
      return;
    }

    resultArea.innerHTML = `<div class="info">ğŸ“… é»æª¢æ™‚é–“ï¼š${result.time}</div>`;
    const fields = Object.entries(result).filter(([key]) => !['carId', 'time'].includes(key));

    for (const [key, val] of fields) {
      resultArea.innerHTML += `
        <div class="card">
          <div class="card-title">${key}</div>
          <div class="card-content">${val || "-"}</div>
        </div>
      `;
    }

    document.getElementById("rescanBtn").style.display = "inline-block";
  }

  // âœ… é»æ“Šé‡æ–°æƒæ
  document.getElementById("rescanBtn").addEventListener("click", async () => {
    document.getElementById("resultArea").innerHTML = "";
    document.getElementById("carIdDisplay").innerText = "ğŸ“· ç­‰å¾…é‡æ–°æƒæ QR Code...";
    document.getElementById("rescanBtn").style.display = "none";
    await restartScanner();
  });

  // âœ… é è¼‰è³‡æ–™ï¼ˆåªæŠ“ä»Šå¤©å¾€å‰ä¸€å¹´ï¼‰
  async function preloadDataAndInit() {
    const until = todayYMD();
    const from  = minusOneYearSameDay(until); // å«ç«¯é»ï¼šfrom 00:00:00 ~ until 23:59:59
    const overlay = document.getElementById("loadingOverlay");
    try {
      // 1) å˜—è©¦ç”±å¾Œç«¯åšå€é–“éæ¿¾ï¼ˆå»ºè­°æ—¥å¾Œæ”¯æ´ï¼‰
      const res = await fetch(`${GAS_URL}?mode=list&from=${encodeURIComponent(from)}&until=${encodeURIComponent(until)}`, { cache: "no-store" });
      if (!res.ok) throw new Error("GAS å›å‚³é 200ï¼š" + res.status);
      const data = await res.json();

      // 2) ä¿éšªï¼šè‹¥å¾Œç«¯æœªæ”¯æ´ from/untilï¼Œé€™è£¡ä»¥ time æ¬„ä½åšå‰ç«¯å€é–“éæ¿¾
      const raw = data.records || [];
      allRecords = filterByRange(raw, from, until);

      overlay.style.display = "none";
      await initCameraOptions();
    } catch (err) {
      // è‹¥æ•´å€‹è«‹æ±‚å¤±æ•—ï¼Œå†å˜—è©¦æŠ“èˆŠ APIï¼ˆç„¡ç¯„åœï¼‰ï¼Œç„¶å¾Œå‰ç«¯éæ¿¾
      overlay.textContent = "âš ï¸ å¾Œç«¯å€é–“è«‹æ±‚å¤±æ•—ï¼Œæ”¹ç”¨å‰ç«¯ç¯©é¸â€¦";
      try {
        const res2 = await fetch(`${GAS_URL}?mode=list`, { cache: "no-store" });
        if (!res2.ok) throw new Error("GAS å›å‚³é 200ï¼š" + res2.status);
        const data2 = await res2.json();
        const raw2 = data2.records || [];
        allRecords = filterByRange(raw2, from, until);
        overlay.style.display = "none";
        await initCameraOptions();
      } catch (err2) {
        overlay.textContent = "âŒ è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š" + err2.message;
      }
    }
  }

  preloadDataAndInit();
</script>
</body>
</html>
