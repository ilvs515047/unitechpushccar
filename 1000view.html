<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UTå°è»Šé»æª¢ç´€éŒ„æŸ¥è©¢ï¼ˆå¿«é€ŸæŸ¥é–±ï¼‰</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      background-color: #f7f7f7;
      padding: 20px;
      margin: 0;
    }
    h2 { text-align: center; color: #333; }
    #reader { width: 100%; max-width: 320px; margin: 0 auto 20px; }
    #cameraSelect {
      display: none; margin: 0 auto 10px; padding: 6px; font-size: 14px;
      width: 100%; max-width: 320px;
    }
    .status { text-align: center; font-weight: bold; margin-bottom: 10px; }
    .info { text-align: center; font-size: 15px; margin: 8px 0; color: #444; }
    .error { color: red; text-align: center; font-weight: bold; }
    .card {
      background-color: white; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 16px; margin-bottom: 16px;
    }
    .card-title { font-weight: bold; color: #555; margin-bottom: 6px; }
    .card-content { font-size: 15px; color: #222; word-wrap: break-word; }
    button {
      width: 100%; padding: 12px; background-color: #007bff; color: white;
      border: none; font-size: 16px; border-radius: 8px; cursor: pointer; margin-top: 12px;
    }
    button:hover { background-color: #0056b3; }
    #loadingOverlay {
      display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4); color: white; font-size: 20px;
      justify-content: center; align-items: center; z-index: 999;
      text-align:center; padding: 0 16px;
    }

    /* ====== å¾½ç« æ¨£å¼ ====== */
    .badge-wrap {
      display: flex;
      justify-content: center;
      margin: 12px 0 4px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 700;
      letter-spacing: .5px;
      user-select: none;
    }
    .badge svg { width: 18px; height: 18px; }

    .badge-green {
      color: #063b1f;
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 40%, #16a34a 100%);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.9) inset,
                  0 6px 18px rgba(34,197,94,0.35),
                  0 0 24px rgba(52,211,153,0.45);
      border: 1px solid rgba(6, 78, 59, 0.25);
      animation: pulseGlowGreen 1.6s infinite ease-in-out;
    }
    .badge-green svg { filter: drop-shadow(0 1px 0 rgba(255,255,255,0.4)); fill:#064e3b; }

    .badge-red {
      color: #7f1d1d;
      background: linear-gradient(135deg, #f87171 0%, #ef4444 40%, #dc2626 100%);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.9) inset,
                  0 6px 18px rgba(239,68,68,0.35),
                  0 0 24px rgba(239,68,68,0.45);
      border: 1px solid rgba(127,29,29,0.25);
      animation: pulseGlowRed 1.6s infinite ease-in-out;
    }
    .badge-red svg { filter: drop-shadow(0 1px 0 rgba(255,255,255,0.4)); fill:#7f1d1d; }

    @keyframes pulseGlowGreen {
      0% { transform:scale(1); box-shadow:0 0 0 2px rgba(255,255,255,0.9) inset,0 6px 18px rgba(34,197,94,0.35),0 0 24px rgba(52,211,153,0.45); }
      50% { transform:scale(1.03); box-shadow:0 0 0 2px rgba(255,255,255,0.9) inset,0 10px 26px rgba(34,197,94,0.50),0 0 36px rgba(52,211,153,0.65); }
      100%{ transform:scale(1); box-shadow:0 0 0 2px rgba(255,255,255,0.9) inset,0 6px 18px rgba(34,197,94,0.35),0 0 24px rgba(52,211,153,0.45); }
    }
    @keyframes pulseGlowRed {
      0% { transform:scale(1); box-shadow:0 0 0 2px rgba(255,255,255,0.9) inset,0 6px 18px rgba(239,68,68,0.35),0 0 24px rgba(239,68,68,0.45); }
      50% { transform:scale(1.03); box-shadow:0 0 0 2px rgba(255,255,255,0.9) inset,0 10px 26px rgba(239,68,68,0.50),0 0 36px rgba(239,68,68,0.65); }
      100%{ transform:scale(1); box-shadow:0 0 0 2px rgba(255,255,255,0.9) inset,0 6px 18px rgba(239,68,68,0.35),0 0 24px rgba(239,68,68,0.45); }
    }

    .date-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin: 8px 0 12px;
    }
  </style>
</head>
<body>

<h2>ğŸ“‹ UTç‡¿è¯å°è»Šé»æª¢ç´€éŒ„æŸ¥è©¢ï¼ˆæœ€ä¸‹æ–¹æŒ‰éˆ•å¯ä»¥å†æ¬¡æŸ¥è©¢ï¼Œä¸ç”¨é‡æ–°è¼‰è³‡æ–™ï¼‰</h2>
<select id="cameraSelect"></select>
<div id="reader"></div>
<p id="carIdDisplay" class="status">ğŸ“· ç­‰å¾…æƒæ QR Code...</p>
<div id="resultArea"></div>
<!-- ç§»é™¤åŸæœ¬å›ºå®šåœ¨åº•éƒ¨çš„æŒ‰éˆ•ï¼Œæ”¹ç‚ºå‹•æ…‹æ’å…¥ -->
<div id="loadingOverlay">ğŸ‘Œ è³‡æ–™åº«è¼‰å…¥ä¸­ï¼Œè«‹è€å¿ƒç­‰å¾…ç´„10ç§’ï¼Œæ„Ÿè¬ï¼ˆåªæŠ“ä»Šå¤©å¾€å‰ä¸€å¹´çš„è³‡æ–™ï¼‰â€¦</div>

<script>
  // ===== åŸºæœ¬è¨­å®š =====
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyqPEMYcuv3idN9icLCSgIrz7OiPbhVFDQwXcyW8j_Y1iK0FENbjEv-74CHsycONrznqA/exec";
  let allRecords = [];
  let scannedCarId = "";
  let currentCameraId = null;
  const qrScanner = new Html5Qrcode("reader");

  // ===== æ—¥æœŸå·¥å…·ï¼šä»Šå¤©èˆ‡ã€Œä»Šå¤©å¾€å‰ä¸€å¹´ã€ =====
  function todayYMD(){
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function minusOneYearSameDay(ymd){
    const [y,m,d] = ymd.split('-').map(n=>parseInt(n,10));
    const dt = new Date(y, m-1, d);
    dt.setFullYear(dt.getFullYear()-1);
    const yy = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${yy}-${mm}-${dd}`;
  }
  function startOfDay(ymd){ const [y,m,d]=ymd.split('-').map(Number); return new Date(y,m-1,d,0,0,0,0); }
  function endOfDay(ymd){ const [y,m,d]=ymd.split('-').map(Number); return new Date(y,m-1,d,23,59,59,999); }

  // å°‡å„ç¨®æ ¼å¼çš„ time è½‰ Dateï¼›å¤±æ•—å› null
  function toDate(val){
    if (val == null) return null;
    if (Object.prototype.toString.call(val) === '[object Date]' && !isNaN(val)) return val;
    const s = String(val).trim();
    const s19 = s.slice(0,19);
    const norm = s19.replace(/\//g,'-').replace(' ', 'T');
    const d1 = new Date(norm);
    if (!isNaN(d1)) return d1;
    const d2 = new Date(s);
    return isNaN(d2) ? null : d2;
  }

  // å‰ç«¯å‚™æ´ç¯©é¸ï¼šåªä¿ç•™ [from, until]ï¼ˆå«ç«¯é»ï¼‰
  function filterByRange(rawArray, fromYMD, untilYMD){
    const from = startOfDay(fromYMD).getTime();
    const until = endOfDay(untilYMD).getTime();
    return (rawArray || []).filter(r=>{
      const t = toDate(r.time);
      if (!t) return false;
      const ts = t.getTime();
      return ts >= from && ts <= until;
    });
  }

  // âœ… æ˜¯å¦åœ¨ã€Œä»Šå¤©å¾€å‰çš„ n å€‹æœˆã€å…§ï¼ˆå«ç«¯é»ï¼‰
  function isWithinLastNMonths(dateVal, n=6){
    const t = toDate(dateVal);
    if (!t) return false;
    const now = new Date();
    const from = new Date(now.getFullYear(), now.getMonth() - n, now.getDate(), 0,0,0,0).getTime();
    const ts = t.getTime();
    return ts >= from && ts <= now.getTime();
  }

  // âœ… è¼‰å…¥æ”å½±æ©Ÿæ¸…å–®
  async function initCameraOptions() {
    try {
      const devices = await Html5Qrcode.getCameras();
      const select = document.getElementById("cameraSelect");
      select.innerHTML = "";

      if (devices.length === 0) {
        alert("æ‰¾ä¸åˆ°æ”å½±æ©Ÿï¼");
        return;
      }

      devices.forEach((device, index) => {
        const option = document.createElement("option");
        option.value = device.id;
        option.text = device.label || `Camera ${index + 1}`;
        select.appendChild(option);
      });

      // è‹¥æœ‰å¤šé¡†é¡é ­æ‰é¡¯ç¤ºä¸‹æ‹‰
      select.style.display = devices.length > 1 ? "block" : "none";

      currentCameraId = select.value;
      select.addEventListener("change", async () => {
        currentCameraId = select.value;
        await restartScanner();
      });

      await startScanner();
    } catch (err) {
      alert("ç„¡æ³•å­˜å–æ”å½±æ©Ÿï¼š" + err.message);
    }
  }

  // âœ… å•Ÿå‹•æƒæå™¨
  async function startScanner() {
    if (!currentCameraId) return;

    await qrScanner.start(
      currentCameraId,
      {
        fps: 5,
        aspectRatio: 1.777,
        qrbox: { width: 250, height: 250 },
        videoConstraints: {
          width: { ideal: 640 },
          height: { ideal: 480 },
          facingMode: "environment"
        }
      },
      (qrCodeMessage) => {
        scannedCarId = qrCodeMessage.trim();
        document.getElementById("carIdDisplay").innerText = `ğŸšš å°è»Šç·¨è™Ÿï¼š${scannedCarId}`;
        qrScanner.stop().then(() => {
          displayResultFromCache(scannedCarId);
        }).catch(()=>{ /* å®‰å…¨å¿½ç•¥ */ });
      },
      (/* errorMessage */) => { /* å¯å¿½ç•¥é€£çºŒå¤±æ•— */ }
    );
  }

  async function restartScanner() {
    if (qrScanner && qrScanner.isScanning) {
      await qrScanner.stop();
    }
    await startScanner();
  }

  // âœ… æ ¹æ“šå¿«å–è³‡æ–™é¡¯ç¤ºçµæœï¼ˆæŠŠã€Œé‡æ–°æƒæã€æ”¾åˆ°æ—¥æœŸä¸Šæ–¹ï¼‰
  function displayResultFromCache(carId) {
    const matches = allRecords
      .filter(r => r.carId === carId)
      .sort((a, b) => new Date(b.time) - new Date(a.time));
    const result = matches[0];
    const resultArea = document.getElementById("resultArea");
    resultArea.innerHTML = "";

    // å…ˆæ’å…¥ã€Œé‡æ–°æƒæã€æŒ‰éˆ•ï¼ˆåœ¨æ—¥æœŸä¸Šæ–¹ï¼‰
    resultArea.innerHTML += `
      <div style="text-align:center; margin-bottom:12px;">
        <button id="rescanBtn">ğŸ”„ é‡æ–°æƒæ</button>
      </div>
    `;

    // è‹¥ç„¡è³‡æ–™ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼ˆæŒ‰éˆ•å·²åœ¨ä¸Šé¢ï¼‰
    if (!result) {
      resultArea.innerHTML += `<p class="error">âŒ æŸ¥ç„¡ ${carId} çš„é»æª¢è³‡æ–™ï¼ˆæˆ–ä¸åœ¨è¿‘ä¸€å¹´ç¯„åœå…§ï¼‰</p>`;
      // ç¶äº‹ä»¶
      document.getElementById("rescanBtn").addEventListener("click", async () => {
        resultArea.innerHTML = "";
        document.getElementById("carIdDisplay").innerText = "ğŸ“· ç­‰å¾…é‡æ–°æƒæ QR Code...";
        await restartScanner();
      });
      return;
    }

    const within6M = isWithinLastNMonths(result.time, 6);

    // å¾½ç« 
    const badgeHTML = within6M
      ? `
      <div class="badge-wrap">
        <div class="badge badge-green" title="å·²æª¢é©—ï¼ˆåŠå¹´å…§ï¼‰">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M9 16.2l-3.5-3.5a1 1 0 10-1.4 1.4l4.2 4.2a1 1 0 001.4 0l9-9a1 1 0 10-1.4-1.4L9 16.2z"></path>
          </svg>
          <span>å·²æª¢é©—</span>
        </div>
      </div>`
      : `
      <div class="badge-wrap">
        <div class="badge badge-red" title="åŠå¹´ä»¥ä¸Šæœªé»æª¢">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M6 6l12 12M6 18L18 6" stroke-width="2"></path>
          </svg>
          <span>åŠå¹´ä»¥ä¸Šæœªé»æª¢</span>
        </div>
      </div>`;

    // æ—¥æœŸåˆ—ï¼ˆæŒ‰éˆ•å·²åœ¨ä¸Šæ–¹ï¼‰
    resultArea.innerHTML += `
      <div class="date-row">
        ${badgeHTML}
        <div class="info">ğŸ“… é»æª¢æ™‚é–“ï¼š${result.time}</div>
      </div>
    `;

    // å…¶é¤˜æ¬„ä½
    const fields = Object.entries(result).filter(([key]) => !['carId', 'time'].includes(key));
    for (const [key, val] of fields) {
      resultArea.innerHTML += `
        <div class="card">
          <div class="card-title">${key}</div>
          <div class="card-content">${val ?? "-"}</div>
        </div>
      `;
    }

    // ç¶å®šã€Œé‡æ–°æƒæã€äº‹ä»¶
    document.getElementById("rescanBtn").addEventListener("click", async () => {
      resultArea.innerHTML = "";
      document.getElementById("carIdDisplay").innerText = "ğŸ“· ç­‰å¾…é‡æ–°æƒæ QR Code...";
      await restartScanner();
    });
  }

  // âœ… é è¼‰è³‡æ–™ï¼ˆåªæŠ“ä»Šå¤©å¾€å‰ä¸€å¹´ï¼‰
  async function preloadDataAndInit() {
    const until = todayYMD();
    const from  = minusOneYearSameDay(until);
    const overlay = document.getElementById("loadingOverlay");
    try {
      const res = await fetch(`${GAS_URL}?mode=list&from=${encodeURIComponent(from)}&until=${encodeURIComponent(until)}`, { cache: "no-store" });
      if (!res.ok) throw new Error("GAS å›å‚³é 200ï¼š" + res.status);
      const data = await res.json();

      const raw = data.records || [];
      allRecords = filterByRange(raw, from, until);

      overlay.style.display = "none";
      await initCameraOptions();
    } catch (err) {
      overlay.textContent = "âš ï¸ å¾Œç«¯å€é–“è«‹æ±‚å¤±æ•—ï¼Œæ”¹ç”¨å‰ç«¯ç¯©é¸â€¦";
      try {
        const res2 = await fetch(`${GAS_URL}?mode=list`, { cache: "no-store" });
        if (!res2.ok) throw new Error("GAS å›å‚³é 200ï¼š" + res2.status);
        const data2 = await res2.json();
        const raw2 = data2.records || [];
        allRecords = filterByRange(raw2, from, until);
        overlay.style.display = "none";
        await initCameraOptions();
      } catch (err2) {
        overlay.textContent = "âŒ è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š" + err2.message;
      }
    }
  }

  preloadDataAndInit();
</script>
</body>
</html>
