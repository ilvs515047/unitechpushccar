<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“‹ ç‡¿è¯å°è»Šé»æª¢ç´€éŒ„ç¸½è¦½</title>
  <style>
    :root { color-scheme: light; }
    body {
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      margin: 0; padding: 20px;
      background-color: #f5faff;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }
    #search {
      width: 100%;
      max-width: 300px;
      margin: 0 auto 16px;
      display: block;
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th { background-color: #ffdd99; }
    tr:nth-child(even) { background-color: #fdf6ea; }
    .container { overflow-x: auto; }

    input.note-input {
      width: 70%;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      outline: none;
      transition: 0.2s;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    input.note-input:focus {
      border-color: #66afe9;
      box-shadow: 0 0 5px rgba(102,175,233,0.6);
    }
    button.note-save {
      margin-left: 6px;
      padding: 6px 12px;
      background-color: #ffc107;
      color: #333;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    button.note-save:hover { background-color: #ff9800; }
    .save-status {
      display: inline-block;
      margin-left: 8px;
      font-size: 13px;
      color: #28a745;
      font-weight: bold;
      transition: opacity 0.3s;
    }

    .loading-popup {
      position: fixed; inset: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 20px; color: white; font-weight: bold;
    }
    .loading-box {
      background: #333;
      padding: 20px 40px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    /* ===== æˆæ¬Šé–€ï¼ˆå¯†ç¢¼è¼¸å…¥ï¼‰ ===== */
    #authOverlay {
      position: fixed; inset: 0; z-index: 10000;
      background: linear-gradient(160deg,#1f2937,#111827);
      display: flex; align-items: center; justify-content: center;
      color: #e5e7eb;
    }
    .auth-card {
      width: min(92vw, 420px);
      background: #111827;
      border: 1px solid #374151;
      border-radius: 16px;
      padding: 22px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .auth-title { font-size: 18px; margin: 0 0 12px; }
    .auth-hint { opacity:.85; font-size: 14px; margin-bottom: 12px; }
    .auth-row { display: flex; gap: 8px; }
    .auth-input {
      flex: 1; padding: 10px 12px; border-radius: 10px;
      background: #0b1220; color: #e5e7eb; border: 1px solid #334155;
      outline: none; font-size: 16px;
    }
    .auth-input:focus { border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(59,130,246,.25); }
    .auth-btn {
      padding: 10px 14px; border-radius: 10px; border: none; cursor: pointer;
      background: #60a5fa; color: #0b1220; font-weight: 700;
    }
    .auth-btn:hover { filter: brightness(1.05); }
    .auth-err { color: #fca5a5; font-size: 13px; min-height: 18px; margin-top: 8px; }
    .topbar {
      position: sticky; top: 0; display: flex; justify-content: flex-end; gap: 8px;
      margin: -8px 0 8px; padding: 8px 0;
    }
    .logout-btn {
      padding: 6px 10px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer;
    }
  </style>
</head>
<body>

<!-- ======= å¯†ç¢¼ä¿è­·é–€ ======= -->
<div id="authOverlay" aria-modal="true" role="dialog">
  <div class="auth-card">
    <h3 class="auth-title">ğŸ” éœ€è¦å¯†ç¢¼</h3>
    <p class="auth-hint">è«‹è¼¸å…¥å­˜æ”¾åœ¨æ­¤ HTML çš„å¯†ç¢¼å¾Œé€²å…¥ç³»çµ±ã€‚</p>
    <div class="auth-row">
      <input id="authInput" class="auth-input" type="password" placeholder="è¼¸å…¥å¯†ç¢¼" autocomplete="current-password" />
      <button id="authBtn" class="auth-btn">ç™»å…¥</button>
    </div>
    <div id="authErr" class="auth-err"></div>
  </div>
</div>

<!-- ======= ä¸»è¦å…§å®¹ï¼ˆé è¨­éš±è—ï¼‰ ======= -->
<div id="app" style="display:none;">
  <div class="topbar">
    <button id="logoutBtn" class="logout-btn">ğŸšª ç™»å‡º</button>
  </div>

  <h2>ğŸ“‹ ç‡¿è¯é›»å­å°è»Šé»æª¢ç´€éŒ„ç¸½è¦½</h2>
  <input type="text" id="search" placeholder="ğŸ” æœå°‹å°è»Šç·¨è™Ÿã€å·¥è™Ÿã€å…§å®¹â€¦">

  <div class="container">
    <table id="recordTable">
      <thead><tr id="tableHead"></tr></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div id="loading" class="loading-popup">
    <div class="loading-box" id="loading-text">â³ è¼‰å…¥ä¸­â€¦</div>
  </div>
</div>

<script>
  // ========================
  // 1) åŸºæœ¬å¯†ç¢¼è¨­å®šï¼ˆæ˜ç¢¼ï¼‰
  // ========================
  // âš ï¸ æ³¨æ„ï¼šé€™æ˜¯å‰ç«¯ä¿è­·ï¼Œå¯†ç¢¼æœƒè¢«çœ‹åˆ°ï¼Œåƒ…é©åˆè‡¨æ™‚/å…§ç¶²ä½¿ç”¨ã€‚
  // ç›´æ¥ä¿®æ”¹ä¸‹æ–¹å¯†ç¢¼å³å¯ï¼š
  const PLAINTEXT_PASSWORD = "123456"; // â†â†â† æ”¹æˆä½ è¦çš„å¯†ç¢¼

  // æ˜¯å¦è¨˜ä½ç™»å…¥ï¼ˆä»¥å°æ™‚è¨ˆï¼‰
  const REMEMBER_HOURS = 8; // 8 å°æ™‚å…§å…å†æ¬¡è¼¸å…¥
  const AUTH_KEY = "ut_cart_admin_authed";

  function setAuthed(hours) {
    const expAt = Date.now() + hours * 3600 * 1000;
    localStorage.setItem(AUTH_KEY, String(expAt));
  }
  function isAuthed() {
    const v = Number(localStorage.getItem(AUTH_KEY) || 0);
    return v > Date.now();
  }
  function logout() {
    localStorage.removeItem(AUTH_KEY);
    document.getElementById('app').style.display = 'none';
    document.getElementById('authOverlay').style.display = 'flex';
    document.getElementById('authInput').value = '';
    document.getElementById('authInput').focus();
  }

  // æˆæ¬Šæµç¨‹
  const $overlay = document.getElementById('authOverlay');
  const $app = document.getElementById('app');
  const $input = document.getElementById('authInput');
  const $btn = document.getElementById('authBtn');
  const $err = document.getElementById('authErr');
  const $logout = document.getElementById('logoutBtn');

  function unlockIfAuthed() {
    if (isAuthed()) {
      $overlay.style.display = 'none';
      $app.style.display = '';
    }
  }

  function tryLogin() {
    const pw = ($input.value || '').trim();
    if (!pw) {
      $err.textContent = 'è«‹å…ˆè¼¸å…¥å¯†ç¢¼';
      return;
    }
    if (pw === PLAINTEXT_PASSWORD) {
      setAuthed(REMEMBER_HOURS);
      $overlay.style.display = 'none';
      $app.style.display = '';
      $err.textContent = '';
    } else {
      $err.textContent = 'å¯†ç¢¼éŒ¯èª¤';
    }
  }

  $btn.addEventListener('click', tryLogin);
  $input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') tryLogin();
  });
  $logout.addEventListener('click', logout);

  // åˆæ¬¡å•Ÿå‹•
  unlockIfAuthed();
  if ($overlay.style.display !== 'none') $input.focus();

  // ========================
  // 2) ä½ çš„åŸæœ¬æ¥­å‹™ç¨‹å¼ç¢¼
  // ========================
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxBYOrRPbzVUeiZmJHvL17tPHt_lcyvr3R84Op-fY00Owq1ysr1sl-LFBvT-BfL_biTsQ/exec?mode=list";
  const GAS_URL_SAVE = "https://script.google.com/macros/s/AKfycbxBYOrRPbzVUeiZmJHvL17tPHt_lcyvr3R84Op-fY00Owq1ysr1sl-LFBvT-BfL_biTsQ/exec";

  const loading = document.getElementById("loading");
  const loadingText = document.getElementById("loading-text");
  const hiddenColumnIndexes = [2, 3]; // ç¬¬ 3 èˆ‡ç¬¬ 4 æ¬„éš±è—ï¼ˆå¾ 0 èµ·ç®—ï¼‰

  function showLoading(msg) {
    loadingText.textContent = msg || "â³ è¼‰å…¥ä¸­â€¦";
    loading.style.display = "flex";
  }
  function hideLoading() { loading.style.display = "none"; }

  // åƒ…åœ¨ç™»å…¥å¾Œæ‰æŠ“è³‡æ–™
  async function initAppAfterAuth() {
    if (!isAuthed()) return; // ä¿éšª
    showLoading("â³ æ­·å²æ•¸æ“šè³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹è€å¿ƒç­‰å€™ï¼Œæ„Ÿæ©â€¦");
    try {
      const res = await fetch(GAS_URL);
      const data = await res.json();
      const head = document.getElementById("tableHead");
      const body = document.getElementById("tableBody");

      // è¡¨é ­
      data.headers.forEach((h, i) => {
        if (hiddenColumnIndexes.includes(i)) return;
        const th = document.createElement("th");
        th.textContent = h;
        head.appendChild(th);
      });
      const thNote = document.createElement("th");
      thNote.textContent = "æ–°å¢å‚™è¨»";
      head.appendChild(thNote);

      // å…§å®¹åˆ—
      data.records.forEach(row => {
        const tr = document.createElement("tr");
        row.forEach((cell, i) => {
          if (hiddenColumnIndexes.includes(i)) return;
          const td = document.createElement("td");
          td.textContent = cell || "-";
          tr.appendChild(td);
        });

        const tdNote = document.createElement("td");
        const input = document.createElement("input");
        input.type = "text";
        input.className = "note-input";
        input.placeholder = "è¼¸å…¥å‚™è¨»";

        const btn = document.createElement("button");
        btn.textContent = "å„²å­˜";
        btn.className = "note-save";

        const status = document.createElement("span");
        status.className = "save-status";
        status.textContent = "";

        btn.onclick = async () => {
          const timestamp = row[0];
          const carId = row[1];
          const note = input.value;
          if (!note.trim()) {
            status.textContent = "è«‹è¼¸å…¥å‚™è¨»";
            status.style.color = "#dc3545";
            return;
          }
          showLoading("â³ å‚™è¨»å„²å­˜ä¸­ï¼Œè«‹ç¨å€™â€¦");
          try {
            const res = await fetch(GAS_URL_SAVE, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: `mode=note&carId=${encodeURIComponent(carId)}&timestamp=${encodeURIComponent(timestamp)}&note=${encodeURIComponent(note)}`
            });
            await res.text();
            hideLoading();
            status.textContent = "âœ… å·²å„²å­˜ï¼";
            status.style.color = "#28a745";

            const allTds = tr.querySelectorAll("td");
            const noteCell = allTds[allTds.length - 2];
            noteCell.textContent = note;
            input.value = "";
            setTimeout(() => status.textContent = "", 3000);
          } catch (err) {
            hideLoading();
            status.textContent = "âŒ å„²å­˜å¤±æ•—";
            status.style.color = "#dc3545";
          }
        };

        tdNote.appendChild(input);
        tdNote.appendChild(btn);
        tdNote.appendChild(status);
        tr.appendChild(tdNote);
        body.appendChild(tr);
      });

      hideLoading();

      // æœå°‹
      document.getElementById("search").addEventListener("input", e => {
        const keyword = e.target.value.trim().toLowerCase();
        Array.from(document.getElementById("tableBody").rows).forEach(row => {
          const match = Array.from(row.cells).some(cell =>
            cell.textContent.toLowerCase().includes(keyword)
          );
          row.style.display = match ? "" : "none";
        });
      });
    } catch (err) {
      hideLoading();
      alert("âŒ ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼š" + err.message);
    }
  }

  // åœ¨é¡¯ç¤ºä¸»è¦å…§å®¹å¾Œåˆå§‹åŒ–è³‡æ–™ï¼ˆé¿å…æœªæˆæ¬Šä¹Ÿæ‰“ GASï¼‰
  if (isAuthed()) initAppAfterAuth();
  // è‹¥ä½¿ç”¨è€…å‰›ç™»å…¥æˆåŠŸï¼Œè¦†å¯« tryLogin æ™‚æœƒé¡¯ç¤º appï¼Œå†å‘¼å«æ­¤åˆå§‹åŒ–
  const _origTryLogin = tryLogin;
  tryLogin = function() {
    _origTryLogin();
    if (isAuthed()) initAppAfterAuth();
  }
</script>

</body>
</html>
