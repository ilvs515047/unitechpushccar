<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>手機翻轉觀看 3D 方塊</title>
  <style>
    html, body { height: 100%; margin: 0; background: #fff; color: #111; }
    #app { position: fixed; inset: 0; }
    #overlay { position: fixed; inset: 0; display: none; place-items: center; background: rgba(255,255,255,.96); z-index: 20; }
    #overlay button { font-size: 18px; padding: 12px 18px; border-radius: 14px; border: 1px solid #d0d0d0; background: #fff; box-shadow: 0 8px 30px rgba(0,0,0,.08); }
    #hud { position: fixed; left: 10px; bottom: 10px; font-size: 12px; background: rgba(0,0,0,.04); border: 1px solid rgba(0,0,0,.08); border-radius: 8px; padding: 8px 10px; z-index: 15; }
    #modeBtn { position: fixed; right: 10px; top: 10px; z-index: 15; font-size: 13px; padding: 8px 10px; border-radius: 999px; border: 1px solid #d0d0d0; background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,.08); }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="overlay"><button id="permit">啟用感應器（iOS 需授權）</button></div>
  <button id="modeBtn" title="切換感應器/手勢">切換模式</button>
  <div id="hud">提示：在手機上翻轉/側傾，即可改變視角。桌機可用滑鼠拖曳旋轉、滾輪縮放。</div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.159.0/build/three.module.js';
    import { DeviceOrientationControls } from 'https://unpkg.com/three@0.159.0/examples/jsm/controls/DeviceOrientationControls.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js';

    // ======== 基本場景 ========
    const app = document.getElementById('app');
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0xffffff, 1); // 白底
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    app.appendChild(renderer.domElement);

    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.set(0, 0.6, 2.0);
    scene.add(camera);

    // 光源
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const dir1 = new THREE.DirectionalLight(0xffffff, 0.9);
    dir1.position.set(2, 2, 3);
    scene.add(dir1);

    // ======== 建立一個基本立方體 ========
    const geometry = new THREE.BoxGeometry(1, 1, 1);
    const material = new THREE.MeshStandardMaterial({ color: 0x0077ff });
    const cube = new THREE.Mesh(geometry, material);
    scene.add(cube);

    // ======== 控制器：感應器 & 手勢 ========
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const overlay = document.getElementById('overlay');
    const permitBtn = document.getElementById('permit');
    const modeBtn = document.getElementById('modeBtn');

    let currentMode = 'gyro'; // 'gyro' 或 'orbit'
    let gyroControls = null;
    let orbit = null;

    function useOrbit() {
      currentMode = 'orbit';
      gyroControls?.disconnect?.();
      gyroControls = null;
      if (!orbit) {
        orbit = new OrbitControls(camera, renderer.domElement);
        orbit.enableDamping = true;
        orbit.enablePan = false;
        orbit.target.set(0, 0, 0);
      }
      modeBtn.textContent = '切換為感應器';
    }

    function useGyro() {
      currentMode = 'gyro';
      orbit?.dispose?.();
      orbit = null;
      gyroControls = new DeviceOrientationControls(camera);
      gyroControls.connect();
      modeBtn.textContent = '切換為手勢';
    }

    async function initControls() {
      if (!isMobile) { useOrbit(); return; }
      if (typeof DeviceOrientationEvent === 'undefined') { useOrbit(); return; }

      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        overlay.style.display = 'grid';
        permitBtn.onclick = async () => {
          try {
            const state = await DeviceOrientationEvent.requestPermission();
            overlay.style.display = 'none';
            if (state === 'granted') { useGyro(); } else { useOrbit(); }
          } catch (e) {
            console.warn(e);
            overlay.style.display = 'none';
            useOrbit();
          }
        };
      } else {
        useGyro();
      }
    }

    initControls();

    modeBtn.addEventListener('click', () => {
      if (currentMode === 'gyro') useOrbit(); else useGyro();
    });

    // ======== 迴圈 & 自適應 ========
    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }
    window.addEventListener('resize', onResize);

    renderer.setAnimationLoop(() => {
      if (gyroControls && currentMode === 'gyro') gyroControls.update();
      if (orbit && currentMode === 'orbit') orbit.update();
      renderer.render(scene, camera);
    });
  </script>
</body>
</html>
